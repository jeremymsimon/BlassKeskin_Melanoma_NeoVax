[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Blass & Keskin (2025): Melanoma NeoVax analysis: Tumor single-cell RNAseq",
    "section": "",
    "text": "Introduction\nThis is a book that contains all code to reproduce figures related to scRNAseq analysis of Tumor data associated with Blass & Keskin, et al (2025)\nNote that while the code is identical, this book was rendered after final manuscript figures were generated and thus minor differences may arise, particularly for steps that are non-deterministic or rely on random number generators.",
    "crumbs": [
      "Introduction"
    ]
  },
  {
    "objectID": "index.html#enhanced-adjuvanticity-of-a-personal-neoantigen-vaccine-generates-potent-immunity-in-melanoma",
    "href": "index.html#enhanced-adjuvanticity-of-a-personal-neoantigen-vaccine-generates-potent-immunity-in-melanoma",
    "title": "Blass & Keskin (2025): Melanoma NeoVax analysis: Tumor single-cell RNAseq",
    "section": "Enhanced adjuvanticity of a personal neoantigen vaccine generates potent immunity in melanoma",
    "text": "Enhanced adjuvanticity of a personal neoantigen vaccine generates potent immunity in melanoma\nEryn Blass, Derin B. Keskin, Chloe R. Tu, Cleo Forman, Allison Vanasse, Haley E. Sax, Bohoon Shim, Vipheaviny Chea, Nawoo Kim, Isabel Carulli, Jackson Southard, Haoxiang Lyu, Wesley Lu, Micah Rickles-Young, Alexander B. Afeyan, Oriol Olive, Ambica Mehndiratta, Haley Greenslade, Keerthi Shetty, Joanna Baginska, Ilana Gomez-Diaz, Allison Nau, Kathleen L. Pfaff, Andrew Gans, Elizabeth I Buchbinder, Tamara A. Sussman, Megan L Insco, Charles H. Yoon, Scott J. Rodig, Sachet A. Shukla, Shuqiang Li, Jon C. Aster, David A. Braun, Carrie Cibulskis, Nir Hacohen, Donna S. Neuberg, A Giobbie-Hurder, Kenneth J. Livak, Edward F. Fritsch, Giacomo Oliveira, Jeremy M. Simon, Catherine J. Wu, Patrick A. Ott\n\nAbstract\nPersonalized neoantigen-targeting vaccines have great promise, but current delivery strategies are suboptimal. Since antigen availability and effective T cell priming are critical for maximal immunogenicity, we tested a synthetic long peptide vaccine formulated with Montanide, poly-ICLC, and locally administered ipilimumab in addition to systemic nivolumab in 10 patients with melanoma. These personalized vaccines generated de novo ex vivo T cell responses against the majority of immunizing neoepitopes in all 9 fully vaccinated patients, and ex vivo CD8+ T cell responses in 6 of 9. Vaccination induced hundreds of circulating and intratumoral T cell receptor (TCR) clonotypes that were distinct from those arising after PD-1 inhibition. By linking the vaccine neoantigen specificity of T cell clonotypes with single cell phenotypes in tumors, we demonstrate remodeling of the intratumoral T cell repertoire following vaccination. These observations show that multi-pronged immune adjuvanticity can boost T cell responses to neoantigen-targeting vaccines",
    "crumbs": [
      "Introduction"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part1.html",
    "href": "Tumor_scRNA_Part1.html",
    "title": "1  Tumor: QC & Filtering",
    "section": "",
    "text": "1.1 Set up Seurat workspace\n# Load libraries\nlibrary(data.table)\nlibrary(devtools)\nlibrary(presto)\nlibrary(glmGamPoi)\nlibrary(sctransform)\nlibrary(Seurat)\nlibrary(tidyverse)\nlibrary(miQC)   \nlibrary(SeuratWrappers) \nlibrary(flexmix)\nlibrary(SingleCellExperiment)\nlibrary(SummarizedExperiment)\nlibrary(readxl)\nlibrary(fishpond)\nlibrary(Matrix)\nlibrary(speckle)\nlibrary(scater)\nlibrary(patchwork)\nlibrary(vctrs)\nlibrary(alevinQC)\nlibrary(harmony)\nlibrary(scDblFinder)\nlibrary(cellXY)\n\n# Set global options for Seurat v5 objects\noptions(Seurat.object.assay.version = 'v5')",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Tumor: QC & Filtering</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part1.html#load-alevin-fry-output",
    "href": "Tumor_scRNA_Part1.html#load-alevin-fry-output",
    "title": "1  Tumor: QC & Filtering",
    "section": "1.2 Load alevin-fry output",
    "text": "1.2 Load alevin-fry output\nNote using U+S+A counts via snRNA\n\nP101_Tumor_W00_2.5mgIpi_RNA &lt;- loadFry(fryDir = \"/jsimonlab/projects/Wu/Melanoma_scRNA_Eryn/alevinfry_072023/P101_Tumor_W00_2.5mgIpi_RNA_alevin_quant_crlikeem/\", outputFormat = \"snRNA\")\n\nlocating quant file\n\n\nReading meta data\n\n\nUSA mode: TRUE\n\n\nProcessing 62703 genes and 81170 barcodes\n\n\nUsing pre-defined output format: snrna\n\n\nBuilding the 'counts' assay, which contains U S A\n\n\nConstructing output SingleCellExperiment object\n\n\nDone\n\nP101_Tumor_W12_2.5mgIpi_RNA &lt;- loadFry(fryDir = \"/jsimonlab/projects/Wu/Melanoma_scRNA_Eryn/alevinfry_072023/P101_Tumor_W12_2.5mgIpi_RNA_alevin_quant_crlikeem/\", outputFormat = \"snRNA\")\n\nlocating quant file\n\n\nReading meta data\n\n\nUSA mode: TRUE\n\n\nProcessing 62703 genes and 67609 barcodes\n\n\nUsing pre-defined output format: snrna\n\n\nBuilding the 'counts' assay, which contains U S A\n\n\nConstructing output SingleCellExperiment object\n\n\nDone\n\nP101_Tumor_W20_2.5mgIpi_RNA &lt;- loadFry(fryDir = \"/jsimonlab/projects/Wu/Melanoma_scRNA_Eryn/alevinfry_072023/P101_Tumor_W20_2.5mgIpi_RNA_alevin_quant_crlikeem/\", outputFormat = \"snRNA\")\n\nlocating quant file\n\n\nReading meta data\n\n\nUSA mode: TRUE\n\n\nProcessing 62703 genes and 78263 barcodes\n\n\nUsing pre-defined output format: snrna\n\n\nBuilding the 'counts' assay, which contains U S A\n\n\nConstructing output SingleCellExperiment object\n\n\nDone\n\nP103_Tumor_W00_2.5mgIpi_RNA &lt;- loadFry(fryDir = \"/jsimonlab/projects/Wu/Melanoma_scRNA_Eryn/alevinfry_072023/P103_Tumor_W00_2.5mgIpi_RNA_alevin_quant_crlikeem/\", outputFormat = \"snRNA\")\n\nlocating quant file\n\n\nReading meta data\n\n\nUSA mode: TRUE\n\n\nProcessing 62703 genes and 75211 barcodes\n\n\nUsing pre-defined output format: snrna\n\n\nBuilding the 'counts' assay, which contains U S A\n\n\nConstructing output SingleCellExperiment object\n\n\nDone\n\nP103_Tumor_W12_2.5mgIpi_RNA &lt;- loadFry(fryDir = \"/jsimonlab/projects/Wu/Melanoma_scRNA_Eryn/alevinfry_072023/P103_Tumor_W12_2.5mgIpi_RNA_alevin_quant_crlikeem/\", outputFormat = \"snRNA\")\n\nlocating quant file\n\n\nReading meta data\n\n\nUSA mode: TRUE\n\n\nProcessing 62703 genes and 66437 barcodes\n\n\nUsing pre-defined output format: snrna\n\n\nBuilding the 'counts' assay, which contains U S A\n\n\nConstructing output SingleCellExperiment object\n\n\nDone\n\nP103_Tumor_W20_2.5mgIpi_RNA &lt;- loadFry(fryDir = \"/jsimonlab/projects/Wu/Melanoma_scRNA_Eryn/alevinfry_072023/P103_Tumor_W20_2.5mgIpi_RNA_alevin_quant_crlikeem/\", outputFormat = \"snRNA\")\n\nlocating quant file\n\n\nReading meta data\n\n\nUSA mode: TRUE\n\n\nProcessing 62703 genes and 69562 barcodes\n\n\nUsing pre-defined output format: snrna\n\n\nBuilding the 'counts' assay, which contains U S A\n\n\nConstructing output SingleCellExperiment object\n\n\nDone\n\nP104_Tumor_PD_2.5mgIpi_RNA &lt;- loadFry(fryDir = \"/jsimonlab/projects/Wu/Melanoma_scRNA_Eryn/alevinfry_072023/P104_Tumor_PD_2.5mgIpi_RNA_alevin_quant_crlikeem/\", outputFormat = \"snRNA\")\n\nlocating quant file\n\n\nReading meta data\n\n\nUSA mode: TRUE\n\n\nProcessing 62703 genes and 52796 barcodes\n\n\nUsing pre-defined output format: snrna\n\n\nBuilding the 'counts' assay, which contains U S A\n\n\nConstructing output SingleCellExperiment object\n\n\nDone\n\nP108_Tumor_PD_5mgIpi_RNA &lt;- loadFry(fryDir = \"/jsimonlab/projects/Wu/Melanoma_scRNA_Eryn/alevinfry_072023/P108_Tumor_PD_5mgIpi_RNA_alevin_quant_crlikeem/\", outputFormat = \"snRNA\")\n\nlocating quant file\n\n\nReading meta data\n\n\nUSA mode: TRUE\n\n\nProcessing 62703 genes and 70136 barcodes\n\n\nUsing pre-defined output format: snrna\n\n\nBuilding the 'counts' assay, which contains U S A\n\n\nConstructing output SingleCellExperiment object\n\n\nDone",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Tumor: QC & Filtering</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part1.html#convert-gene-ids-to-gene-symbols-collapse-transcripts-to-gene-symbols",
    "href": "Tumor_scRNA_Part1.html#convert-gene-ids-to-gene-symbols-collapse-transcripts-to-gene-symbols",
    "title": "1  Tumor: QC & Filtering",
    "section": "1.3 Convert gene IDs to gene symbols, collapse transcripts to gene symbols",
    "text": "1.3 Convert gene IDs to gene symbols, collapse transcripts to gene symbols\n\ntx2gene &lt;- read.table(\"/jsimonlab/genomes/hg38/gencode.v43.annotation_splici/gene_id_to_name.tsv\",header=F,sep=\"\\t\",col.names=c(\"tx\",\"gene\"))\n\n# Use rownames of first object to apply to all\nexp.txId &lt;- rownames(P101_Tumor_W00_2.5mgIpi_RNA)\nexp.geneId &lt;- as.vector(tx2gene$gene[match(exp.txId, tx2gene$tx)])\nexp.tx.grp &lt;- t(sparse.model.matrix(~ 0 + exp.geneId))\n\nP101_Tumor_W00_2.5mgIpi_RNA.summarized &lt;- exp.tx.grp %*% counts(P101_Tumor_W00_2.5mgIpi_RNA)\nrownames(P101_Tumor_W00_2.5mgIpi_RNA.summarized) &lt;- rownames(P101_Tumor_W00_2.5mgIpi_RNA.summarized) %&gt;% str_replace_all(\".+.geneId\",\"\")\n\nP101_Tumor_W12_2.5mgIpi_RNA.summarized &lt;- exp.tx.grp %*% counts(P101_Tumor_W12_2.5mgIpi_RNA)\nrownames(P101_Tumor_W12_2.5mgIpi_RNA.summarized) &lt;- rownames(P101_Tumor_W12_2.5mgIpi_RNA.summarized) %&gt;% str_replace_all(\".+.geneId\",\"\")\n\nP101_Tumor_W20_2.5mgIpi_RNA.summarized &lt;- exp.tx.grp %*% counts(P101_Tumor_W20_2.5mgIpi_RNA)\nrownames(P101_Tumor_W20_2.5mgIpi_RNA.summarized) &lt;- rownames(P101_Tumor_W20_2.5mgIpi_RNA.summarized) %&gt;% str_replace_all(\".+.geneId\",\"\")\n\nP103_Tumor_W00_2.5mgIpi_RNA.summarized &lt;- exp.tx.grp %*% counts(P103_Tumor_W00_2.5mgIpi_RNA)\nrownames(P103_Tumor_W00_2.5mgIpi_RNA.summarized) &lt;- rownames(P103_Tumor_W00_2.5mgIpi_RNA.summarized) %&gt;% str_replace_all(\".+.geneId\",\"\")\n\nP103_Tumor_W12_2.5mgIpi_RNA.summarized &lt;- exp.tx.grp %*% counts(P103_Tumor_W12_2.5mgIpi_RNA)\nrownames(P103_Tumor_W12_2.5mgIpi_RNA.summarized) &lt;- rownames(P103_Tumor_W12_2.5mgIpi_RNA.summarized) %&gt;% str_replace_all(\".+.geneId\",\"\")\n\nP103_Tumor_W20_2.5mgIpi_RNA.summarized &lt;- exp.tx.grp %*% counts(P103_Tumor_W20_2.5mgIpi_RNA)\nrownames(P103_Tumor_W20_2.5mgIpi_RNA.summarized) &lt;- rownames(P103_Tumor_W20_2.5mgIpi_RNA.summarized) %&gt;% str_replace_all(\".+.geneId\",\"\")\n\nP104_Tumor_PD_2.5mgIpi_RNA.summarized &lt;- exp.tx.grp %*% counts(P104_Tumor_PD_2.5mgIpi_RNA)\nrownames(P104_Tumor_PD_2.5mgIpi_RNA.summarized) &lt;- rownames(P104_Tumor_PD_2.5mgIpi_RNA.summarized) %&gt;% str_replace_all(\".+.geneId\",\"\")\n\nP108_Tumor_PD_5mgIpi_RNA.summarized &lt;- exp.tx.grp %*% counts(P108_Tumor_PD_5mgIpi_RNA)\nrownames(P108_Tumor_PD_5mgIpi_RNA.summarized) &lt;- rownames(P108_Tumor_PD_5mgIpi_RNA.summarized) %&gt;% str_replace_all(\".+.geneId\",\"\")",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Tumor: QC & Filtering</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part1.html#create-seurat-objects",
    "href": "Tumor_scRNA_Part1.html#create-seurat-objects",
    "title": "1  Tumor: QC & Filtering",
    "section": "1.4 Create Seurat objects",
    "text": "1.4 Create Seurat objects\n\nP101_Tumor_W00_2.5mgIpi_RNA.seurat &lt;- CreateSeuratObject(P101_Tumor_W00_2.5mgIpi_RNA.summarized)\n\nWarning: Feature names cannot have underscores ('_'), replacing with dashes\n('-')\n\nP101_Tumor_W12_2.5mgIpi_RNA.seurat &lt;- CreateSeuratObject(P101_Tumor_W12_2.5mgIpi_RNA.summarized)\n\nWarning: Feature names cannot have underscores ('_'), replacing with dashes\n('-')\n\nP101_Tumor_W20_2.5mgIpi_RNA.seurat &lt;- CreateSeuratObject(P101_Tumor_W20_2.5mgIpi_RNA.summarized)\n\nWarning: Feature names cannot have underscores ('_'), replacing with dashes\n('-')\n\nP103_Tumor_W00_2.5mgIpi_RNA.seurat &lt;- CreateSeuratObject(P103_Tumor_W00_2.5mgIpi_RNA.summarized)\n\nWarning: Feature names cannot have underscores ('_'), replacing with dashes\n('-')\n\nP103_Tumor_W12_2.5mgIpi_RNA.seurat &lt;- CreateSeuratObject(P103_Tumor_W12_2.5mgIpi_RNA.summarized)\n\nWarning: Feature names cannot have underscores ('_'), replacing with dashes\n('-')\n\nP103_Tumor_W20_2.5mgIpi_RNA.seurat &lt;- CreateSeuratObject(P103_Tumor_W20_2.5mgIpi_RNA.summarized)\n\nWarning: Feature names cannot have underscores ('_'), replacing with dashes\n('-')\n\nP104_Tumor_PD_2.5mgIpi_RNA.seurat &lt;- CreateSeuratObject(P104_Tumor_PD_2.5mgIpi_RNA.summarized)\n\nWarning: Feature names cannot have underscores ('_'), replacing with dashes\n('-')\n\nP108_Tumor_PD_5mgIpi_RNA.seurat &lt;- CreateSeuratObject(P108_Tumor_PD_5mgIpi_RNA.summarized)\n\nWarning: Feature names cannot have underscores ('_'), replacing with dashes\n('-')",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Tumor: QC & Filtering</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part1.html#add-sample-name-prefix-to-cbs",
    "href": "Tumor_scRNA_Part1.html#add-sample-name-prefix-to-cbs",
    "title": "1  Tumor: QC & Filtering",
    "section": "1.5 Add sample name prefix to CBs",
    "text": "1.5 Add sample name prefix to CBs\n\nP101_Tumor_W00_2.5mgIpi_RNA.seurat &lt;- RenameCells(P101_Tumor_W00_2.5mgIpi_RNA.seurat,add.cell.id = \"P101_Tumor_W00_2.5mgIpi_RNA\")\nP101_Tumor_W12_2.5mgIpi_RNA.seurat &lt;- RenameCells(P101_Tumor_W12_2.5mgIpi_RNA.seurat,add.cell.id = \"P101_Tumor_W12_2.5mgIpi_RNA\")\nP101_Tumor_W20_2.5mgIpi_RNA.seurat &lt;- RenameCells(P101_Tumor_W20_2.5mgIpi_RNA.seurat,add.cell.id = \"P101_Tumor_W20_2.5mgIpi_RNA\")\nP103_Tumor_W00_2.5mgIpi_RNA.seurat &lt;- RenameCells(P103_Tumor_W00_2.5mgIpi_RNA.seurat,add.cell.id = \"P103_Tumor_W00_2.5mgIpi_RNA\")\nP103_Tumor_W12_2.5mgIpi_RNA.seurat &lt;- RenameCells(P103_Tumor_W12_2.5mgIpi_RNA.seurat,add.cell.id = \"P103_Tumor_W12_2.5mgIpi_RNA\")\nP103_Tumor_W20_2.5mgIpi_RNA.seurat &lt;- RenameCells(P103_Tumor_W20_2.5mgIpi_RNA.seurat,add.cell.id = \"P103_Tumor_W20_2.5mgIpi_RNA\")\nP104_Tumor_PD_2.5mgIpi_RNA.seurat &lt;- RenameCells(P104_Tumor_PD_2.5mgIpi_RNA.seurat,add.cell.id = \"P104_Tumor_PD_2.5mgIpi_RNA\")\nP108_Tumor_PD_5mgIpi_RNA.seurat &lt;- RenameCells(P108_Tumor_PD_5mgIpi_RNA.seurat,add.cell.id = \"P108_Tumor_PD_5mgIpi_RNA\")",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Tumor: QC & Filtering</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part1.html#merge-objects",
    "href": "Tumor_scRNA_Part1.html#merge-objects",
    "title": "1  Tumor: QC & Filtering",
    "section": "1.6 Merge objects",
    "text": "1.6 Merge objects\n\nmerged.18279.tumor &lt;- merge(x = P101_Tumor_W00_2.5mgIpi_RNA.seurat, y=c(P101_Tumor_W12_2.5mgIpi_RNA.seurat, P101_Tumor_W20_2.5mgIpi_RNA.seurat, P103_Tumor_W00_2.5mgIpi_RNA.seurat, P103_Tumor_W12_2.5mgIpi_RNA.seurat, P103_Tumor_W20_2.5mgIpi_RNA.seurat, P104_Tumor_PD_2.5mgIpi_RNA.seurat, P108_Tumor_PD_5mgIpi_RNA.seurat))\ndim(merged.18279.tumor)\n\n[1]  61217 561184",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Tumor: QC & Filtering</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part1.html#qc-filter",
    "href": "Tumor_scRNA_Part1.html#qc-filter",
    "title": "1  Tumor: QC & Filtering",
    "section": "1.7 QC filter",
    "text": "1.7 QC filter\nUse relatively loose initial filters\n\nmerged.18279.tumor &lt;- subset(merged.18279.tumor, subset = nCount_RNA &gt; 500 & nFeature_RNA &gt; 250)\ndim(merged.18279.tumor)\n\n[1] 61217 64347\n\nmerged.18279.tumor &lt;- PercentageFeatureSet(merged.18279.tumor, pattern = \"^MT-\", col.name = \"percent.mt\")\nmerged.18279.tumor &lt;- RunMiQC(merged.18279.tumor, \n                        percent.mt = \"percent.mt\", \n                        nFeature_RNA = \"nFeature_RNA\", \n                        posterior.cutoff = 0.6, \n                        model.slot = \"flexmix_model\")\n\nWarning: Adding a command log without an assay associated with it\n\nmerged.18279.tumor &lt;- subset(merged.18279.tumor, miQC.keep == \"keep\")\n\ndim(merged.18279.tumor)\n\n[1] 61217 31415\n\ndata.frame(table(str_replace_all(colnames(merged.18279.tumor),\"_RNA_.+\",\"\")))\n\n                     Var1 Freq\n1 P101_Tumor_W00_2.5mgIpi 1128\n2 P101_Tumor_W12_2.5mgIpi 5123\n3 P101_Tumor_W20_2.5mgIpi 1397\n4 P103_Tumor_W00_2.5mgIpi 5061\n5 P103_Tumor_W12_2.5mgIpi 5523\n6 P103_Tumor_W20_2.5mgIpi 4553\n7  P104_Tumor_PD_2.5mgIpi 3932\n8    P108_Tumor_PD_5mgIpi 4698",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Tumor: QC & Filtering</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part1.html#add-meta-data",
    "href": "Tumor_scRNA_Part1.html#add-meta-data",
    "title": "1  Tumor: QC & Filtering",
    "section": "1.8 Add meta data",
    "text": "1.8 Add meta data\n\npatient &lt;- str_split_i(colnames(merged.18279.tumor),\"_\",1)\nsite &lt;- str_split_i(colnames(merged.18279.tumor),\"_\",2)\ntimepoint &lt;- str_split_i(colnames(merged.18279.tumor),\"_\",3)\nIpiCohort &lt;- str_split_i(colnames(merged.18279.tumor),\"_\",4)\nassay &lt;- str_split_i(colnames(merged.18279.tumor),\"_\",5)\nbarcode &lt;- str_split_i(colnames(merged.18279.tumor),\"_\",6)\nsample &lt;- paste0(patient,\"_\",site,\"_\",timepoint,\"_\",IpiCohort,\"_\",assay)\n\nmerged.18279.tumor &lt;- AddMetaData(merged.18279.tumor, patient, col.name=\"Patient\")\nmerged.18279.tumor &lt;- AddMetaData(merged.18279.tumor, site, col.name=\"Site\")\nmerged.18279.tumor &lt;- AddMetaData(merged.18279.tumor, timepoint, col.name=\"Timepoint\")\nmerged.18279.tumor &lt;- AddMetaData(merged.18279.tumor, IpiCohort, col.name=\"IpiCohort\")\nmerged.18279.tumor &lt;- AddMetaData(merged.18279.tumor, assay, col.name=\"Assay\")\nmerged.18279.tumor &lt;- AddMetaData(merged.18279.tumor, sample, col.name=\"Sample\")",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Tumor: QC & Filtering</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part1.html#join-then-re-split-rna-counts-layers-by-sample",
    "href": "Tumor_scRNA_Part1.html#join-then-re-split-rna-counts-layers-by-sample",
    "title": "1  Tumor: QC & Filtering",
    "section": "1.9 Join then re-split RNA counts layers by Sample",
    "text": "1.9 Join then re-split RNA counts layers by Sample\n\nmerged.18279.tumor[['RNA']] &lt;- JoinLayers(merged.18279.tumor[['RNA']])\nmerged.18279.tumor[[\"RNA\"]] &lt;- split(merged.18279.tumor[[\"RNA\"]], f = merged.18279.tumor$Sample)",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Tumor: QC & Filtering</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part1.html#save-merged-object",
    "href": "Tumor_scRNA_Part1.html#save-merged-object",
    "title": "1  Tumor: QC & Filtering",
    "section": "1.10 Save merged object",
    "text": "1.10 Save merged object\n\nsaveRDS(merged.18279.tumor,\"Tumor_scRNA_Part1.rds\")",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Tumor: QC & Filtering</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part1.html#get-session-info",
    "href": "Tumor_scRNA_Part1.html#get-session-info",
    "title": "1  Tumor: QC & Filtering",
    "section": "1.11 Get session info",
    "text": "1.11 Get session info\n\nsessionInfo()\n\nR version 4.3.2 (2023-10-31)\nPlatform: x86_64-pc-linux-gnu (64-bit)\nRunning under: Rocky Linux 8.10 (Green Obsidian)\n\nMatrix products: default\nBLAS/LAPACK: /usr/lib64/libopenblasp-r0.3.15.so;  LAPACK version 3.9.0\n\nlocale:\n [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              \n [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    \n [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   \n [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 \n [9] LC_ADDRESS=C               LC_TELEPHONE=C            \n[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       \n\ntime zone: America/New_York\ntzcode source: system (glibc)\n\nattached base packages:\n[1] stats4    stats     graphics  grDevices utils     datasets  methods  \n[8] base     \n\nother attached packages:\n [1] cellXY_0.99.0               scDblFinder_1.14.0         \n [3] harmony_1.2.0               alevinQC_1.16.1            \n [5] vctrs_0.6.5                 patchwork_1.3.0            \n [7] scater_1.30.1               scuttle_1.12.0             \n [9] speckle_1.0.0               Matrix_1.6-4               \n[11] fishpond_2.6.2              readxl_1.4.3               \n[13] SingleCellExperiment_1.24.0 SummarizedExperiment_1.32.0\n[15] Biobase_2.62.0              GenomicRanges_1.54.1       \n[17] GenomeInfoDb_1.38.8         IRanges_2.36.0             \n[19] S4Vectors_0.40.2            BiocGenerics_0.48.1        \n[21] MatrixGenerics_1.14.0       matrixStats_1.4.1          \n[23] flexmix_2.3-19              lattice_0.22-6             \n[25] SeuratWrappers_0.3.19       miQC_1.8.0                 \n[27] lubridate_1.9.3             forcats_1.0.0              \n[29] stringr_1.5.1               dplyr_1.1.4                \n[31] purrr_1.0.2                 readr_2.1.5                \n[33] tidyr_1.3.1                 tibble_3.2.1               \n[35] ggplot2_3.5.1               tidyverse_2.0.0            \n[37] Seurat_5.1.0                SeuratObject_5.0.2         \n[39] sp_2.1-4                    sctransform_0.4.1          \n[41] glmGamPoi_1.12.2            presto_1.0.0               \n[43] Rcpp_1.0.13-1               devtools_2.4.5             \n[45] usethis_3.0.0               data.table_1.16.2          \n\nloaded via a namespace (and not attached):\n  [1] fs_1.6.5                  spatstat.sparse_3.1-0    \n  [3] bitops_1.0-9              httr_1.4.7               \n  [5] RColorBrewer_1.1-3        profvis_0.4.0            \n  [7] tools_4.3.2               utf8_1.2.4               \n  [9] R6_2.5.1                  DT_0.33                  \n [11] lazyeval_0.2.2            uwot_0.2.2               \n [13] urlchecker_1.0.1          withr_3.0.2              \n [15] GGally_2.2.1              gridExtra_2.3            \n [17] progressr_0.15.1          cli_3.6.3                \n [19] spatstat.explore_3.2-6    fastDummies_1.7.3        \n [21] spatstat.data_3.1-4       ggridges_0.5.6           \n [23] pbapply_1.7-2             Rsamtools_2.18.0         \n [25] R.utils_2.12.3            parallelly_1.39.0        \n [27] sessioninfo_1.2.2         limma_3.58.1             \n [29] RSQLite_2.3.8             BiocIO_1.12.0            \n [31] generics_0.1.3            gtools_3.9.5             \n [33] ica_1.0-3                 spatstat.random_3.2-2    \n [35] ggbeeswarm_0.7.2          fansi_1.0.6              \n [37] abind_1.4-8               R.methodsS3_1.8.2        \n [39] lifecycle_1.0.4           yaml_2.3.10              \n [41] edgeR_4.0.16              SparseArray_1.2.2        \n [43] Rtsne_0.17                blob_1.2.4               \n [45] grid_4.3.2                dqrng_0.4.1              \n [47] promises_1.3.0            crayon_1.5.3             \n [49] shinydashboard_0.7.2      miniUI_0.1.1.1           \n [51] beachmat_2.18.1           cowplot_1.1.3            \n [53] KEGGREST_1.42.0           metapod_1.10.1           \n [55] pillar_1.9.0              knitr_1.45               \n [57] rjson_0.2.23              xgboost_1.7.8.1          \n [59] future.apply_1.11.3       codetools_0.2-20         \n [61] leiden_0.4.3.1            glue_1.8.0               \n [63] remotes_2.5.0             png_0.1-8                \n [65] spam_2.11-0               org.Mm.eg.db_3.18.0      \n [67] cellranger_1.1.0          gtable_0.3.6             \n [69] cachem_1.1.0              xfun_0.49                \n [71] S4Arrays_1.2.0            mime_0.12                \n [73] survival_3.7-0            bluster_1.12.0           \n [75] statmod_1.5.0             ellipsis_0.3.2           \n [77] fitdistrplus_1.2-1        ROCR_1.0-11              \n [79] nlme_3.1-166              bit64_4.5.2              \n [81] RcppAnnoy_0.0.22          irlba_2.3.5.1            \n [83] vipor_0.4.7               KernSmooth_2.23-24       \n [85] DBI_1.2.3                 colorspace_2.1-1         \n [87] nnet_7.3-19               tidyselect_1.2.1         \n [89] bit_4.5.0                 compiler_4.3.2           \n [91] BiocNeighbors_1.20.2      DelayedArray_0.28.0      \n [93] plotly_4.10.4             rtracklayer_1.62.0       \n [95] scales_1.3.0              lmtest_0.9-40            \n [97] digest_0.6.37             goftest_1.2-3            \n [99] spatstat.utils_3.1-1      rmarkdown_2.29           \n[101] XVector_0.42.0            htmltools_0.5.8.1        \n[103] pkgconfig_2.0.3           sparseMatrixStats_1.14.0 \n[105] fastmap_1.2.0             rlang_1.1.4              \n[107] htmlwidgets_1.6.4         shiny_1.9.1              \n[109] DelayedMatrixStats_1.24.0 farver_2.1.2             \n[111] zoo_1.8-12                jsonlite_1.8.9           \n[113] BiocParallel_1.36.0       R.oo_1.27.0              \n[115] BiocSingular_1.18.0       RCurl_1.98-1.16          \n[117] magrittr_2.0.3            modeltools_0.2-23        \n[119] GenomeInfoDbData_1.2.11   dotCall64_1.2            \n[121] munsell_0.5.1             viridis_0.6.5            \n[123] reticulate_1.35.0         stringi_1.8.4            \n[125] zlibbioc_1.48.2           MASS_7.3-60.0.1          \n[127] org.Hs.eg.db_3.18.0       plyr_1.8.9               \n[129] pkgbuild_1.4.5            ggstats_0.7.0            \n[131] parallel_4.3.2            listenv_0.9.1            \n[133] ggrepel_0.9.6             deldir_2.0-4             \n[135] Biostrings_2.70.3         splines_4.3.2            \n[137] tensor_1.5                hms_1.1.3                \n[139] locfit_1.5-9.10           igraph_2.1.1             \n[141] spatstat.geom_3.2-8       RcppHNSW_0.6.0           \n[143] reshape2_1.4.4            ScaledMatrix_1.10.0      \n[145] pkgload_1.4.0             XML_3.99-0.17            \n[147] evaluate_1.0.1            scran_1.30.2             \n[149] BiocManager_1.30.25       tzdb_0.4.0               \n[151] httpuv_1.6.15             RANN_2.6.2               \n[153] polyclip_1.10-7           future_1.34.0            \n[155] scattermore_1.2           rsvd_1.0.5               \n[157] xtable_1.8-4              restfulr_0.0.15          \n[159] svMisc_1.2.3              RSpectra_0.16-2          \n[161] later_1.3.2               viridisLite_0.4.2        \n[163] AnnotationDbi_1.64.1      GenomicAlignments_1.38.2 \n[165] memoise_2.0.1             beeswarm_0.4.0           \n[167] tximport_1.28.0           cluster_2.1.6            \n[169] timechange_0.3.0          globals_0.16.3",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Tumor: QC & Filtering</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part2.html",
    "href": "Tumor_scRNA_Part2.html",
    "title": "2  Tumor: Normalization, doublet discrimination, integration, clustering",
    "section": "",
    "text": "2.1 Set up Seurat workspace\n# Load libraries\nlibrary(data.table)\nlibrary(devtools)\nlibrary(presto)\nlibrary(BiocParallel)\nlibrary(glmGamPoi)\nlibrary(sctransform)\nlibrary(Seurat)\nlibrary(tidyverse)\nlibrary(miQC)\nlibrary(SeuratWrappers)\nlibrary(flexmix)\nlibrary(SingleCellExperiment)\nlibrary(SummarizedExperiment)\nlibrary(readxl)\nlibrary(fishpond)\nlibrary(Matrix)\nlibrary(speckle)\nlibrary(scater)\nlibrary(patchwork)\nlibrary(vctrs)\nlibrary(alevinQC)\nlibrary(harmony)\nlibrary(scDblFinder)\nlibrary(cellXY)\n\n# Set global options for Seurat v5 objects\noptions(Seurat.object.assay.version = 'v5')",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Tumor: Normalization, doublet discrimination, integration, clustering</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part2.html#load-previously-saved-merged-object",
    "href": "Tumor_scRNA_Part2.html#load-previously-saved-merged-object",
    "title": "2  Tumor: Normalization, doublet discrimination, integration, clustering",
    "section": "2.2 Load previously saved merged object",
    "text": "2.2 Load previously saved merged object\n\nmerged.18279.tumor &lt;- readRDS(\"Tumor_scRNA_Part1.rds\")",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Tumor: Normalization, doublet discrimination, integration, clustering</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part2.html#normalize-and-scale-data",
    "href": "Tumor_scRNA_Part2.html#normalize-and-scale-data",
    "title": "2  Tumor: Normalization, doublet discrimination, integration, clustering",
    "section": "2.3 Normalize and scale data",
    "text": "2.3 Normalize and scale data\nRegress out mitochondrial contribution\n\nmerged.18279.tumor &lt;- NormalizeData(merged.18279.tumor)\nmerged.18279.tumor &lt;- FindVariableFeatures(merged.18279.tumor, \n                                    assay = \"RNA\", \n                                    layer = \"data\", \n                                    selection.method = \"vst\", \n                                    nfeatures = 5000)\nmerged.18279.tumor &lt;- ScaleData(merged.18279.tumor, vars.to.regress = \"percent.mt\")",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Tumor: Normalization, doublet discrimination, integration, clustering</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part2.html#run-pca",
    "href": "Tumor_scRNA_Part2.html#run-pca",
    "title": "2  Tumor: Normalization, doublet discrimination, integration, clustering",
    "section": "2.4 Run PCA",
    "text": "2.4 Run PCA\n\nmerged.18279.tumor &lt;- RunPCA(merged.18279.tumor, npcs = 200, verbose = FALSE)\nElbowPlot(merged.18279.tumor, ndims = 200, reduction = \"pca\")",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Tumor: Normalization, doublet discrimination, integration, clustering</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part2.html#plot-unintegrated-umap",
    "href": "Tumor_scRNA_Part2.html#plot-unintegrated-umap",
    "title": "2  Tumor: Normalization, doublet discrimination, integration, clustering",
    "section": "2.5 Plot unintegrated UMAP",
    "text": "2.5 Plot unintegrated UMAP\n\nmerged.18279.tumor &lt;- RunUMAP(merged.18279.tumor, \n                        reduction = \"pca\", \n                        dims = 1:50, \n                        reduction.name = \"umap.unintegrated\")\n\nWarning: The default method for RunUMAP has changed from calling Python UMAP via reticulate to the R-native UWOT using the cosine metric\nTo use Python UMAP via reticulate, set umap.method to 'umap-learn' and metric to 'correlation'\nThis message will be shown once per session\n\n\n15:55:17 UMAP embedding parameters a = 0.9922 b = 1.112\n\n\n15:55:17 Read 31415 rows and found 50 numeric columns\n\n\n15:55:17 Using Annoy for neighbor search, n_neighbors = 30\n\n\n15:55:17 Building Annoy index with metric = cosine, n_trees = 50\n\n\n0%   10   20   30   40   50   60   70   80   90   100%\n\n\n[----|----|----|----|----|----|----|----|----|----|\n\n\n**************************************************|\n15:55:22 Writing NN index file to temp file /tmp/RtmprvDbhE/file290c7e43df97f7\n15:55:22 Searching Annoy index using 1 thread, search_k = 3000\n15:55:33 Annoy recall = 100%\n15:55:35 Commencing smooth kNN distance calibration using 1 thread with target n_neighbors = 30\n15:55:38 Initializing from normalized Laplacian + noise (using RSpectra)\n15:55:40 Commencing optimization for 200 epochs, with 1386960 positive edges\n15:55:55 Optimization finished\n\nDimPlot(merged.18279.tumor, reduction = \"umap.unintegrated\", group.by = c(\"Site\", \"Patient\", \"Timepoint\"))",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Tumor: Normalization, doublet discrimination, integration, clustering</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part2.html#call-preliminary-clusters-for-the-purposes-of-doublet-discrimination",
    "href": "Tumor_scRNA_Part2.html#call-preliminary-clusters-for-the-purposes-of-doublet-discrimination",
    "title": "2  Tumor: Normalization, doublet discrimination, integration, clustering",
    "section": "2.6 Call preliminary clusters for the purposes of doublet discrimination",
    "text": "2.6 Call preliminary clusters for the purposes of doublet discrimination\n\nmerged.18279.tumor &lt;- FindNeighbors(merged.18279.tumor, dims = 1:50, reduction = \"pca\")\n\nComputing nearest neighbor graph\n\n\nComputing SNN\n\nmerged.18279.tumor &lt;- FindClusters(merged.18279.tumor, \n                             resolution = 0.4, \n                             algorithm = 2)\n\nModularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck\n\nNumber of nodes: 31415\nNumber of edges: 1246446\n\nRunning Louvain algorithm with multilevel refinement...\nMaximum modularity in 10 random starts: 0.9585\nNumber of communities: 29\nElapsed time: 5 seconds\n\nDimPlot(merged.18279.tumor, reduction = \"umap.unintegrated\", label = T)",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Tumor: Normalization, doublet discrimination, integration, clustering</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part2.html#identify-and-remove-doublets",
    "href": "Tumor_scRNA_Part2.html#identify-and-remove-doublets",
    "title": "2  Tumor: Normalization, doublet discrimination, integration, clustering",
    "section": "2.7 Identify and remove doublets",
    "text": "2.7 Identify and remove doublets\nThis uses raw counts as input\n\n2.7.1 Combine RNA layers\n\nmerged.18279.tumor[['RNA']] &lt;- JoinLayers(merged.18279.tumor[['RNA']])\n\n\n\n2.7.2 Convert seurat to sce and check colData\n\nmerged.18279.tumor.sce &lt;- as.SingleCellExperiment(merged.18279.tumor, assay = \"RNA\")\nmerged.18279.tumor.sce\n\nclass: SingleCellExperiment \ndim: 61217 31415 \nmetadata(0):\nassays(2): counts logcounts\nrownames(61217): 5-8S-rRNA 5S-rRNA ... ZZEF1 ZZZ3\nrowData names(0):\ncolnames(31415): P101_Tumor_W00_2.5mgIpi_RNA_AGGTCCGGTGACAAAT\n  P101_Tumor_W00_2.5mgIpi_RNA_GATCGCGAGTACGCGA ...\n  P108_Tumor_PD_5mgIpi_RNA_ATTGGTGTCGTTTTCC\n  P108_Tumor_PD_5mgIpi_RNA_AGCGTCGTCATACGGT\ncolData names(15): orig.ident nCount_RNA ... seurat_clusters ident\nreducedDimNames(2): PCA UMAP.UNINTEGRATED\nmainExpName: RNA\naltExpNames(0):\n\ncolData(merged.18279.tumor.sce)\n\nDataFrame with 31415 rows and 15 columns\n                                                orig.ident nCount_RNA\n                                               &lt;character&gt;  &lt;numeric&gt;\nP101_Tumor_W00_2.5mgIpi_RNA_AGGTCCGGTGACAAAT SeuratProject    5288.99\nP101_Tumor_W00_2.5mgIpi_RNA_GATCGCGAGTACGCGA SeuratProject    3314.99\nP101_Tumor_W00_2.5mgIpi_RNA_TCACGAAAGAGCCCAA SeuratProject    4434.99\nP101_Tumor_W00_2.5mgIpi_RNA_CAACCTCCAGCCTTGG SeuratProject    5171.98\nP101_Tumor_W00_2.5mgIpi_RNA_GCTCTGTCACAGTCGC SeuratProject    4295.91\n...                                                    ...        ...\nP108_Tumor_PD_5mgIpi_RNA_ACTTACTAGGAGCGAG    SeuratProject    526.988\nP108_Tumor_PD_5mgIpi_RNA_CACCAGGTCGTACGGC    SeuratProject    532.000\nP108_Tumor_PD_5mgIpi_RNA_CGACTTCAGTGGAGTC    SeuratProject    556.000\nP108_Tumor_PD_5mgIpi_RNA_ATTGGTGTCGTTTTCC    SeuratProject    541.000\nP108_Tumor_PD_5mgIpi_RNA_AGCGTCGTCATACGGT    SeuratProject    500.000\n                                             nFeature_RNA percent.mt\n                                                &lt;integer&gt;  &lt;numeric&gt;\nP101_Tumor_W00_2.5mgIpi_RNA_AGGTCCGGTGACAAAT         1842    2.76045\nP101_Tumor_W00_2.5mgIpi_RNA_GATCGCGAGTACGCGA         1716    4.83561\nP101_Tumor_W00_2.5mgIpi_RNA_TCACGAAAGAGCCCAA         1806    4.64488\nP101_Tumor_W00_2.5mgIpi_RNA_CAACCTCCAGCCTTGG         2118    3.59762\nP101_Tumor_W00_2.5mgIpi_RNA_GCTCTGTCACAGTCGC         2067   10.98089\n...                                                   ...        ...\nP108_Tumor_PD_5mgIpi_RNA_ACTTACTAGGAGCGAG             252   10.05716\nP108_Tumor_PD_5mgIpi_RNA_CACCAGGTCGTACGGC             310    7.33083\nP108_Tumor_PD_5mgIpi_RNA_CGACTTCAGTGGAGTC             269    9.89209\nP108_Tumor_PD_5mgIpi_RNA_ATTGGTGTCGTTTTCC             467    8.59519\nP108_Tumor_PD_5mgIpi_RNA_AGCGTCGTCATACGGT             398    5.10000\n                                             miQC.probability   miQC.keep\n                                                    &lt;numeric&gt; &lt;character&gt;\nP101_Tumor_W00_2.5mgIpi_RNA_AGGTCCGGTGACAAAT         0.166588        keep\nP101_Tumor_W00_2.5mgIpi_RNA_GATCGCGAGTACGCGA         0.125028        keep\nP101_Tumor_W00_2.5mgIpi_RNA_TCACGAAAGAGCCCAA         0.131072        keep\nP101_Tumor_W00_2.5mgIpi_RNA_CAACCTCCAGCCTTGG         0.168588        keep\nP101_Tumor_W00_2.5mgIpi_RNA_GCTCTGTCACAGTCGC         0.493406        keep\n...                                                       ...         ...\nP108_Tumor_PD_5mgIpi_RNA_ACTTACTAGGAGCGAG           0.3196529        keep\nP108_Tumor_PD_5mgIpi_RNA_CACCAGGTCGTACGGC           0.1016414        keep\nP108_Tumor_PD_5mgIpi_RNA_CGACTTCAGTGGAGTC           0.2969933        keep\nP108_Tumor_PD_5mgIpi_RNA_ATTGGTGTCGTTTTCC           0.1737173        keep\nP108_Tumor_PD_5mgIpi_RNA_AGCGTCGTCATACGGT           0.0620316        keep\n                                                 Patient        Site\n                                             &lt;character&gt; &lt;character&gt;\nP101_Tumor_W00_2.5mgIpi_RNA_AGGTCCGGTGACAAAT        P101       Tumor\nP101_Tumor_W00_2.5mgIpi_RNA_GATCGCGAGTACGCGA        P101       Tumor\nP101_Tumor_W00_2.5mgIpi_RNA_TCACGAAAGAGCCCAA        P101       Tumor\nP101_Tumor_W00_2.5mgIpi_RNA_CAACCTCCAGCCTTGG        P101       Tumor\nP101_Tumor_W00_2.5mgIpi_RNA_GCTCTGTCACAGTCGC        P101       Tumor\n...                                                  ...         ...\nP108_Tumor_PD_5mgIpi_RNA_ACTTACTAGGAGCGAG           P108       Tumor\nP108_Tumor_PD_5mgIpi_RNA_CACCAGGTCGTACGGC           P108       Tumor\nP108_Tumor_PD_5mgIpi_RNA_CGACTTCAGTGGAGTC           P108       Tumor\nP108_Tumor_PD_5mgIpi_RNA_ATTGGTGTCGTTTTCC           P108       Tumor\nP108_Tumor_PD_5mgIpi_RNA_AGCGTCGTCATACGGT           P108       Tumor\n                                               Timepoint   IpiCohort\n                                             &lt;character&gt; &lt;character&gt;\nP101_Tumor_W00_2.5mgIpi_RNA_AGGTCCGGTGACAAAT         W00    2.5mgIpi\nP101_Tumor_W00_2.5mgIpi_RNA_GATCGCGAGTACGCGA         W00    2.5mgIpi\nP101_Tumor_W00_2.5mgIpi_RNA_TCACGAAAGAGCCCAA         W00    2.5mgIpi\nP101_Tumor_W00_2.5mgIpi_RNA_CAACCTCCAGCCTTGG         W00    2.5mgIpi\nP101_Tumor_W00_2.5mgIpi_RNA_GCTCTGTCACAGTCGC         W00    2.5mgIpi\n...                                                  ...         ...\nP108_Tumor_PD_5mgIpi_RNA_ACTTACTAGGAGCGAG             PD      5mgIpi\nP108_Tumor_PD_5mgIpi_RNA_CACCAGGTCGTACGGC             PD      5mgIpi\nP108_Tumor_PD_5mgIpi_RNA_CGACTTCAGTGGAGTC             PD      5mgIpi\nP108_Tumor_PD_5mgIpi_RNA_ATTGGTGTCGTTTTCC             PD      5mgIpi\nP108_Tumor_PD_5mgIpi_RNA_AGCGTCGTCATACGGT             PD      5mgIpi\n                                                   Assay                 Sample\n                                             &lt;character&gt;            &lt;character&gt;\nP101_Tumor_W00_2.5mgIpi_RNA_AGGTCCGGTGACAAAT         RNA P101_Tumor_W00_2.5mg..\nP101_Tumor_W00_2.5mgIpi_RNA_GATCGCGAGTACGCGA         RNA P101_Tumor_W00_2.5mg..\nP101_Tumor_W00_2.5mgIpi_RNA_TCACGAAAGAGCCCAA         RNA P101_Tumor_W00_2.5mg..\nP101_Tumor_W00_2.5mgIpi_RNA_CAACCTCCAGCCTTGG         RNA P101_Tumor_W00_2.5mg..\nP101_Tumor_W00_2.5mgIpi_RNA_GCTCTGTCACAGTCGC         RNA P101_Tumor_W00_2.5mg..\n...                                                  ...                    ...\nP108_Tumor_PD_5mgIpi_RNA_ACTTACTAGGAGCGAG            RNA P108_Tumor_PD_5mgIpi..\nP108_Tumor_PD_5mgIpi_RNA_CACCAGGTCGTACGGC            RNA P108_Tumor_PD_5mgIpi..\nP108_Tumor_PD_5mgIpi_RNA_CGACTTCAGTGGAGTC            RNA P108_Tumor_PD_5mgIpi..\nP108_Tumor_PD_5mgIpi_RNA_ATTGGTGTCGTTTTCC            RNA P108_Tumor_PD_5mgIpi..\nP108_Tumor_PD_5mgIpi_RNA_AGCGTCGTCATACGGT            RNA P108_Tumor_PD_5mgIpi..\n                                             RNA_snn_res.0.4 seurat_clusters\n                                                    &lt;factor&gt;        &lt;factor&gt;\nP101_Tumor_W00_2.5mgIpi_RNA_AGGTCCGGTGACAAAT              6               6 \nP101_Tumor_W00_2.5mgIpi_RNA_GATCGCGAGTACGCGA              22              22\nP101_Tumor_W00_2.5mgIpi_RNA_TCACGAAAGAGCCCAA              11              11\nP101_Tumor_W00_2.5mgIpi_RNA_CAACCTCCAGCCTTGG              6               6 \nP101_Tumor_W00_2.5mgIpi_RNA_GCTCTGTCACAGTCGC              8               8 \n...                                                      ...             ...\nP108_Tumor_PD_5mgIpi_RNA_ACTTACTAGGAGCGAG                 12              12\nP108_Tumor_PD_5mgIpi_RNA_CACCAGGTCGTACGGC                 12              12\nP108_Tumor_PD_5mgIpi_RNA_CGACTTCAGTGGAGTC                 12              12\nP108_Tumor_PD_5mgIpi_RNA_ATTGGTGTCGTTTTCC                 12              12\nP108_Tumor_PD_5mgIpi_RNA_AGCGTCGTCATACGGT                 6               6 \n                                                ident\n                                             &lt;factor&gt;\nP101_Tumor_W00_2.5mgIpi_RNA_AGGTCCGGTGACAAAT       6 \nP101_Tumor_W00_2.5mgIpi_RNA_GATCGCGAGTACGCGA       22\nP101_Tumor_W00_2.5mgIpi_RNA_TCACGAAAGAGCCCAA       11\nP101_Tumor_W00_2.5mgIpi_RNA_CAACCTCCAGCCTTGG       6 \nP101_Tumor_W00_2.5mgIpi_RNA_GCTCTGTCACAGTCGC       8 \n...                                               ...\nP108_Tumor_PD_5mgIpi_RNA_ACTTACTAGGAGCGAG          12\nP108_Tumor_PD_5mgIpi_RNA_CACCAGGTCGTACGGC          12\nP108_Tumor_PD_5mgIpi_RNA_CGACTTCAGTGGAGTC          12\nP108_Tumor_PD_5mgIpi_RNA_ATTGGTGTCGTTTTCC          12\nP108_Tumor_PD_5mgIpi_RNA_AGCGTCGTCATACGGT          6 \n\n\n\n\n2.7.3 Run scDblFinder\nSet the dbr.sd very high to better allow thresholds to be set based on misclassification rates per sample\n\nmerged.18279.tumor.sce &lt;- scDblFinder(merged.18279.tumor.sce,\n                    samples = \"Sample\",\n                    dbr.sd = 1,\n                    clusters = \"seurat_clusters\",\n                    BPPARAM = MulticoreParam(4,RNGseed=123)\n                )\n\n\n\n2.7.4 Inspect results\n\n# Look at the classes\ntable(merged.18279.tumor.sce$seurat_clusters, merged.18279.tumor.sce$scDblFinder.class)\n\n    \n     singlet doublet\n  0     4218     323\n  1     2529     212\n  2     2419     113\n  3     2398     101\n  4     2218     181\n  5     2234       6\n  6     1873     287\n  7     2036      10\n  8     1284     155\n  9     1232     157\n  10    1095      60\n  11     938     126\n  12     907       2\n  13     563     159\n  14     454      44\n  15     393      70\n  16     383      60\n  17     355      42\n  18     278      26\n  19     262      26\n  20     200      68\n  21     200      19\n  22      51     125\n  23       0     138\n  24      81      22\n  25      81      12\n  26      33      51\n  27      16      54\n  28       5      30\n\ntable(merged.18279.tumor.sce$Sample, merged.18279.tumor.sce$scDblFinder.class)\n\n                             \n                              singlet doublet\n  P101_Tumor_W00_2.5mgIpi_RNA    1028     100\n  P101_Tumor_W12_2.5mgIpi_RNA    4807     316\n  P101_Tumor_W20_2.5mgIpi_RNA    1298      99\n  P103_Tumor_W00_2.5mgIpi_RNA    4635     426\n  P103_Tumor_W12_2.5mgIpi_RNA    5058     465\n  P103_Tumor_W20_2.5mgIpi_RNA    4085     468\n  P104_Tumor_PD_2.5mgIpi_RNA     3572     360\n  P108_Tumor_PD_5mgIpi_RNA       4253     445\n\n# Look at the scores\nsummary(merged.18279.tumor.sce$scDblFinder.score)\n\n     Min.   1st Qu.    Median      Mean   3rd Qu.      Max. \n0.0000039 0.0054557 0.0275547 0.1358086 0.1161005 0.9999959 \n\n\n\n\n2.7.5 Save doublet classifications into main Seurat object\n\nmerged.18279.tumor$doublet_classification &lt;- merged.18279.tumor.sce$scDblFinder.class\n\n\n\n2.7.6 Count singlets and doublets\n\ntable(merged.18279.tumor$doublet_classification)\n\n\nsinglet doublet \n  28736    2679 \n\ntable(merged.18279.tumor$doublet_classification, merged.18279.tumor$seurat_clusters)\n\n         \n             0    1    2    3    4    5    6    7    8    9   10   11   12   13\n  singlet 4218 2529 2419 2398 2218 2234 1873 2036 1284 1232 1095  938  907  563\n  doublet  323  212  113  101  181    6  287   10  155  157   60  126    2  159\n         \n            14   15   16   17   18   19   20   21   22   23   24   25   26   27\n  singlet  454  393  383  355  278  262  200  200   51    0   81   81   33   16\n  doublet   44   70   60   42   26   26   68   19  125  138   22   12   51   54\n         \n            28\n  singlet    5\n  doublet   30\n\n\n\n\n2.7.7 Plot singlets/doublets in UMAP space\n\nDimPlot(merged.18279.tumor,reduction = \"umap.unintegrated\", group.by = \"doublet_classification\")\n\n\n\n\n\n\n\n\n\n\n2.7.8 Subset object to remove doublets and count remaining cells\n\nmerged.18279.tumor.singlets &lt;- subset(merged.18279.tumor, doublet_classification %in% c(\"singlet\"))\ndim(merged.18279.tumor.singlets)\n\n[1] 61217 28736\n\n# Count remaining cells per initial cluster\ntable(merged.18279.tumor.singlets$seurat_clusters)\n\n\n   0    1    2    3    4    5    6    7    8    9   10   11   12   13   14   15 \n4218 2529 2419 2398 2218 2234 1873 2036 1284 1232 1095  938  907  563  454  393 \n  16   17   18   19   20   21   22   23   24   25   26   27   28 \n 383  355  278  262  200  200   51    0   81   81   33   16    5",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Tumor: Normalization, doublet discrimination, integration, clustering</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part2.html#remove-cells-with-very-high-ncount_rna-values-set-other-final-qc-filters",
    "href": "Tumor_scRNA_Part2.html#remove-cells-with-very-high-ncount_rna-values-set-other-final-qc-filters",
    "title": "2  Tumor: Normalization, doublet discrimination, integration, clustering",
    "section": "2.8 Remove cells with very high nCount_RNA values, set other final QC filters",
    "text": "2.8 Remove cells with very high nCount_RNA values, set other final QC filters\n\nmerged.18279.tumor.singlets &lt;- subset(merged.18279.tumor.singlets,\n                                subset = nCount_RNA &lt; 40000 & nCount_RNA &gt; 1500 & nFeature_RNA &gt; 750)\ndim(merged.18279.tumor.singlets)\n\n[1] 61217 19976",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Tumor: Normalization, doublet discrimination, integration, clustering</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part2.html#re-compute-pca",
    "href": "Tumor_scRNA_Part2.html#re-compute-pca",
    "title": "2  Tumor: Normalization, doublet discrimination, integration, clustering",
    "section": "2.9 Re-compute PCA",
    "text": "2.9 Re-compute PCA\nRe-scale data now that it has been subset\n\nmerged.18279.tumor.singlets[[\"RNA\"]] &lt;- split(merged.18279.tumor.singlets[[\"RNA\"]], f = merged.18279.tumor.singlets$Sample)\n\nmerged.18279.tumor.singlets &lt;- FindVariableFeatures(merged.18279.tumor.singlets, \n                                    assay = \"RNA\", \n                                    layer = \"data\", \n                                    selection.method = \"vst\", \n                                    nfeatures = 5000)\nmerged.18279.tumor.singlets &lt;- ScaleData(merged.18279.tumor.singlets, vars.to.regress = \"percent.mt\")\nmerged.18279.tumor.singlets &lt;- RunPCA(merged.18279.tumor.singlets, npcs = 200, verbose = FALSE)",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Tumor: Normalization, doublet discrimination, integration, clustering</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part2.html#run-harmony-integration",
    "href": "Tumor_scRNA_Part2.html#run-harmony-integration",
    "title": "2  Tumor: Normalization, doublet discrimination, integration, clustering",
    "section": "2.10 Run Harmony integration",
    "text": "2.10 Run Harmony integration\n\nmerged.18279.tumor.singlets &lt;- IntegrateLayers(merged.18279.tumor.singlets, \n                                method = HarmonyIntegration, \n                                orig.reduction = \"pca\",\n                                new.reduction = \"integrated.harmony\"\n)\n\nWarning: HarmonyMatrix is deprecated and will be removed in the future from the\nAPI in the future\n\n\nWarning: Warning: The parameters do_pca and npcs are deprecated. They will be ignored for this function call and please remove parameters do_pca and npcs and pass to harmony cell_embeddings directly.\nThis warning is displayed once per session.\n\n\nWarning: Warning: The parameter tau is deprecated. It will be ignored for this function call and please remove parameter tau in future function calls. Advanced users can set value of parameter tau by using parameter .options and function harmony_options().\nThis warning is displayed once per session.\n\n\nWarning: Warning: The parameter block.size is deprecated. It will be ignored for this function call and please remove parameter block.size in future function calls. Advanced users can set value of parameter block.size by using parameter .options and function harmony_options().\nThis warning is displayed once per session.\n\n\nWarning: Warning: The parameter max.iter.harmony is replaced with parameter max_iter. It will be ignored for this function call and please use parameter max_iter in future function calls.\nThis warning is displayed once per session.\n\n\nWarning: Warning: The parameter max.iter.cluster is deprecated. It will be ignored for this function call and please remove parameter max.iter.cluster in future function calls. Advanced users can set value of parameter max.iter.cluster by using parameter .options and function harmony_options().\nThis warning is displayed once per session.\n\n\nWarning: Warning: The parameter epsilon.cluster is deprecated. It will be ignored for this function call and please remove parameter epsilon.cluster in future function calls. Advanced users can set value of parameter epsilon.cluster by using parameter .options and function harmony_options().\nThis warning is displayed once per session.\n\n\nWarning: Warning: The parameter epsilon.harmony is deprecated. It will be ignored for this function call and please remove parameter epsilon.harmony in future function calls. If users want to control if harmony would stop early or not, use parameter early_stop. Advanced users can set value of parameter epsilon.harmony by using parameter .options and function harmony_options().\nThis warning is displayed once per session.\n\n\nTransposing data matrix\n\n\nUsing automatic lambda estimation\n\n\nInitializing state using k-means centroids initialization\n\n\nHarmony 1/10\n\n\nHarmony 2/10\n\n\nHarmony 3/10\n\n\nHarmony 4/10\n\n\nHarmony 5/10\n\n\nHarmony converged after 5 iterations",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Tumor: Normalization, doublet discrimination, integration, clustering</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part2.html#identify-clusters-after-integration-across-a-range-of-clustering-resolutions",
    "href": "Tumor_scRNA_Part2.html#identify-clusters-after-integration-across-a-range-of-clustering-resolutions",
    "title": "2  Tumor: Normalization, doublet discrimination, integration, clustering",
    "section": "2.11 Identify clusters after integration across a range of clustering resolutions",
    "text": "2.11 Identify clusters after integration across a range of clustering resolutions\n\nmerged.18279.tumor.singlets &lt;- FindNeighbors(merged.18279.tumor.singlets, dims = 1:50, reduction = \"integrated.harmony\")\n\nComputing nearest neighbor graph\n\n\nComputing SNN\n\nmerged.18279.tumor.singlets &lt;- FindClusters(merged.18279.tumor.singlets, \n                             resolution = seq(0.1, 2, by=0.1), \n                             algorithm = 2)\n\nModularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck\n\nNumber of nodes: 19976\nNumber of edges: 792019\n\nRunning Louvain algorithm with multilevel refinement...\nMaximum modularity in 10 random starts: 0.9763\nNumber of communities: 12\nElapsed time: 2 seconds\nModularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck\n\nNumber of nodes: 19976\nNumber of edges: 792019\n\nRunning Louvain algorithm with multilevel refinement...\nMaximum modularity in 10 random starts: 0.9563\nNumber of communities: 16\nElapsed time: 2 seconds\nModularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck\n\nNumber of nodes: 19976\nNumber of edges: 792019\n\nRunning Louvain algorithm with multilevel refinement...\nMaximum modularity in 10 random starts: 0.9434\nNumber of communities: 18\nElapsed time: 2 seconds\nModularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck\n\nNumber of nodes: 19976\nNumber of edges: 792019\n\nRunning Louvain algorithm with multilevel refinement...\nMaximum modularity in 10 random starts: 0.9327\nNumber of communities: 20\nElapsed time: 2 seconds\nModularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck\n\nNumber of nodes: 19976\nNumber of edges: 792019\n\nRunning Louvain algorithm with multilevel refinement...\nMaximum modularity in 10 random starts: 0.9228\nNumber of communities: 25\nElapsed time: 2 seconds\nModularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck\n\nNumber of nodes: 19976\nNumber of edges: 792019\n\nRunning Louvain algorithm with multilevel refinement...\nMaximum modularity in 10 random starts: 0.9136\nNumber of communities: 26\nElapsed time: 2 seconds\nModularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck\n\nNumber of nodes: 19976\nNumber of edges: 792019\n\nRunning Louvain algorithm with multilevel refinement...\nMaximum modularity in 10 random starts: 0.9045\nNumber of communities: 28\nElapsed time: 2 seconds\nModularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck\n\nNumber of nodes: 19976\nNumber of edges: 792019\n\nRunning Louvain algorithm with multilevel refinement...\nMaximum modularity in 10 random starts: 0.8970\nNumber of communities: 29\nElapsed time: 2 seconds\nModularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck\n\nNumber of nodes: 19976\nNumber of edges: 792019\n\nRunning Louvain algorithm with multilevel refinement...\nMaximum modularity in 10 random starts: 0.8896\nNumber of communities: 29\nElapsed time: 3 seconds\nModularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck\n\nNumber of nodes: 19976\nNumber of edges: 792019\n\nRunning Louvain algorithm with multilevel refinement...\nMaximum modularity in 10 random starts: 0.8826\nNumber of communities: 30\nElapsed time: 2 seconds\nModularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck\n\nNumber of nodes: 19976\nNumber of edges: 792019\n\nRunning Louvain algorithm with multilevel refinement...\nMaximum modularity in 10 random starts: 0.8761\nNumber of communities: 32\nElapsed time: 3 seconds\nModularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck\n\nNumber of nodes: 19976\nNumber of edges: 792019\n\nRunning Louvain algorithm with multilevel refinement...\nMaximum modularity in 10 random starts: 0.8702\nNumber of communities: 33\nElapsed time: 3 seconds\nModularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck\n\nNumber of nodes: 19976\nNumber of edges: 792019\n\nRunning Louvain algorithm with multilevel refinement...\nMaximum modularity in 10 random starts: 0.8650\nNumber of communities: 34\nElapsed time: 2 seconds\nModularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck\n\nNumber of nodes: 19976\nNumber of edges: 792019\n\nRunning Louvain algorithm with multilevel refinement...\nMaximum modularity in 10 random starts: 0.8597\nNumber of communities: 34\nElapsed time: 2 seconds\nModularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck\n\nNumber of nodes: 19976\nNumber of edges: 792019\n\nRunning Louvain algorithm with multilevel refinement...\nMaximum modularity in 10 random starts: 0.8548\nNumber of communities: 35\nElapsed time: 2 seconds\nModularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck\n\nNumber of nodes: 19976\nNumber of edges: 792019\n\nRunning Louvain algorithm with multilevel refinement...\nMaximum modularity in 10 random starts: 0.8499\nNumber of communities: 36\nElapsed time: 3 seconds\nModularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck\n\nNumber of nodes: 19976\nNumber of edges: 792019\n\nRunning Louvain algorithm with multilevel refinement...\nMaximum modularity in 10 random starts: 0.8451\nNumber of communities: 37\nElapsed time: 2 seconds\nModularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck\n\nNumber of nodes: 19976\nNumber of edges: 792019\n\nRunning Louvain algorithm with multilevel refinement...\nMaximum modularity in 10 random starts: 0.8407\nNumber of communities: 41\nElapsed time: 2 seconds\nModularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck\n\nNumber of nodes: 19976\nNumber of edges: 792019\n\nRunning Louvain algorithm with multilevel refinement...\nMaximum modularity in 10 random starts: 0.8369\nNumber of communities: 43\nElapsed time: 3 seconds\nModularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck\n\nNumber of nodes: 19976\nNumber of edges: 792019\n\nRunning Louvain algorithm with multilevel refinement...\nMaximum modularity in 10 random starts: 0.8329\nNumber of communities: 42\nElapsed time: 2 seconds\n\nmerged.18279.tumor.singlets &lt;- RunUMAP(merged.18279.tumor.singlets,\n                        reduction = \"integrated.harmony\",\n                        dims = 1:50,\n                        reduction.name = \"umap.harmony\")\n\n16:13:09 UMAP embedding parameters a = 0.9922 b = 1.112\n\n\n16:13:09 Read 19976 rows and found 50 numeric columns\n\n\n16:13:09 Using Annoy for neighbor search, n_neighbors = 30\n\n\n16:13:09 Building Annoy index with metric = cosine, n_trees = 50\n\n\n0%   10   20   30   40   50   60   70   80   90   100%\n\n\n[----|----|----|----|----|----|----|----|----|----|\n\n\n**************************************************|\n16:13:12 Writing NN index file to temp file /tmp/RtmprvDbhE/file290c7e3636242f\n16:13:12 Searching Annoy index using 1 thread, search_k = 3000\n16:13:19 Annoy recall = 100%\n16:13:20 Commencing smooth kNN distance calibration using 1 thread with target n_neighbors = 30\n16:13:22 Initializing from normalized Laplacian + noise (using RSpectra)\n16:13:24 Commencing optimization for 200 epochs, with 883792 positive edges\n16:13:34 Optimization finished\n\ntable(merged.18279.tumor.singlets$seurat_clusters)\n\n\n   0    1    2    3    4    5    6    7    8    9   10   11   12   13   14   15 \n1482 1321 1147 1135 1132 1106  968  945  849  848  783  709  670  538  537  485 \n  16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31 \n 467  444  428  406  399  371  336  306  288  274  229  228  151  147  121  114 \n  32   33   34   35   36   37   38   39   40   41 \n 104   85   82   77   75   63   36   33   30   27",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Tumor: Normalization, doublet discrimination, integration, clustering</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part2.html#plot-clusters",
    "href": "Tumor_scRNA_Part2.html#plot-clusters",
    "title": "2  Tumor: Normalization, doublet discrimination, integration, clustering",
    "section": "2.12 Plot clusters",
    "text": "2.12 Plot clusters\n\n# Plot one as example\nDimPlot(merged.18279.tumor.singlets,reduction = \"umap.harmony\", label = TRUE, group.by = \"RNA_snn_res.1\")",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Tumor: Normalization, doublet discrimination, integration, clustering</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part2.html#plot-metadata-in-umap-space",
    "href": "Tumor_scRNA_Part2.html#plot-metadata-in-umap-space",
    "title": "2  Tumor: Normalization, doublet discrimination, integration, clustering",
    "section": "2.13 Plot metadata in UMAP space",
    "text": "2.13 Plot metadata in UMAP space\n\nDimPlot(merged.18279.tumor.singlets,reduction = \"umap.harmony\", group.by = \"Patient\")\n\n\n\n\n\n\n\nDimPlot(merged.18279.tumor.singlets,reduction = \"umap.harmony\", group.by = \"Site\")\n\n\n\n\n\n\n\nDimPlot(merged.18279.tumor.singlets,reduction = \"umap.harmony\", group.by = \"Timepoint\")\n\n\n\n\n\n\n\nDimPlot(merged.18279.tumor.singlets,reduction = \"umap.harmony\", group.by = \"IpiCohort\")\n\n\n\n\n\n\n\nDimPlot(merged.18279.tumor.singlets,reduction = \"umap.harmony\", group.by = \"Sample\") + NoLegend()\n\n\n\n\n\n\n\nFeaturePlot(merged.18279.tumor.singlets,reduction = \"umap.harmony\",features=\"nCount_RNA\",order=T)\n\n\n\n\n\n\n\nFeaturePlot(merged.18279.tumor.singlets,reduction = \"umap.harmony\",features=\"nFeature_RNA\",order=T)\n\n\n\n\n\n\n\nFeaturePlot(merged.18279.tumor.singlets,reduction = \"umap.harmony\",features=\"percent.mt\",order=T)",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Tumor: Normalization, doublet discrimination, integration, clustering</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part2.html#save-clustered-object",
    "href": "Tumor_scRNA_Part2.html#save-clustered-object",
    "title": "2  Tumor: Normalization, doublet discrimination, integration, clustering",
    "section": "2.14 Save clustered object",
    "text": "2.14 Save clustered object\n\nsaveRDS(merged.18279.tumor.singlets,\"Tumor_scRNA_Part2.rds\")",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Tumor: Normalization, doublet discrimination, integration, clustering</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part2.html#get-session-info",
    "href": "Tumor_scRNA_Part2.html#get-session-info",
    "title": "2  Tumor: Normalization, doublet discrimination, integration, clustering",
    "section": "2.15 Get session info",
    "text": "2.15 Get session info\n\nsessionInfo()\n\nR version 4.3.2 (2023-10-31)\nPlatform: x86_64-pc-linux-gnu (64-bit)\nRunning under: Rocky Linux 8.10 (Green Obsidian)\n\nMatrix products: default\nBLAS/LAPACK: /usr/lib64/libopenblasp-r0.3.15.so;  LAPACK version 3.9.0\n\nlocale:\n [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              \n [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    \n [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   \n [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 \n [9] LC_ADDRESS=C               LC_TELEPHONE=C            \n[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       \n\ntime zone: America/New_York\ntzcode source: system (glibc)\n\nattached base packages:\n[1] stats4    stats     graphics  grDevices utils     datasets  methods  \n[8] base     \n\nother attached packages:\n [1] cellXY_0.99.0               scDblFinder_1.14.0         \n [3] harmony_1.2.0               alevinQC_1.16.1            \n [5] vctrs_0.6.5                 patchwork_1.3.0            \n [7] scater_1.30.1               scuttle_1.12.0             \n [9] speckle_1.0.0               Matrix_1.6-4               \n[11] fishpond_2.6.2              readxl_1.4.3               \n[13] SingleCellExperiment_1.24.0 SummarizedExperiment_1.32.0\n[15] Biobase_2.62.0              GenomicRanges_1.54.1       \n[17] GenomeInfoDb_1.38.8         IRanges_2.36.0             \n[19] S4Vectors_0.40.2            BiocGenerics_0.48.1        \n[21] MatrixGenerics_1.14.0       matrixStats_1.4.1          \n[23] flexmix_2.3-19              lattice_0.22-6             \n[25] SeuratWrappers_0.3.19       miQC_1.8.0                 \n[27] lubridate_1.9.3             forcats_1.0.0              \n[29] stringr_1.5.1               dplyr_1.1.4                \n[31] purrr_1.0.2                 readr_2.1.5                \n[33] tidyr_1.3.1                 tibble_3.2.1               \n[35] ggplot2_3.5.1               tidyverse_2.0.0            \n[37] Seurat_5.1.0                SeuratObject_5.0.2         \n[39] sp_2.1-4                    sctransform_0.4.1          \n[41] glmGamPoi_1.12.2            BiocParallel_1.36.0        \n[43] presto_1.0.0                Rcpp_1.0.13-1              \n[45] devtools_2.4.5              usethis_3.0.0              \n[47] data.table_1.16.2          \n\nloaded via a namespace (and not attached):\n  [1] fs_1.6.5                  spatstat.sparse_3.1-0    \n  [3] bitops_1.0-9              httr_1.4.7               \n  [5] RColorBrewer_1.1-3        profvis_0.4.0            \n  [7] tools_4.3.2               utf8_1.2.4               \n  [9] R6_2.5.1                  DT_0.33                  \n [11] lazyeval_0.2.2            uwot_0.2.2               \n [13] urlchecker_1.0.1          withr_3.0.2              \n [15] GGally_2.2.1              gridExtra_2.3            \n [17] progressr_0.15.1          cli_3.6.3                \n [19] spatstat.explore_3.2-6    fastDummies_1.7.3        \n [21] labeling_0.4.3            spatstat.data_3.1-4      \n [23] ggridges_0.5.6            pbapply_1.7-2            \n [25] Rsamtools_2.18.0          R.utils_2.12.3           \n [27] parallelly_1.39.0         sessioninfo_1.2.2        \n [29] limma_3.58.1              RSQLite_2.3.8            \n [31] BiocIO_1.12.0             generics_0.1.3           \n [33] gtools_3.9.5              ica_1.0-3                \n [35] spatstat.random_3.2-2     ggbeeswarm_0.7.2         \n [37] fansi_1.0.6               abind_1.4-8              \n [39] R.methodsS3_1.8.2         lifecycle_1.0.4          \n [41] yaml_2.3.10               edgeR_4.0.16             \n [43] SparseArray_1.2.2         Rtsne_0.17               \n [45] blob_1.2.4                grid_4.3.2               \n [47] dqrng_0.4.1               promises_1.3.0           \n [49] crayon_1.5.3              shinydashboard_0.7.2     \n [51] miniUI_0.1.1.1            beachmat_2.18.1          \n [53] cowplot_1.1.3             KEGGREST_1.42.0          \n [55] metapod_1.10.1            pillar_1.9.0             \n [57] knitr_1.45                rjson_0.2.23             \n [59] xgboost_1.7.8.1           future.apply_1.11.3      \n [61] codetools_0.2-20          leiden_0.4.3.1           \n [63] glue_1.8.0                remotes_2.5.0            \n [65] png_0.1-8                 spam_2.11-0              \n [67] org.Mm.eg.db_3.18.0       cellranger_1.1.0         \n [69] gtable_0.3.6              cachem_1.1.0             \n [71] xfun_0.49                 S4Arrays_1.2.0           \n [73] mime_0.12                 survival_3.7-0           \n [75] bluster_1.12.0            statmod_1.5.0            \n [77] ellipsis_0.3.2            fitdistrplus_1.2-1       \n [79] ROCR_1.0-11               nlme_3.1-166             \n [81] bit64_4.5.2               RcppAnnoy_0.0.22         \n [83] irlba_2.3.5.1             vipor_0.4.7              \n [85] KernSmooth_2.23-24        DBI_1.2.3                \n [87] colorspace_2.1-1          nnet_7.3-19              \n [89] tidyselect_1.2.1          bit_4.5.0                \n [91] compiler_4.3.2            BiocNeighbors_1.20.2     \n [93] DelayedArray_0.28.0       plotly_4.10.4            \n [95] rtracklayer_1.62.0        scales_1.3.0             \n [97] lmtest_0.9-40             digest_0.6.37            \n [99] goftest_1.2-3             spatstat.utils_3.1-1     \n[101] rmarkdown_2.29            RhpcBLASctl_0.23-42      \n[103] XVector_0.42.0            htmltools_0.5.8.1        \n[105] pkgconfig_2.0.3           sparseMatrixStats_1.14.0 \n[107] fastmap_1.2.0             rlang_1.1.4              \n[109] htmlwidgets_1.6.4         shiny_1.9.1              \n[111] DelayedMatrixStats_1.24.0 farver_2.1.2             \n[113] zoo_1.8-12                jsonlite_1.8.9           \n[115] R.oo_1.27.0               BiocSingular_1.18.0      \n[117] RCurl_1.98-1.16           magrittr_2.0.3           \n[119] modeltools_0.2-23         GenomeInfoDbData_1.2.11  \n[121] dotCall64_1.2             munsell_0.5.1            \n[123] viridis_0.6.5             reticulate_1.35.0        \n[125] stringi_1.8.4             zlibbioc_1.48.2          \n[127] MASS_7.3-60.0.1           org.Hs.eg.db_3.18.0      \n[129] plyr_1.8.9                pkgbuild_1.4.5           \n[131] ggstats_0.7.0             parallel_4.3.2           \n[133] listenv_0.9.1             ggrepel_0.9.6            \n[135] deldir_2.0-4              Biostrings_2.70.3        \n[137] splines_4.3.2             tensor_1.5               \n[139] hms_1.1.3                 locfit_1.5-9.10          \n[141] igraph_2.1.1              spatstat.geom_3.2-8      \n[143] RcppHNSW_0.6.0            reshape2_1.4.4           \n[145] ScaledMatrix_1.10.0       pkgload_1.4.0            \n[147] XML_3.99-0.17             evaluate_1.0.1           \n[149] scran_1.30.2              BiocManager_1.30.25      \n[151] tzdb_0.4.0                httpuv_1.6.15            \n[153] RANN_2.6.2                polyclip_1.10-7          \n[155] future_1.34.0             scattermore_1.2          \n[157] rsvd_1.0.5                xtable_1.8-4             \n[159] restfulr_0.0.15           svMisc_1.2.3             \n[161] RSpectra_0.16-2           later_1.3.2              \n[163] viridisLite_0.4.2         AnnotationDbi_1.64.1     \n[165] GenomicAlignments_1.38.2  memoise_2.0.1            \n[167] beeswarm_0.4.0            tximport_1.28.0          \n[169] cluster_2.1.6             timechange_0.3.0         \n[171] globals_0.16.3",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Tumor: Normalization, doublet discrimination, integration, clustering</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part3.html",
    "href": "Tumor_scRNA_Part3.html",
    "title": "3  Tumor: Check patient sexes",
    "section": "",
    "text": "3.1 Set up Seurat workspace\n# Load libraries\nlibrary(data.table)\nlibrary(devtools)\nlibrary(presto)\nlibrary(glmGamPoi)\nlibrary(sctransform)\nlibrary(Seurat) \nlibrary(tidyverse)\nlibrary(miQC)\nlibrary(SeuratWrappers)\nlibrary(flexmix)\nlibrary(SingleCellExperiment)\nlibrary(SummarizedExperiment)\nlibrary(readxl)\nlibrary(fishpond)\nlibrary(Matrix)\nlibrary(speckle)\nlibrary(scater)\nlibrary(patchwork)\nlibrary(vctrs)\nlibrary(alevinQC)\nlibrary(harmony)\nlibrary(scDblFinder)\nlibrary(cellXY)\n\n# Set global options for Seurat v5 objects\noptions(Seurat.object.assay.version = 'v5')",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Tumor: Check patient sexes</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part3.html#load-previously-saved-clustered-object",
    "href": "Tumor_scRNA_Part3.html#load-previously-saved-clustered-object",
    "title": "3  Tumor: Check patient sexes",
    "section": "3.2 Load previously saved clustered object",
    "text": "3.2 Load previously saved clustered object\n\nmerged.18279.tumor.singlets &lt;- readRDS(\"Tumor_scRNA_Part2.rds\")",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Tumor: Check patient sexes</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part3.html#infer-sex-per-cell-using-chrx-and-chry-gene-counts-using-cellxy",
    "href": "Tumor_scRNA_Part3.html#infer-sex-per-cell-using-chrx-and-chry-gene-counts-using-cellxy",
    "title": "3  Tumor: Check patient sexes",
    "section": "3.3 Infer sex per cell using chrX and chrY gene counts using cellXY",
    "text": "3.3 Infer sex per cell using chrX and chrY gene counts using cellXY\n\nmerged.18279.tumor.singlets[['RNA']] &lt;- JoinLayers(merged.18279.tumor.singlets[['RNA']])\nxyPredict &lt;- classifySex(x = merged.18279.tumor.singlets@assays$RNA$counts, \n                         genome = \"Hs\", \n                         qc = FALSE)\n\nWarning in asMethod(object): sparse-&gt;dense coercion: allocating vector of size\n9.1 GiB\n\n\n4cell/s are unable to be classified\n              due to an abundance of zeroes on X and Y chromosome genes\n\nmerged.18279.tumor.singlets &lt;- AddMetaData(merged.18279.tumor.singlets,\n                                           xyPredict$prediction,\n                                           col.name = \"CellPredictedSex\")",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Tumor: Check patient sexes</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part3.html#assign-known-sexes-to-each-sample",
    "href": "Tumor_scRNA_Part3.html#assign-known-sexes-to-each-sample",
    "title": "3  Tumor: Check patient sexes",
    "section": "3.4 Assign known sexes to each sample",
    "text": "3.4 Assign known sexes to each sample\n\nknownSex &lt;- as.data.frame(cbind(\"Sample\" = unique(merged.18279.tumor.singlets$Sample), \"Sex\" = c(rep(\"Male\",3),rep(\"Male\",3),rep(\"Female\",1),rep(\"Male\",1))))\n\nknownSex\n\n                       Sample    Sex\n1 P101_Tumor_W00_2.5mgIpi_RNA   Male\n2 P101_Tumor_W12_2.5mgIpi_RNA   Male\n3 P101_Tumor_W20_2.5mgIpi_RNA   Male\n4 P103_Tumor_W00_2.5mgIpi_RNA   Male\n5 P103_Tumor_W12_2.5mgIpi_RNA   Male\n6 P103_Tumor_W20_2.5mgIpi_RNA   Male\n7  P104_Tumor_PD_2.5mgIpi_RNA Female\n8    P108_Tumor_PD_5mgIpi_RNA   Male",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Tumor: Check patient sexes</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part3.html#summarize-cell-wise-sex-predictions-per-sample-and-compare-to-known-labels",
    "href": "Tumor_scRNA_Part3.html#summarize-cell-wise-sex-predictions-per-sample-and-compare-to-known-labels",
    "title": "3  Tumor: Check patient sexes",
    "section": "3.5 Summarize cell-wise sex predictions per Sample and compare to known labels",
    "text": "3.5 Summarize cell-wise sex predictions per Sample and compare to known labels\nIf more than 80% of the individual cell sex predictions are consistent for a given Sample, we call that Sample as that sex, then match to known labels\n\n# Show snippet first\nrownames_to_column(merged.18279.tumor.singlets@meta.data,var=\"bc\") %&gt;%\n    as_tibble() %&gt;%\n    dplyr::select(bc,CellPredictedSex,Sample) %&gt;%\n    group_by(Sample) %&gt;%\n    summarize(nMale = sum(CellPredictedSex==\"Male\"), \n        nFemale = sum(CellPredictedSex==\"Female\"), \n        nCells = n()\n    )\n\n# A tibble: 8 × 4\n  Sample                      nMale nFemale nCells\n  &lt;chr&gt;                       &lt;int&gt;   &lt;int&gt;  &lt;int&gt;\n1 P101_Tumor_W00_2.5mgIpi_RNA   617     102    719\n2 P101_Tumor_W12_2.5mgIpi_RNA  2301      95   2397\n3 P101_Tumor_W20_2.5mgIpi_RNA   990      30   1020\n4 P103_Tumor_W00_2.5mgIpi_RNA  3313     259   3572\n5 P103_Tumor_W12_2.5mgIpi_RNA  3503     194   3697\n6 P103_Tumor_W20_2.5mgIpi_RNA  3204     176   3380\n7 P104_Tumor_PD_2.5mgIpi_RNA     64    2289   2353\n8 P108_Tumor_PD_5mgIpi_RNA     2600     235   2838\n\n# Now determine sex per sample and count matching vs non-matching labels\nrownames_to_column(merged.18279.tumor.singlets@meta.data,var=\"bc\") %&gt;%\n    as_tibble() %&gt;%\n    dplyr::select(bc,CellPredictedSex,Sample) %&gt;%\n    group_by(Sample) %&gt;%\n    summarize(nMale = sum(CellPredictedSex==\"Male\"), \n        nFemale = sum(CellPredictedSex==\"Female\"), \n        nCells = n()\n    ) %&gt;%\n    ungroup() %&gt;%\n    mutate(PredictedSex = case_when(\n        nMale / nCells &gt; 0.8 ~ \"Male\",\n        nFemale / nCells &gt; 0.8 ~ \"Female\",\n        T ~ \"other\"\n        )\n    ) %&gt;%\n    inner_join(knownSex,by=\"Sample\") %&gt;%\n    summarize(nEqual = sum(PredictedSex==Sex), nNotEqual = sum(PredictedSex != Sex))\n\n# A tibble: 1 × 2\n  nEqual nNotEqual\n   &lt;int&gt;     &lt;int&gt;\n1      8         0",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Tumor: Check patient sexes</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part3.html#since-everything-matches-we-now-add-sex-as-a-metadata-label",
    "href": "Tumor_scRNA_Part3.html#since-everything-matches-we-now-add-sex-as-a-metadata-label",
    "title": "3  Tumor: Check patient sexes",
    "section": "3.6 Since everything matches we now add Sex as a metadata label",
    "text": "3.6 Since everything matches we now add Sex as a metadata label\n\nknownSexByCell &lt;- enframe(merged.18279.tumor.singlets$Sample,name=\"bc\",value=\"Sample\") %&gt;% \n    inner_join(knownSex,by=\"Sample\") %&gt;% \n    pull(Sex)\n    \nmerged.18279.tumor.singlets &lt;- AddMetaData(merged.18279.tumor.singlets,knownSexByCell,col.name=\"Sex\")",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Tumor: Check patient sexes</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part3.html#plot-umap-of-sex",
    "href": "Tumor_scRNA_Part3.html#plot-umap-of-sex",
    "title": "3  Tumor: Check patient sexes",
    "section": "3.7 Plot UMAP of sex",
    "text": "3.7 Plot UMAP of sex\n\nDimPlot(merged.18279.tumor.singlets,reduction = \"umap.harmony\", group.by = \"Sex\")",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Tumor: Check patient sexes</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part3.html#save-the-updated-object",
    "href": "Tumor_scRNA_Part3.html#save-the-updated-object",
    "title": "3  Tumor: Check patient sexes",
    "section": "3.8 Save the updated object",
    "text": "3.8 Save the updated object\n\nsaveRDS(merged.18279.tumor.singlets,file=\"Tumor_scRNA_Part3.rds\")",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Tumor: Check patient sexes</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part3.html#get-session-info",
    "href": "Tumor_scRNA_Part3.html#get-session-info",
    "title": "3  Tumor: Check patient sexes",
    "section": "3.9 Get session info",
    "text": "3.9 Get session info\n\nsessionInfo()\n\nR version 4.3.2 (2023-10-31)\nPlatform: x86_64-pc-linux-gnu (64-bit)\nRunning under: Rocky Linux 8.10 (Green Obsidian)\n\nMatrix products: default\nBLAS/LAPACK: /usr/lib64/libopenblasp-r0.3.15.so;  LAPACK version 3.9.0\n\nlocale:\n [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              \n [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    \n [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   \n [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 \n [9] LC_ADDRESS=C               LC_TELEPHONE=C            \n[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       \n\ntime zone: America/New_York\ntzcode source: system (glibc)\n\nattached base packages:\n[1] stats4    stats     graphics  grDevices utils     datasets  methods  \n[8] base     \n\nother attached packages:\n [1] cellXY_0.99.0               scDblFinder_1.14.0         \n [3] harmony_1.2.0               alevinQC_1.16.1            \n [5] vctrs_0.6.5                 patchwork_1.3.0            \n [7] scater_1.30.1               scuttle_1.12.0             \n [9] speckle_1.0.0               Matrix_1.6-4               \n[11] fishpond_2.6.2              readxl_1.4.3               \n[13] SingleCellExperiment_1.24.0 SummarizedExperiment_1.32.0\n[15] Biobase_2.62.0              GenomicRanges_1.54.1       \n[17] GenomeInfoDb_1.38.8         IRanges_2.36.0             \n[19] S4Vectors_0.40.2            BiocGenerics_0.48.1        \n[21] MatrixGenerics_1.14.0       matrixStats_1.4.1          \n[23] flexmix_2.3-19              lattice_0.22-6             \n[25] SeuratWrappers_0.3.19       miQC_1.8.0                 \n[27] lubridate_1.9.3             forcats_1.0.0              \n[29] stringr_1.5.1               dplyr_1.1.4                \n[31] purrr_1.0.2                 readr_2.1.5                \n[33] tidyr_1.3.1                 tibble_3.2.1               \n[35] ggplot2_3.5.1               tidyverse_2.0.0            \n[37] Seurat_5.1.0                SeuratObject_5.0.2         \n[39] sp_2.1-4                    sctransform_0.4.1          \n[41] glmGamPoi_1.12.2            presto_1.0.0               \n[43] Rcpp_1.0.13-1               devtools_2.4.5             \n[45] usethis_3.0.0               data.table_1.16.2          \n\nloaded via a namespace (and not attached):\n  [1] fs_1.6.5                  spatstat.sparse_3.1-0    \n  [3] bitops_1.0-9              httr_1.4.7               \n  [5] RColorBrewer_1.1-3        profvis_0.4.0            \n  [7] tools_4.3.2               utf8_1.2.4               \n  [9] R6_2.5.1                  DT_0.33                  \n [11] lazyeval_0.2.2            uwot_0.2.2               \n [13] urlchecker_1.0.1          withr_3.0.2              \n [15] GGally_2.2.1              gridExtra_2.3            \n [17] progressr_0.15.1          cli_3.6.3                \n [19] spatstat.explore_3.2-6    fastDummies_1.7.3        \n [21] labeling_0.4.3            spatstat.data_3.1-4      \n [23] ggridges_0.5.6            pbapply_1.7-2            \n [25] Rsamtools_2.18.0          R.utils_2.12.3           \n [27] parallelly_1.39.0         sessioninfo_1.2.2        \n [29] limma_3.58.1              RSQLite_2.3.8            \n [31] BiocIO_1.12.0             generics_0.1.3           \n [33] gtools_3.9.5              ica_1.0-3                \n [35] spatstat.random_3.2-2     ggbeeswarm_0.7.2         \n [37] fansi_1.0.6               abind_1.4-8              \n [39] R.methodsS3_1.8.2         lifecycle_1.0.4          \n [41] yaml_2.3.10               edgeR_4.0.16             \n [43] recipes_1.1.0             SparseArray_1.2.2        \n [45] Rtsne_0.17                blob_1.2.4               \n [47] grid_4.3.2                dqrng_0.4.1              \n [49] promises_1.3.0            crayon_1.5.3             \n [51] shinydashboard_0.7.2      miniUI_0.1.1.1           \n [53] beachmat_2.18.1           cowplot_1.1.3            \n [55] KEGGREST_1.42.0           metapod_1.10.1           \n [57] pillar_1.9.0              knitr_1.45               \n [59] rjson_0.2.23              xgboost_1.7.8.1          \n [61] future.apply_1.11.3       codetools_0.2-20         \n [63] leiden_0.4.3.1            glue_1.8.0               \n [65] remotes_2.5.0             png_0.1-8                \n [67] spam_2.11-0               org.Mm.eg.db_3.18.0      \n [69] cellranger_1.1.0          gtable_0.3.6             \n [71] cachem_1.1.0              gower_1.0.1              \n [73] xfun_0.49                 prodlim_2024.06.25       \n [75] S4Arrays_1.2.0            mime_0.12                \n [77] survival_3.7-0            timeDate_4041.110        \n [79] iterators_1.0.14          hardhat_1.4.0            \n [81] lava_1.8.0                bluster_1.12.0           \n [83] statmod_1.5.0             ellipsis_0.3.2           \n [85] fitdistrplus_1.2-1        ipred_0.9-15             \n [87] ROCR_1.0-11               nlme_3.1-166             \n [89] bit64_4.5.2               RcppAnnoy_0.0.22         \n [91] irlba_2.3.5.1             rpart_4.1.23             \n [93] vipor_0.4.7               KernSmooth_2.23-24       \n [95] DBI_1.2.3                 colorspace_2.1-1         \n [97] nnet_7.3-19               tidyselect_1.2.1         \n [99] bit_4.5.0                 compiler_4.3.2           \n[101] BiocNeighbors_1.20.2      DelayedArray_0.28.0      \n[103] plotly_4.10.4             rtracklayer_1.62.0       \n[105] scales_1.3.0              lmtest_0.9-40            \n[107] digest_0.6.37             goftest_1.2-3            \n[109] spatstat.utils_3.1-1      rmarkdown_2.29           \n[111] XVector_0.42.0            htmltools_0.5.8.1        \n[113] pkgconfig_2.0.3           sparseMatrixStats_1.14.0 \n[115] fastmap_1.2.0             rlang_1.1.4              \n[117] htmlwidgets_1.6.4         shiny_1.9.1              \n[119] DelayedMatrixStats_1.24.0 farver_2.1.2             \n[121] zoo_1.8-12                jsonlite_1.8.9           \n[123] BiocParallel_1.36.0       ModelMetrics_1.2.2.2     \n[125] R.oo_1.27.0               BiocSingular_1.18.0      \n[127] RCurl_1.98-1.16           magrittr_2.0.3           \n[129] modeltools_0.2-23         GenomeInfoDbData_1.2.11  \n[131] dotCall64_1.2             munsell_0.5.1            \n[133] viridis_0.6.5             reticulate_1.35.0        \n[135] pROC_1.18.5               stringi_1.8.4            \n[137] zlibbioc_1.48.2           MASS_7.3-60.0.1          \n[139] org.Hs.eg.db_3.18.0       plyr_1.8.9               \n[141] pkgbuild_1.4.5            ggstats_0.7.0            \n[143] parallel_4.3.2            listenv_0.9.1            \n[145] ggrepel_0.9.6             deldir_2.0-4             \n[147] Biostrings_2.70.3         splines_4.3.2            \n[149] tensor_1.5                hms_1.1.3                \n[151] locfit_1.5-9.10           igraph_2.1.1             \n[153] spatstat.geom_3.2-8       RcppHNSW_0.6.0           \n[155] reshape2_1.4.4            ScaledMatrix_1.10.0      \n[157] pkgload_1.4.0             XML_3.99-0.17            \n[159] evaluate_1.0.1            scran_1.30.2             \n[161] BiocManager_1.30.25       foreach_1.5.2            \n[163] tzdb_0.4.0                httpuv_1.6.15            \n[165] RANN_2.6.2                polyclip_1.10-7          \n[167] future_1.34.0             scattermore_1.2          \n[169] rsvd_1.0.5                xtable_1.8-4             \n[171] restfulr_0.0.15           svMisc_1.2.3             \n[173] RSpectra_0.16-2           later_1.3.2              \n[175] class_7.3-22              viridisLite_0.4.2        \n[177] AnnotationDbi_1.64.1      GenomicAlignments_1.38.2 \n[179] memoise_2.0.1             beeswarm_0.4.0           \n[181] tximport_1.28.0           cluster_2.1.6            \n[183] timechange_0.3.0          globals_0.16.3           \n[185] caret_6.0-94",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Tumor: Check patient sexes</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part4.html",
    "href": "Tumor_scRNA_Part4.html",
    "title": "4  Tumor: Post-clustering QC and characterization",
    "section": "",
    "text": "4.1 Set up Seurat workspace\n# Load libraries\nlibrary(data.table)\nlibrary(devtools)\nlibrary(presto)\nlibrary(glmGamPoi)\nlibrary(sctransform)\nlibrary(Seurat)\nlibrary(tidyverse)\nlibrary(miQC)   \nlibrary(SeuratWrappers)\nlibrary(flexmix)\nlibrary(SingleCellExperiment)\nlibrary(SummarizedExperiment)\nlibrary(readxl)\nlibrary(fishpond)\nlibrary(Matrix)\nlibrary(speckle)\nlibrary(scater)\nlibrary(patchwork)\nlibrary(vctrs)\nlibrary(alevinQC)\nlibrary(harmony)\nlibrary(scDblFinder)\nlibrary(cellXY)\n\n# Set global options for Seurat v5 objects\noptions(Seurat.object.assay.version = 'v5')",
    "crumbs": [
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Tumor: Post-clustering QC and characterization</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part4.html#load-previously-saved-clustered-object",
    "href": "Tumor_scRNA_Part4.html#load-previously-saved-clustered-object",
    "title": "4  Tumor: Post-clustering QC and characterization",
    "section": "4.2 Load previously saved clustered object",
    "text": "4.2 Load previously saved clustered object\n\nmerged.18279.tumor.singlets &lt;- readRDS(\"Tumor_scRNA_Part3.rds\")",
    "crumbs": [
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Tumor: Post-clustering QC and characterization</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part4.html#set-idents-to-preferred-initial-clustering-resolution",
    "href": "Tumor_scRNA_Part4.html#set-idents-to-preferred-initial-clustering-resolution",
    "title": "4  Tumor: Post-clustering QC and characterization",
    "section": "4.3 Set idents to preferred initial clustering resolution",
    "text": "4.3 Set idents to preferred initial clustering resolution\n\nIdents(merged.18279.tumor.singlets) &lt;- merged.18279.tumor.singlets$RNA_snn_res.1\nmerged.18279.tumor.singlets$seurat_clusters &lt;- merged.18279.tumor.singlets$RNA_snn_res.1\nDimPlot(merged.18279.tumor.singlets, reduction=\"umap.harmony\", label=T)",
    "crumbs": [
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Tumor: Post-clustering QC and characterization</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part4.html#plot-qc",
    "href": "Tumor_scRNA_Part4.html#plot-qc",
    "title": "4  Tumor: Post-clustering QC and characterization",
    "section": "4.4 Plot QC",
    "text": "4.4 Plot QC\n\nVlnPlot(merged.18279.tumor.singlets, features = \"nCount_RNA\", group.by=\"seurat_clusters\",pt.size=0) + NoLegend()\n\n\n\n\n\n\n\nVlnPlot(merged.18279.tumor.singlets, features = \"nFeature_RNA\", group.by=\"seurat_clusters\",pt.size=0) + NoLegend()\n\n\n\n\n\n\n\nVlnPlot(merged.18279.tumor.singlets, features = \"percent.mt\", group.by=\"seurat_clusters\",pt.size=0) + NoLegend()",
    "crumbs": [
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Tumor: Post-clustering QC and characterization</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part4.html#identify-cursory-marker-genes-of-each-cluster",
    "href": "Tumor_scRNA_Part4.html#identify-cursory-marker-genes-of-each-cluster",
    "title": "4  Tumor: Post-clustering QC and characterization",
    "section": "4.5 Identify cursory marker genes of each cluster",
    "text": "4.5 Identify cursory marker genes of each cluster\nNote layers were already joined in previous session\n\nDefaultAssay(merged.18279.tumor.singlets) &lt;- \"RNA\"\n\nvargenes &lt;- presto::wilcoxauc(merged.18279.tumor.singlets, 'seurat_clusters', seurat_assay = 'RNA')\ntop_vargenes &lt;- top_markers(vargenes, n = 100, auc_min = 0.5, pct_in_min = 50, pct_out_max = 50)\ntop_vargenes\n\n# A tibble: 100 × 31\n    rank `0`   `1`   `10`  `11`  `12`  `13`  `14`  `15`  `16`  `17`  `18`  `19` \n   &lt;int&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;\n 1     1 MLANA CCL5  COL1… CRYAB GZMK  MZB1  PTTG1 IFI30 IL32  MS4A1 NKG7  CALD1\n 2     2 EDNRB NKG7  COL3… SERP… CD3E  DERL3 TYMS  TYRO… LTB   BANK1 CTSW  IGFB…\n 3     3 TYR   CST7  COL1… BANCR CD3D  JCHA… NUCK… LYZ   FOXP3 CD79A TYRO… COL1…\n 4     4 CRTA… CD8A  COL6… IFI27 CST7  XBP1  CENPF ENSG… SPOC… CD37  CD247 MYL9 \n 5     5 MITF  DUSP2 COL6… ANGP… IL32  IGHG1 UBE2C CST3  CD3E  HLA-… GNLY  TAGLN\n 6     6 TYRP1 IL32  DCN   F2R   DUSP2 ENSG… CKS1B PLAUR CTLA4 CD83  CD7   NOTC…\n 7     7 GPNMB CD3E  COL6… WARS1 CD2   CD79A BIRC5 FCER… TIGIT HLA-… PRF1  LHFP…\n 8     8 APOE  LAG3  C1S   ST3G… RGS1  IGHGP HMGN2 SPI1  CORO… HLA-… GZMA  COL4…\n 9     9 GMPR  CD8B  C1R   HMCN1 LBH   IGHG2 H2AZ2 AIF1  PTPRC HLA-… FCER… COL4…\n10    10 GPM6B CD3D  VCAN  RHOB  RAC2  FKBP… MIA   TYMP  CD3D  LTB   KLRB1 NR2F2\n# ℹ 90 more rows\n# ℹ 18 more variables: `2` &lt;chr&gt;, `20` &lt;chr&gt;, `21` &lt;chr&gt;, `22` &lt;chr&gt;,\n#   `23` &lt;chr&gt;, `24` &lt;chr&gt;, `25` &lt;chr&gt;, `26` &lt;chr&gt;, `27` &lt;chr&gt;, `28` &lt;chr&gt;,\n#   `29` &lt;chr&gt;, `3` &lt;chr&gt;, `4` &lt;chr&gt;, `5` &lt;chr&gt;, `6` &lt;chr&gt;, `7` &lt;chr&gt;,\n#   `8` &lt;chr&gt;, `9` &lt;chr&gt;",
    "crumbs": [
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Tumor: Post-clustering QC and characterization</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part4.html#plot-genes-from-slide-tags-preprint",
    "href": "Tumor_scRNA_Part4.html#plot-genes-from-slide-tags-preprint",
    "title": "4  Tumor: Post-clustering QC and characterization",
    "section": "4.6 Plot genes from slide-tags preprint",
    "text": "4.6 Plot genes from slide-tags preprint\nSourced from this preprint\n\ngoi &lt;- c(\"PMEL\",\"MLANA\",\"CCL5\",\"LEF1\",\"FOXP3\",\"PAX5\",\"IGHG3\",\"KCNMA1\",\"ZNF366\",\"CUX2\",\"COL1A1\",\"PLVAP\")\nVlnPlot(merged.18279.tumor.singlets,features=goi,assay=\"RNA\",layer=\"data\",flip=T,sort=T,stack=T)",
    "crumbs": [
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Tumor: Post-clustering QC and characterization</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part4.html#plot-other-known-markers",
    "href": "Tumor_scRNA_Part4.html#plot-other-known-markers",
    "title": "4  Tumor: Post-clustering QC and characterization",
    "section": "4.7 Plot other known markers",
    "text": "4.7 Plot other known markers\nSourced from this paper\n\ntumor &lt;- c(\"DCT\",\"MLANA\",\"MITF\",\"PMEL\",\"S100A1\",\"TYR\",\"APOC1\")\nendothelial &lt;- c(\"PECAM1\",\"VWF\")\nfibroblast &lt;- c(\"COL3A1\",\"COL1A1\",\"COL1A2\",\"LUM\")\ntcell &lt;- c(\"FGFBP2\",\"KLRD1\",\"CD3E\",\"CD3D\",\"GZMB\",\"XCL2\",\"GZMH\",\"CST7\",\"GZMK\",\"GZMA\",\"IFNG\",\"GNLY\",\"CCL4\",\"NKG7\",\"CCL5\",\"CD8A\",\"CD8B\",\"CTLA4\",\"TNFRSF4\",\"BATF\",\"ITM2A\")\nmono &lt;- c(\"LYZ\",\"CD74\",\"CD68\")\nbcell &lt;- c(\"MS4A1\",\"CD79A\")\n\nVlnPlot(merged.18279.tumor.singlets,features=tumor,assay=\"RNA\",layer=\"data\",flip=T,sort=T,stack=T) +\n  VlnPlot(merged.18279.tumor.singlets,features=endothelial,assay=\"RNA\",layer=\"data\",flip=T,sort=T,stack=T) +\n  VlnPlot(merged.18279.tumor.singlets,features=fibroblast,assay=\"RNA\",layer=\"data\",flip=T,sort=T,stack=T) +\n  VlnPlot(merged.18279.tumor.singlets,features=tcell,assay=\"RNA\",layer=\"data\",flip=T,sort=T,stack=T) +\n  VlnPlot(merged.18279.tumor.singlets,features=mono,assay=\"RNA\",layer=\"data\",flip=T,sort=T,stack=T) +\n  VlnPlot(merged.18279.tumor.singlets,features=bcell,assay=\"RNA\",layer=\"data\",flip=T,sort=T,stack=T) +\n  NoLegend()",
    "crumbs": [
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Tumor: Post-clustering QC and characterization</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part4.html#plot-top-markers-identified-and-canonical-genes-as-a-dotplot",
    "href": "Tumor_scRNA_Part4.html#plot-top-markers-identified-and-canonical-genes-as-a-dotplot",
    "title": "4  Tumor: Post-clustering QC and characterization",
    "section": "4.8 Plot top markers identified and canonical genes as a dotplot",
    "text": "4.8 Plot top markers identified and canonical genes as a dotplot\n\ntop_vargenes &lt;- top_markers(vargenes, n = 5, auc_min = 0.5, pct_in_min = 50, pct_out_max = 50)\ntop_markers &lt;- top_vargenes %&gt;%\n    select(-rank) %&gt;% \n    unclass() %&gt;% \n    stack() %&gt;%\n    pull(values) %&gt;%\n    unique() %&gt;%\n    .[!is.na(.)]\n\ndotplotmarkers &lt;- unique(c(top_markers,tumor,endothelial,fibroblast,tcell,mono,bcell))\n\n# Compute aggregated expression values of these genes and cluster them to order the figure\nrna &lt;- AverageExpression(merged.18279.tumor.singlets,assay=\"RNA\",slot=\"data\")\n\nAs of Seurat v5, we recommend using AggregateExpression to perform pseudo-bulk analysis.\nFirst group.by variable `ident` starts with a number, appending `g` to ensure valid variable names\nThis message is displayed once per session.\n\nrna.sub &lt;- rna$RNA[dotplotmarkers,]\ncors.genes &lt;- as.dist(1-cor(as.matrix(t(rna.sub)),method=\"pearson\"))\nhc.genes &lt;- hclust(cors.genes)\ndotplotmarkers.sorted &lt;- rownames(rna.sub)[hc.genes$order]\n\n# Plot\nDotPlot(merged.18279.tumor.singlets,features=dotplotmarkers.sorted,assay=\"RNA\",cols=c(\"blue\",\"red\"),cluster.idents=T) + RotatedAxis()",
    "crumbs": [
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Tumor: Post-clustering QC and characterization</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part4.html#plot-expression-of-key-genes-in-umap-space",
    "href": "Tumor_scRNA_Part4.html#plot-expression-of-key-genes-in-umap-space",
    "title": "4  Tumor: Post-clustering QC and characterization",
    "section": "4.9 Plot expression of key genes in UMAP space",
    "text": "4.9 Plot expression of key genes in UMAP space\n\nFeaturePlot(merged.18279.tumor.singlets, \n    reduction=\"umap.harmony\", \n    features=c(\"CD8A\",\"CD4\",\"CTLA4\",\"KLRC1\",\"CD79A\",\"PMEL\",\"MLANA\",\"LYZ\",\"PECAM1\",\"COL3A1\",\"SFN\",\"KRT19\"),\n    order = T,\n    ncol = 2)",
    "crumbs": [
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Tumor: Post-clustering QC and characterization</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part4.html#get-session-info",
    "href": "Tumor_scRNA_Part4.html#get-session-info",
    "title": "4  Tumor: Post-clustering QC and characterization",
    "section": "4.10 Get session info",
    "text": "4.10 Get session info\n\nsessionInfo()\n\nR version 4.3.2 (2023-10-31)\nPlatform: x86_64-pc-linux-gnu (64-bit)\nRunning under: Rocky Linux 8.10 (Green Obsidian)\n\nMatrix products: default\nBLAS/LAPACK: /usr/lib64/libopenblasp-r0.3.15.so;  LAPACK version 3.9.0\n\nlocale:\n [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              \n [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    \n [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   \n [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 \n [9] LC_ADDRESS=C               LC_TELEPHONE=C            \n[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       \n\ntime zone: America/New_York\ntzcode source: system (glibc)\n\nattached base packages:\n[1] stats4    stats     graphics  grDevices utils     datasets  methods  \n[8] base     \n\nother attached packages:\n [1] cellXY_0.99.0               scDblFinder_1.14.0         \n [3] harmony_1.2.0               alevinQC_1.16.1            \n [5] vctrs_0.6.5                 patchwork_1.3.0            \n [7] scater_1.30.1               scuttle_1.12.0             \n [9] speckle_1.0.0               Matrix_1.6-4               \n[11] fishpond_2.6.2              readxl_1.4.3               \n[13] SingleCellExperiment_1.24.0 SummarizedExperiment_1.32.0\n[15] Biobase_2.62.0              GenomicRanges_1.54.1       \n[17] GenomeInfoDb_1.38.8         IRanges_2.36.0             \n[19] S4Vectors_0.40.2            BiocGenerics_0.48.1        \n[21] MatrixGenerics_1.14.0       matrixStats_1.4.1          \n[23] flexmix_2.3-19              lattice_0.22-6             \n[25] SeuratWrappers_0.3.19       miQC_1.8.0                 \n[27] lubridate_1.9.3             forcats_1.0.0              \n[29] stringr_1.5.1               dplyr_1.1.4                \n[31] purrr_1.0.2                 readr_2.1.5                \n[33] tidyr_1.3.1                 tibble_3.2.1               \n[35] ggplot2_3.5.1               tidyverse_2.0.0            \n[37] Seurat_5.1.0                SeuratObject_5.0.2         \n[39] sp_2.1-4                    sctransform_0.4.1          \n[41] glmGamPoi_1.12.2            presto_1.0.0               \n[43] Rcpp_1.0.13-1               devtools_2.4.5             \n[45] usethis_3.0.0               data.table_1.16.2          \n\nloaded via a namespace (and not attached):\n  [1] fs_1.6.5                  spatstat.sparse_3.1-0    \n  [3] bitops_1.0-9              httr_1.4.7               \n  [5] RColorBrewer_1.1-3        profvis_0.4.0            \n  [7] tools_4.3.2               utf8_1.2.4               \n  [9] R6_2.5.1                  DT_0.33                  \n [11] lazyeval_0.2.2            uwot_0.2.2               \n [13] urlchecker_1.0.1          withr_3.0.2              \n [15] GGally_2.2.1              gridExtra_2.3            \n [17] progressr_0.15.1          cli_3.6.3                \n [19] spatstat.explore_3.2-6    fastDummies_1.7.3        \n [21] labeling_0.4.3            spatstat.data_3.1-4      \n [23] ggridges_0.5.6            pbapply_1.7-2            \n [25] Rsamtools_2.18.0          R.utils_2.12.3           \n [27] parallelly_1.39.0         sessioninfo_1.2.2        \n [29] limma_3.58.1              RSQLite_2.3.8            \n [31] BiocIO_1.12.0             generics_0.1.3           \n [33] gtools_3.9.5              ica_1.0-3                \n [35] spatstat.random_3.2-2     ggbeeswarm_0.7.2         \n [37] fansi_1.0.6               abind_1.4-8              \n [39] R.methodsS3_1.8.2         lifecycle_1.0.4          \n [41] yaml_2.3.10               edgeR_4.0.16             \n [43] SparseArray_1.2.2         Rtsne_0.17               \n [45] blob_1.2.4                grid_4.3.2               \n [47] dqrng_0.4.1               promises_1.3.0           \n [49] crayon_1.5.3              shinydashboard_0.7.2     \n [51] miniUI_0.1.1.1            beachmat_2.18.1          \n [53] cowplot_1.1.3             KEGGREST_1.42.0          \n [55] metapod_1.10.1            pillar_1.9.0             \n [57] knitr_1.45                rjson_0.2.23             \n [59] xgboost_1.7.8.1           future.apply_1.11.3      \n [61] codetools_0.2-20          leiden_0.4.3.1           \n [63] glue_1.8.0                remotes_2.5.0            \n [65] png_0.1-8                 spam_2.11-0              \n [67] org.Mm.eg.db_3.18.0       cellranger_1.1.0         \n [69] gtable_0.3.6              cachem_1.1.0             \n [71] xfun_0.49                 S4Arrays_1.2.0           \n [73] mime_0.12                 survival_3.7-0           \n [75] bluster_1.12.0            statmod_1.5.0            \n [77] ellipsis_0.3.2            fitdistrplus_1.2-1       \n [79] ROCR_1.0-11               nlme_3.1-166             \n [81] bit64_4.5.2               RcppAnnoy_0.0.22         \n [83] irlba_2.3.5.1             vipor_0.4.7              \n [85] KernSmooth_2.23-24        DBI_1.2.3                \n [87] colorspace_2.1-1          nnet_7.3-19              \n [89] ggrastr_1.0.2             tidyselect_1.2.1         \n [91] bit_4.5.0                 compiler_4.3.2           \n [93] BiocNeighbors_1.20.2      DelayedArray_0.28.0      \n [95] plotly_4.10.4             rtracklayer_1.62.0       \n [97] scales_1.3.0              lmtest_0.9-40            \n [99] digest_0.6.37             goftest_1.2-3            \n[101] spatstat.utils_3.1-1      rmarkdown_2.29           \n[103] XVector_0.42.0            htmltools_0.5.8.1        \n[105] pkgconfig_2.0.3           sparseMatrixStats_1.14.0 \n[107] fastmap_1.2.0             rlang_1.1.4              \n[109] htmlwidgets_1.6.4         shiny_1.9.1              \n[111] DelayedMatrixStats_1.24.0 farver_2.1.2             \n[113] zoo_1.8-12                jsonlite_1.8.9           \n[115] BiocParallel_1.36.0       R.oo_1.27.0              \n[117] BiocSingular_1.18.0       RCurl_1.98-1.16          \n[119] magrittr_2.0.3            modeltools_0.2-23        \n[121] GenomeInfoDbData_1.2.11   dotCall64_1.2            \n[123] munsell_0.5.1             viridis_0.6.5            \n[125] reticulate_1.35.0         stringi_1.8.4            \n[127] zlibbioc_1.48.2           MASS_7.3-60.0.1          \n[129] org.Hs.eg.db_3.18.0       plyr_1.8.9               \n[131] pkgbuild_1.4.5            ggstats_0.7.0            \n[133] parallel_4.3.2            listenv_0.9.1            \n[135] ggrepel_0.9.6             deldir_2.0-4             \n[137] Biostrings_2.70.3         splines_4.3.2            \n[139] tensor_1.5                hms_1.1.3                \n[141] locfit_1.5-9.10           igraph_2.1.1             \n[143] spatstat.geom_3.2-8       RcppHNSW_0.6.0           \n[145] reshape2_1.4.4            ScaledMatrix_1.10.0      \n[147] pkgload_1.4.0             XML_3.99-0.17            \n[149] evaluate_1.0.1            scran_1.30.2             \n[151] BiocManager_1.30.25       tzdb_0.4.0               \n[153] httpuv_1.6.15             RANN_2.6.2               \n[155] polyclip_1.10-7           future_1.34.0            \n[157] scattermore_1.2           rsvd_1.0.5               \n[159] xtable_1.8-4              restfulr_0.0.15          \n[161] svMisc_1.2.3              RSpectra_0.16-2          \n[163] later_1.3.2               viridisLite_0.4.2        \n[165] AnnotationDbi_1.64.1      GenomicAlignments_1.38.2 \n[167] memoise_2.0.1             beeswarm_0.4.0           \n[169] tximport_1.28.0           cluster_2.1.6            \n[171] timechange_0.3.0          globals_0.16.3",
    "crumbs": [
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Tumor: Post-clustering QC and characterization</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part5.html",
    "href": "Tumor_scRNA_Part5.html",
    "title": "5  Tumor: Post-clustering comprehensive marker identification",
    "section": "",
    "text": "5.1 Set up Seurat workspace\n# Load libraries\nlibrary(data.table)\nlibrary(devtools)\nlibrary(presto) \nlibrary(glmGamPoi)\nlibrary(sctransform) \nlibrary(Seurat)\nlibrary(tidyverse)\nlibrary(miQC)\nlibrary(SeuratWrappers)\nlibrary(flexmix)\nlibrary(SingleCellExperiment)\nlibrary(SummarizedExperiment)\nlibrary(readxl)\nlibrary(fishpond)\nlibrary(Matrix)\nlibrary(speckle)\nlibrary(scater)\nlibrary(patchwork)\nlibrary(vctrs)\nlibrary(alevinQC)\nlibrary(harmony)\nlibrary(scDblFinder)\nlibrary(cellXY)\n\n# Set global options for Seurat v5 objects\noptions(Seurat.object.assay.version = 'v5')",
    "crumbs": [
      "<span class='chapter-number'>5</span>  <span class='chapter-title'>Tumor: Post-clustering comprehensive marker identification</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part5.html#load-previously-saved-clustered-object",
    "href": "Tumor_scRNA_Part5.html#load-previously-saved-clustered-object",
    "title": "5  Tumor: Post-clustering comprehensive marker identification",
    "section": "5.2 Load previously saved clustered object",
    "text": "5.2 Load previously saved clustered object\n\nmerged.18279.tumor.singlets &lt;- readRDS(\"Tumor_scRNA_Part3.rds\")",
    "crumbs": [
      "<span class='chapter-number'>5</span>  <span class='chapter-title'>Tumor: Post-clustering comprehensive marker identification</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part5.html#set-idents-to-preferred-initial-clustering-resolution",
    "href": "Tumor_scRNA_Part5.html#set-idents-to-preferred-initial-clustering-resolution",
    "title": "5  Tumor: Post-clustering comprehensive marker identification",
    "section": "5.3 Set idents to preferred initial clustering resolution",
    "text": "5.3 Set idents to preferred initial clustering resolution\n\nIdents(merged.18279.tumor.singlets) &lt;- merged.18279.tumor.singlets$RNA_snn_res.1\nmerged.18279.tumor.singlets$seurat_clusters &lt;- merged.18279.tumor.singlets$RNA_snn_res.1\nDimPlot(merged.18279.tumor.singlets, reduction=\"umap.harmony\", label=T)",
    "crumbs": [
      "<span class='chapter-number'>5</span>  <span class='chapter-title'>Tumor: Post-clustering comprehensive marker identification</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part5.html#detect-markers-with-findallmarkers",
    "href": "Tumor_scRNA_Part5.html#detect-markers-with-findallmarkers",
    "title": "5  Tumor: Post-clustering comprehensive marker identification",
    "section": "5.4 Detect markers with FindAllMarkers",
    "text": "5.4 Detect markers with FindAllMarkers\n\nfam &lt;- FindAllMarkers(merged.18279.tumor.singlets,\n                      assay = \"RNA\",\n                      slot = \"data\",\n                      only.pos = TRUE, \n                      logfc.threshold = 0.25)\n\nCalculating cluster 0\n\n\nCalculating cluster 1\n\n\nCalculating cluster 2\n\n\nCalculating cluster 3\n\n\nCalculating cluster 4\n\n\nCalculating cluster 5\n\n\nCalculating cluster 6\n\n\nCalculating cluster 7\n\n\nCalculating cluster 8\n\n\nCalculating cluster 9\n\n\nCalculating cluster 10\n\n\nCalculating cluster 11\n\n\nCalculating cluster 12\n\n\nCalculating cluster 13\n\n\nCalculating cluster 14\n\n\nCalculating cluster 15\n\n\nCalculating cluster 16\n\n\nCalculating cluster 17\n\n\nCalculating cluster 18\n\n\nCalculating cluster 19\n\n\nCalculating cluster 20\n\n\nCalculating cluster 21\n\n\nCalculating cluster 22\n\n\nCalculating cluster 23\n\n\nCalculating cluster 24\n\n\nCalculating cluster 25\n\n\nCalculating cluster 26\n\n\nCalculating cluster 27\n\n\nCalculating cluster 28\n\n\nCalculating cluster 29\n\nhead(fam)\n\n       p_val avg_log2FC pct.1 pct.2 p_val_adj cluster   gene\nMLANA      0   2.677685 0.987 0.188         0       0  MLANA\nTYR        0   2.774154 0.890 0.133         0       0    TYR\nCRTAC1     0   3.071840 0.885 0.159         0       0 CRTAC1\nGMPR       0   2.846998 0.803 0.130         0       0   GMPR\nEDNRB      0   2.901282 0.909 0.245         0       0  EDNRB\nGPM6B      0   2.149432 0.868 0.220         0       0  GPM6B",
    "crumbs": [
      "<span class='chapter-number'>5</span>  <span class='chapter-title'>Tumor: Post-clustering comprehensive marker identification</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part5.html#plot-top-markers-per-cluster-as-dotplot",
    "href": "Tumor_scRNA_Part5.html#plot-top-markers-per-cluster-as-dotplot",
    "title": "5  Tumor: Post-clustering comprehensive marker identification",
    "section": "5.5 Plot top markers per cluster as dotplot",
    "text": "5.5 Plot top markers per cluster as dotplot\n\nfam_top &lt;- fam %&gt;%\n    mutate(diff = pct.1 - pct.2) %&gt;%\n    dplyr::filter(pct.1 &gt; 0.25 & diff &gt; 0.1 & pct.2 &lt; 0.1 & p_val_adj &lt; 0.01) %&gt;%\n    group_by(cluster) %&gt;%\n    slice_head(n=10) %&gt;%\n    pull(gene) %&gt;%\n    unique()\n\n# Compute aggregated expression values of these genes and cluster them to order the figure\nrna &lt;- AverageExpression(merged.18279.tumor.singlets,assay=\"RNA\",slot=\"data\")\n\nAs of Seurat v5, we recommend using AggregateExpression to perform pseudo-bulk analysis.\nFirst group.by variable `ident` starts with a number, appending `g` to ensure valid variable names\nThis message is displayed once per session.\n\nrna.sub &lt;- rna$RNA[fam_top,]\ncors.genes &lt;- as.dist(1-cor(as.matrix(t(rna.sub)),method=\"pearson\"))\nhc.genes &lt;- hclust(cors.genes)\nfam_top.sorted &lt;- rownames(rna.sub)[hc.genes$order]\n\n# Plot\nDotPlot(merged.18279.tumor.singlets,\n        features = fam_top.sorted,\n        assay = \"RNA\",\n        cols=c(\"blue\",\"red\"),\n        cluster.idents=T) + \n  RotatedAxis()",
    "crumbs": [
      "<span class='chapter-number'>5</span>  <span class='chapter-title'>Tumor: Post-clustering comprehensive marker identification</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part5.html#subset-to-tnk-lineage-and-compute-markers-just-among-these-clusters",
    "href": "Tumor_scRNA_Part5.html#subset-to-tnk-lineage-and-compute-markers-just-among-these-clusters",
    "title": "5  Tumor: Post-clustering comprehensive marker identification",
    "section": "5.6 Subset to T/NK lineage and compute markers just among these clusters",
    "text": "5.6 Subset to T/NK lineage and compute markers just among these clusters\n\nmerged.18279.tumor.singlets.tnk &lt;- subset(merged.18279.tumor.singlets,\n                                    subset = seurat_clusters %in% c(1,2,3,9,12,16,18,22,26))\nfam.tnk &lt;- FindAllMarkers(merged.18279.tumor.singlets.tnk,\n                      assay=\"RNA\",\n                      slot=\"data\",\n                      only.pos = TRUE, \n                      logfc.threshold = 0.25)\n\nCalculating cluster 1\n\n\nCalculating cluster 2\n\n\nCalculating cluster 3\n\n\nCalculating cluster 9\n\n\nCalculating cluster 12\n\n\nCalculating cluster 16\n\n\nCalculating cluster 18\n\n\nCalculating cluster 22\n\n\nCalculating cluster 26\n\nhead(fam.tnk)\n\n     p_val avg_log2FC pct.1 pct.2 p_val_adj cluster gene\nCD8A     0   1.537452 0.919 0.422         0       1 CD8A\nNKG7     0   1.589511 0.968 0.532         0       1 NKG7\nLAG3     0   1.458118 0.833 0.412         0       1 LAG3\nCCL4     0   1.602297 0.845 0.434         0       1 CCL4\nCST7     0   1.033193 0.969 0.693         0       1 CST7\nCCL5     0   1.427897 0.994 0.721         0       1 CCL5",
    "crumbs": [
      "<span class='chapter-number'>5</span>  <span class='chapter-title'>Tumor: Post-clustering comprehensive marker identification</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part5.html#plot-top-markers-per-cluster-as-dotplot-1",
    "href": "Tumor_scRNA_Part5.html#plot-top-markers-per-cluster-as-dotplot-1",
    "title": "5  Tumor: Post-clustering comprehensive marker identification",
    "section": "5.7 Plot top markers per cluster as dotplot",
    "text": "5.7 Plot top markers per cluster as dotplot\n\nfam.tnk_top &lt;- fam.tnk %&gt;%\n    mutate(diff = pct.1 - pct.2) %&gt;%\n    dplyr::filter(pct.1 &gt; 0.25 & diff &gt; 0.1 & pct.2 &lt; 0.1 & p_val_adj &lt; 0.01) %&gt;%\n    group_by(cluster) %&gt;%\n    slice_head(n=10) %&gt;%\n    pull(gene) %&gt;%\n    unique()\n\n# Compute aggregated expression values of these genes and cluster them to order the figure\nrna &lt;- AverageExpression(merged.18279.tumor.singlets,assay=\"RNA\",slot=\"data\")\nrna.sub &lt;- rna$RNA[fam.tnk_top,]\ncors.genes &lt;- as.dist(1-cor(as.matrix(t(rna.sub)),method=\"pearson\"))\nhc.genes &lt;- hclust(cors.genes)\nfam.tnk_top.sorted &lt;- rownames(rna.sub)[hc.genes$order]\n\n# Plot\nDotPlot(merged.18279.tumor.singlets,\n        features = fam.tnk_top.sorted,\n        assay = \"RNA\",\n        cols=c(\"blue\",\"red\"),\n        cluster.idents=T) + \n  RotatedAxis()",
    "crumbs": [
      "<span class='chapter-number'>5</span>  <span class='chapter-title'>Tumor: Post-clustering comprehensive marker identification</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part5.html#get-sessioninfo",
    "href": "Tumor_scRNA_Part5.html#get-sessioninfo",
    "title": "5  Tumor: Post-clustering comprehensive marker identification",
    "section": "5.8 Get sessionInfo",
    "text": "5.8 Get sessionInfo\n\nsessionInfo()\n\nR version 4.3.2 (2023-10-31)\nPlatform: x86_64-pc-linux-gnu (64-bit)\nRunning under: Rocky Linux 8.10 (Green Obsidian)\n\nMatrix products: default\nBLAS/LAPACK: /usr/lib64/libopenblasp-r0.3.15.so;  LAPACK version 3.9.0\n\nlocale:\n [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              \n [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    \n [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   \n [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 \n [9] LC_ADDRESS=C               LC_TELEPHONE=C            \n[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       \n\ntime zone: America/New_York\ntzcode source: system (glibc)\n\nattached base packages:\n[1] stats4    stats     graphics  grDevices utils     datasets  methods  \n[8] base     \n\nother attached packages:\n [1] cellXY_0.99.0               scDblFinder_1.14.0         \n [3] harmony_1.2.0               alevinQC_1.16.1            \n [5] vctrs_0.6.5                 patchwork_1.3.0            \n [7] scater_1.30.1               scuttle_1.12.0             \n [9] speckle_1.0.0               Matrix_1.6-4               \n[11] fishpond_2.6.2              readxl_1.4.3               \n[13] SingleCellExperiment_1.24.0 SummarizedExperiment_1.32.0\n[15] Biobase_2.62.0              GenomicRanges_1.54.1       \n[17] GenomeInfoDb_1.38.8         IRanges_2.36.0             \n[19] S4Vectors_0.40.2            BiocGenerics_0.48.1        \n[21] MatrixGenerics_1.14.0       matrixStats_1.4.1          \n[23] flexmix_2.3-19              lattice_0.22-6             \n[25] SeuratWrappers_0.3.19       miQC_1.8.0                 \n[27] lubridate_1.9.3             forcats_1.0.0              \n[29] stringr_1.5.1               dplyr_1.1.4                \n[31] purrr_1.0.2                 readr_2.1.5                \n[33] tidyr_1.3.1                 tibble_3.2.1               \n[35] ggplot2_3.5.1               tidyverse_2.0.0            \n[37] Seurat_5.1.0                SeuratObject_5.0.2         \n[39] sp_2.1-4                    sctransform_0.4.1          \n[41] glmGamPoi_1.12.2            presto_1.0.0               \n[43] Rcpp_1.0.13-1               devtools_2.4.5             \n[45] usethis_3.0.0               data.table_1.16.2          \n\nloaded via a namespace (and not attached):\n  [1] fs_1.6.5                  spatstat.sparse_3.1-0    \n  [3] bitops_1.0-9              httr_1.4.7               \n  [5] RColorBrewer_1.1-3        profvis_0.4.0            \n  [7] tools_4.3.2               utf8_1.2.4               \n  [9] R6_2.5.1                  DT_0.33                  \n [11] lazyeval_0.2.2            uwot_0.2.2               \n [13] urlchecker_1.0.1          withr_3.0.2              \n [15] GGally_2.2.1              gridExtra_2.3            \n [17] progressr_0.15.1          cli_3.6.3                \n [19] spatstat.explore_3.2-6    fastDummies_1.7.3        \n [21] labeling_0.4.3            spatstat.data_3.1-4      \n [23] ggridges_0.5.6            pbapply_1.7-2            \n [25] Rsamtools_2.18.0          R.utils_2.12.3           \n [27] parallelly_1.39.0         sessioninfo_1.2.2        \n [29] limma_3.58.1              RSQLite_2.3.8            \n [31] BiocIO_1.12.0             generics_0.1.3           \n [33] gtools_3.9.5              ica_1.0-3                \n [35] spatstat.random_3.2-2     ggbeeswarm_0.7.2         \n [37] fansi_1.0.6               abind_1.4-8              \n [39] R.methodsS3_1.8.2         lifecycle_1.0.4          \n [41] yaml_2.3.10               edgeR_4.0.16             \n [43] SparseArray_1.2.2         Rtsne_0.17               \n [45] blob_1.2.4                grid_4.3.2               \n [47] dqrng_0.4.1               promises_1.3.0           \n [49] crayon_1.5.3              shinydashboard_0.7.2     \n [51] miniUI_0.1.1.1            beachmat_2.18.1          \n [53] cowplot_1.1.3             KEGGREST_1.42.0          \n [55] metapod_1.10.1            pillar_1.9.0             \n [57] knitr_1.45                rjson_0.2.23             \n [59] xgboost_1.7.8.1           future.apply_1.11.3      \n [61] codetools_0.2-20          leiden_0.4.3.1           \n [63] glue_1.8.0                remotes_2.5.0            \n [65] png_0.1-8                 spam_2.11-0              \n [67] org.Mm.eg.db_3.18.0       cellranger_1.1.0         \n [69] gtable_0.3.6              cachem_1.1.0             \n [71] xfun_0.49                 S4Arrays_1.2.0           \n [73] mime_0.12                 survival_3.7-0           \n [75] bluster_1.12.0            statmod_1.5.0            \n [77] ellipsis_0.3.2            fitdistrplus_1.2-1       \n [79] ROCR_1.0-11               nlme_3.1-166             \n [81] bit64_4.5.2               RcppAnnoy_0.0.22         \n [83] irlba_2.3.5.1             vipor_0.4.7              \n [85] KernSmooth_2.23-24        DBI_1.2.3                \n [87] colorspace_2.1-1          nnet_7.3-19              \n [89] tidyselect_1.2.1          bit_4.5.0                \n [91] compiler_4.3.2            BiocNeighbors_1.20.2     \n [93] DelayedArray_0.28.0       plotly_4.10.4            \n [95] rtracklayer_1.62.0        scales_1.3.0             \n [97] lmtest_0.9-40             digest_0.6.37            \n [99] goftest_1.2-3             spatstat.utils_3.1-1     \n[101] rmarkdown_2.29            XVector_0.42.0           \n[103] htmltools_0.5.8.1         pkgconfig_2.0.3          \n[105] sparseMatrixStats_1.14.0  fastmap_1.2.0            \n[107] rlang_1.1.4               htmlwidgets_1.6.4        \n[109] shiny_1.9.1               DelayedMatrixStats_1.24.0\n[111] farver_2.1.2              zoo_1.8-12               \n[113] jsonlite_1.8.9            BiocParallel_1.36.0      \n[115] R.oo_1.27.0               BiocSingular_1.18.0      \n[117] RCurl_1.98-1.16           magrittr_2.0.3           \n[119] modeltools_0.2-23         GenomeInfoDbData_1.2.11  \n[121] dotCall64_1.2             munsell_0.5.1            \n[123] viridis_0.6.5             reticulate_1.35.0        \n[125] stringi_1.8.4             zlibbioc_1.48.2          \n[127] MASS_7.3-60.0.1           org.Hs.eg.db_3.18.0      \n[129] plyr_1.8.9                pkgbuild_1.4.5           \n[131] ggstats_0.7.0             parallel_4.3.2           \n[133] listenv_0.9.1             ggrepel_0.9.6            \n[135] deldir_2.0-4              Biostrings_2.70.3        \n[137] splines_4.3.2             tensor_1.5               \n[139] hms_1.1.3                 locfit_1.5-9.10          \n[141] igraph_2.1.1              spatstat.geom_3.2-8      \n[143] RcppHNSW_0.6.0            reshape2_1.4.4           \n[145] ScaledMatrix_1.10.0       pkgload_1.4.0            \n[147] XML_3.99-0.17             evaluate_1.0.1           \n[149] scran_1.30.2              BiocManager_1.30.25      \n[151] tzdb_0.4.0                httpuv_1.6.15            \n[153] RANN_2.6.2                polyclip_1.10-7          \n[155] future_1.34.0             scattermore_1.2          \n[157] rsvd_1.0.5                xtable_1.8-4             \n[159] restfulr_0.0.15           svMisc_1.2.3             \n[161] RSpectra_0.16-2           later_1.3.2              \n[163] viridisLite_0.4.2         AnnotationDbi_1.64.1     \n[165] GenomicAlignments_1.38.2  memoise_2.0.1            \n[167] beeswarm_0.4.0            tximport_1.28.0          \n[169] cluster_2.1.6             timechange_0.3.0         \n[171] globals_0.16.3",
    "crumbs": [
      "<span class='chapter-number'>5</span>  <span class='chapter-title'>Tumor: Post-clustering comprehensive marker identification</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part6.html",
    "href": "Tumor_scRNA_Part6.html",
    "title": "6  Tumor: Sub-clustering on T/NK lineage",
    "section": "",
    "text": "6.1 Set up Seurat workspace\n# Load libraries\nlibrary(data.table)\nlibrary(devtools)\nlibrary(presto)\nlibrary(glmGamPoi)\nlibrary(sctransform)\nlibrary(Seurat) \nlibrary(tidyverse)\nlibrary(miQC)\nlibrary(SeuratWrappers)\nlibrary(flexmix)\nlibrary(SingleCellExperiment)\nlibrary(SummarizedExperiment)\nlibrary(readxl)\nlibrary(fishpond)\nlibrary(Matrix)\nlibrary(speckle)\nlibrary(scater)\nlibrary(patchwork)\nlibrary(vctrs)\nlibrary(alevinQC)\nlibrary(harmony)\nlibrary(scDblFinder)\nlibrary(cellXY)\n\n# Set global options for Seurat v5 objects\noptions(Seurat.object.assay.version = 'v5')",
    "crumbs": [
      "<span class='chapter-number'>6</span>  <span class='chapter-title'>Tumor: Sub-clustering on T/NK lineage</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part6.html#load-previously-saved-clustered-object",
    "href": "Tumor_scRNA_Part6.html#load-previously-saved-clustered-object",
    "title": "6  Tumor: Sub-clustering on T/NK lineage",
    "section": "6.2 Load previously saved clustered object",
    "text": "6.2 Load previously saved clustered object\n\nmerged.18279.tumor.singlets &lt;- readRDS(\"Tumor_scRNA_Part3.rds\")",
    "crumbs": [
      "<span class='chapter-number'>6</span>  <span class='chapter-title'>Tumor: Sub-clustering on T/NK lineage</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part6.html#set-idents-to-preferred-initial-clustering-resolution",
    "href": "Tumor_scRNA_Part6.html#set-idents-to-preferred-initial-clustering-resolution",
    "title": "6  Tumor: Sub-clustering on T/NK lineage",
    "section": "6.3 Set idents to preferred initial clustering resolution",
    "text": "6.3 Set idents to preferred initial clustering resolution\n\nIdents(merged.18279.tumor.singlets) &lt;- merged.18279.tumor.singlets$RNA_snn_res.1\nmerged.18279.tumor.singlets$seurat_clusters &lt;- merged.18279.tumor.singlets$RNA_snn_res.1\nDimPlot(merged.18279.tumor.singlets, reduction=\"umap.harmony\", label=T)",
    "crumbs": [
      "<span class='chapter-number'>6</span>  <span class='chapter-title'>Tumor: Sub-clustering on T/NK lineage</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part6.html#run-sub-clustering-on-tnk-lineage",
    "href": "Tumor_scRNA_Part6.html#run-sub-clustering-on-tnk-lineage",
    "title": "6  Tumor: Sub-clustering on T/NK lineage",
    "section": "6.4 Run sub-clustering on T/NK lineage",
    "text": "6.4 Run sub-clustering on T/NK lineage\nT/NK cells are in clusters 1,2,3,9,12,16,18,22,26\n\n6.4.1 Cluster 1\n\nmerged.18279.tumor.singlets &lt;- FindSubCluster(object = merged.18279.tumor.singlets, \n                                        cluster = \"1\",\n                                        resolution = 0.2,\n                                        graph.name = \"RNA_snn\",  \n                                        algorithm = 2)\n\nModularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck\n\nNumber of nodes: 2832\nNumber of edges: 96284\n\nRunning Louvain algorithm with multilevel refinement...\nMaximum modularity in 10 random starts: 0.8058\nNumber of communities: 2\nElapsed time: 0 seconds\n\nDimPlot(merged.18279.tumor.singlets,  \n        reduction = \"umap.harmony\",  \n        group.by = \"sub.cluster\", \n        label = TRUE)\n\n\n\n\n\n\n\ntable(merged.18279.tumor.singlets$sub.cluster)\n\n\n   0  1_0  1_1   10   11   12   13   14   15   16   17   18   19    2   20   21 \n3244 2596  236  671  645  601  469  449  370  364  336  273  265 1338  249  228 \n  22   23   24   25   26   27   28   29    3    4    5    6    7    8    9 \n 201  113   77   74   55   33   30   27 1214 1171 1151  955  934  849  758 \n\nIdents(merged.18279.tumor.singlets) &lt;- \"sub.cluster\"\nlevels(merged.18279.tumor.singlets)\n\n [1] \"8\"   \"10\"  \"7\"   \"5\"   \"14\"  \"6\"   \"27\"  \"20\"  \"15\"  \"19\"  \"11\"  \"4\"  \n[13] \"26\"  \"1_1\" \"3\"   \"1_0\" \"9\"   \"2\"   \"18\"  \"16\"  \"22\"  \"12\"  \"24\"  \"0\"  \n[25] \"13\"  \"28\"  \"21\"  \"17\"  \"29\"  \"25\"  \"23\" \n\n\n\n\n6.4.2 Cluster 2\n\nmerged.18279.tumor.singlets &lt;- FindSubCluster(object = merged.18279.tumor.singlets, \n                                        cluster = \"2\",\n                                        resolution = 0.2,\n                                        graph.name = \"RNA_snn\",  \n                                        algorithm = 2)\n\nModularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck\n\nNumber of nodes: 1338\nNumber of edges: 50191\n\nRunning Louvain algorithm with multilevel refinement...\nMaximum modularity in 10 random starts: 0.8124\nNumber of communities: 2\nElapsed time: 0 seconds\n\nDimPlot(merged.18279.tumor.singlets,  \n        reduction = \"umap.harmony\",  \n        group.by = \"sub.cluster\", \n        label = TRUE)\n\n\n\n\n\n\n\ntable(merged.18279.tumor.singlets$sub.cluster)\n\n\n   0  1_0  1_1   10   11   12   13   14   15   16   17   18   19  2_0  2_1   20 \n3244 2596  236  671  645  601  469  449  370  364  336  273  265 1142  196  249 \n  21   22   23   24   25   26   27   28   29    3    4    5    6    7    8    9 \n 228  201  113   77   74   55   33   30   27 1214 1171 1151  955  934  849  758 \n\nIdents(merged.18279.tumor.singlets) &lt;- \"sub.cluster\"\nlevels(merged.18279.tumor.singlets)\n\n [1] \"8\"   \"10\"  \"7\"   \"5\"   \"14\"  \"6\"   \"27\"  \"20\"  \"15\"  \"19\"  \"11\"  \"4\"  \n[13] \"26\"  \"1_1\" \"3\"   \"1_0\" \"9\"   \"2_0\" \"18\"  \"16\"  \"22\"  \"12\"  \"24\"  \"0\"  \n[25] \"13\"  \"28\"  \"2_1\" \"21\"  \"17\"  \"29\"  \"25\"  \"23\" \n\n\n\n\n6.4.3 Cluster 3\n\nmerged.18279.tumor.singlets &lt;- FindSubCluster(object = merged.18279.tumor.singlets, \n                                        cluster = \"3\",\n                                        resolution = 0.2,\n                                        graph.name = \"RNA_snn\",  \n                                        algorithm = 2)\n\nModularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck\n\nNumber of nodes: 1214\nNumber of edges: 44968\n\nRunning Louvain algorithm with multilevel refinement...\nMaximum modularity in 10 random starts: 0.8135\nNumber of communities: 2\nElapsed time: 0 seconds\n\nDimPlot(merged.18279.tumor.singlets,  \n        reduction = \"umap.harmony\",  \n        group.by = \"sub.cluster\", \n        label = TRUE)\n\n\n\n\n\n\n\ntable(merged.18279.tumor.singlets$sub.cluster)\n\n\n   0  1_0  1_1   10   11   12   13   14   15   16   17   18   19  2_0  2_1   20 \n3244 2596  236  671  645  601  469  449  370  364  336  273  265 1142  196  249 \n  21   22   23   24   25   26   27   28   29  3_0  3_1    4    5    6    7    8 \n 228  201  113   77   74   55   33   30   27 1129   85 1171 1151  955  934  849 \n   9 \n 758 \n\nIdents(merged.18279.tumor.singlets) &lt;- \"sub.cluster\"\nlevels(merged.18279.tumor.singlets)\n\n [1] \"8\"   \"10\"  \"7\"   \"5\"   \"14\"  \"6\"   \"27\"  \"20\"  \"15\"  \"19\"  \"11\"  \"4\"  \n[13] \"26\"  \"1_1\" \"3_0\" \"1_0\" \"9\"   \"2_0\" \"18\"  \"16\"  \"22\"  \"12\"  \"24\"  \"0\"  \n[25] \"13\"  \"28\"  \"2_1\" \"3_1\" \"21\"  \"17\"  \"29\"  \"25\"  \"23\" \n\n\n\n\n6.4.4 Cluster 9\n\nmerged.18279.tumor.singlets &lt;- FindSubCluster(object = merged.18279.tumor.singlets, \n                                        cluster = \"9\",\n                                        resolution = 0.2,\n                                        graph.name = \"RNA_snn\",  \n                                        algorithm = 2)\n\nModularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck\n\nNumber of nodes: 758\nNumber of edges: 22201\n\nRunning Louvain algorithm with multilevel refinement...\nMaximum modularity in 10 random starts: 0.8565\nNumber of communities: 2\nElapsed time: 0 seconds\n\nDimPlot(merged.18279.tumor.singlets,  \n        reduction = \"umap.harmony\",  \n        group.by = \"sub.cluster\", \n        label = TRUE)\n\n\n\n\n\n\n\ntable(merged.18279.tumor.singlets$sub.cluster)\n\n\n   0  1_0  1_1   10   11   12   13   14   15   16   17   18   19  2_0  2_1   20 \n3244 2596  236  671  645  601  469  449  370  364  336  273  265 1142  196  249 \n  21   22   23   24   25   26   27   28   29  3_0  3_1    4    5    6    7    8 \n 228  201  113   77   74   55   33   30   27 1129   85 1171 1151  955  934  849 \n 9_0  9_1 \n 455  303 \n\nIdents(merged.18279.tumor.singlets) &lt;- \"sub.cluster\"\nlevels(merged.18279.tumor.singlets)\n\n [1] \"8\"   \"10\"  \"7\"   \"5\"   \"14\"  \"6\"   \"27\"  \"20\"  \"15\"  \"19\"  \"11\"  \"4\"  \n[13] \"26\"  \"1_1\" \"3_0\" \"1_0\" \"9_0\" \"2_0\" \"18\"  \"16\"  \"22\"  \"12\"  \"24\"  \"0\"  \n[25] \"13\"  \"28\"  \"2_1\" \"3_1\" \"9_1\" \"21\"  \"17\"  \"29\"  \"25\"  \"23\" \n\n\n\n\n6.4.5 Cluster 12\n\nmerged.18279.tumor.singlets &lt;- FindSubCluster(object = merged.18279.tumor.singlets, \n                                        cluster = \"12\",\n                                        resolution = 0.2,\n                                        graph.name = \"RNA_snn\",  \n                                        algorithm = 2)\n\nModularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck\n\nNumber of nodes: 601\nNumber of edges: 21396\n\nRunning Louvain algorithm with multilevel refinement...\nMaximum modularity in 10 random starts: 0.8378\nNumber of communities: 2\nElapsed time: 0 seconds\n\nDimPlot(merged.18279.tumor.singlets,  \n        reduction = \"umap.harmony\",  \n        group.by = \"sub.cluster\", \n        label = TRUE)\n\n\n\n\n\n\n\ntable(merged.18279.tumor.singlets$sub.cluster)\n\n\n   0  1_0  1_1   10   11 12_0 12_1   13   14   15   16   17   18   19  2_0  2_1 \n3244 2596  236  671  645  486  115  469  449  370  364  336  273  265 1142  196 \n  20   21   22   23   24   25   26   27   28   29  3_0  3_1    4    5    6    7 \n 249  228  201  113   77   74   55   33   30   27 1129   85 1171 1151  955  934 \n   8  9_0  9_1 \n 849  455  303 \n\nIdents(merged.18279.tumor.singlets) &lt;- \"sub.cluster\"\nlevels(merged.18279.tumor.singlets)\n\n [1] \"8\"    \"10\"   \"7\"    \"5\"    \"14\"   \"6\"    \"27\"   \"20\"   \"15\"   \"19\"  \n[11] \"11\"   \"4\"    \"26\"   \"1_1\"  \"3_0\"  \"1_0\"  \"9_0\"  \"2_0\"  \"18\"   \"16\"  \n[21] \"22\"   \"12_0\" \"12_1\" \"24\"   \"0\"    \"13\"   \"28\"   \"2_1\"  \"3_1\"  \"9_1\" \n[31] \"21\"   \"17\"   \"29\"   \"25\"   \"23\"  \n\n\n\n\n6.4.6 Cluster 16\n\nmerged.18279.tumor.singlets &lt;- FindSubCluster(object = merged.18279.tumor.singlets, \n                                        cluster = \"16\",\n                                        resolution = 0.2,\n                                        graph.name = \"RNA_snn\",  \n                                        algorithm = 2)\n\nModularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck\n\nNumber of nodes: 364\nNumber of edges: 13446\n\nRunning Louvain algorithm with multilevel refinement...\nMaximum modularity in 10 random starts: 0.8000\nNumber of communities: 1\nElapsed time: 0 seconds\n\nDimPlot(merged.18279.tumor.singlets,  \n        reduction = \"umap.harmony\",  \n        group.by = \"sub.cluster\", \n        label = TRUE)\n\n\n\n\n\n\n\ntable(merged.18279.tumor.singlets$sub.cluster)\n\n\n   0  1_0  1_1   10   11 12_0 12_1   13   14   15 16_0   17   18   19  2_0  2_1 \n3244 2596  236  671  645  486  115  469  449  370  364  336  273  265 1142  196 \n  20   21   22   23   24   25   26   27   28   29  3_0  3_1    4    5    6    7 \n 249  228  201  113   77   74   55   33   30   27 1129   85 1171 1151  955  934 \n   8  9_0  9_1 \n 849  455  303 \n\nIdents(merged.18279.tumor.singlets) &lt;- \"sub.cluster\"\nlevels(merged.18279.tumor.singlets)\n\n [1] \"8\"    \"10\"   \"7\"    \"5\"    \"14\"   \"6\"    \"27\"   \"20\"   \"15\"   \"19\"  \n[11] \"11\"   \"4\"    \"26\"   \"1_1\"  \"3_0\"  \"1_0\"  \"9_0\"  \"2_0\"  \"18\"   \"16_0\"\n[21] \"22\"   \"12_0\" \"12_1\" \"24\"   \"0\"    \"13\"   \"28\"   \"2_1\"  \"3_1\"  \"9_1\" \n[31] \"21\"   \"17\"   \"29\"   \"25\"   \"23\"  \n\n\n\n\n6.4.7 Cluster 18\n\nmerged.18279.tumor.singlets &lt;- FindSubCluster(object = merged.18279.tumor.singlets,\n                                                                                cluster = \"18\",\n                                                                                resolution = 0.2,\n                                                                                graph.name = \"RNA_snn\",\n                                                                                algorithm = 2)\n\nModularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck\n\nNumber of nodes: 273\nNumber of edges: 9056\n\nRunning Louvain algorithm with multilevel refinement...\nMaximum modularity in 10 random starts: 0.8289\nNumber of communities: 2\nElapsed time: 0 seconds\n\nDimPlot(merged.18279.tumor.singlets,\n        reduction = \"umap.harmony\",\n        group.by = \"sub.cluster\",\n        label = TRUE)\n\n\n\n\n\n\n\ntable(merged.18279.tumor.singlets$sub.cluster)\n\n\n   0  1_0  1_1   10   11 12_0 12_1   13   14   15 16_0   17 18_0 18_1   19  2_0 \n3244 2596  236  671  645  486  115  469  449  370  364  336  167  106  265 1142 \n 2_1   20   21   22   23   24   25   26   27   28   29  3_0  3_1    4    5    6 \n 196  249  228  201  113   77   74   55   33   30   27 1129   85 1171 1151  955 \n   7    8  9_0  9_1 \n 934  849  455  303 \n\nIdents(merged.18279.tumor.singlets) &lt;- \"sub.cluster\"\nlevels(merged.18279.tumor.singlets)\n\n [1] \"8\"    \"10\"   \"7\"    \"5\"    \"14\"   \"6\"    \"27\"   \"20\"   \"15\"   \"19\"  \n[11] \"11\"   \"4\"    \"26\"   \"1_1\"  \"3_0\"  \"1_0\"  \"9_0\"  \"2_0\"  \"18_1\" \"16_0\"\n[21] \"22\"   \"12_0\" \"18_0\" \"12_1\" \"24\"   \"0\"    \"13\"   \"28\"   \"2_1\"  \"3_1\" \n[31] \"9_1\"  \"21\"   \"17\"   \"29\"   \"25\"   \"23\"  \n\n\n\n\n6.4.8 Cluster 22\n\nmerged.18279.tumor.singlets &lt;- FindSubCluster(object = merged.18279.tumor.singlets,\n                                                                                cluster = \"22\",\n                                                                                resolution = 0.2,\n                                                                                graph.name = \"RNA_snn\",\n                                                                                algorithm = 2)\n\nModularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck\n\nNumber of nodes: 201\nNumber of edges: 4598\n\nRunning Louvain algorithm with multilevel refinement...\nMaximum modularity in 10 random starts: 0.8141\nNumber of communities: 3\nElapsed time: 0 seconds\n\nDimPlot(merged.18279.tumor.singlets,\n        reduction = \"umap.harmony\",\n        group.by = \"sub.cluster\",\n        label = TRUE)\n\n\n\n\n\n\n\ntable(merged.18279.tumor.singlets$sub.cluster)\n\n\n   0  1_0  1_1   10   11 12_0 12_1   13   14   15 16_0   17 18_0 18_1   19  2_0 \n3244 2596  236  671  645  486  115  469  449  370  364  336  167  106  265 1142 \n 2_1   20   21 22_0 22_1 22_2   23   24   25   26   27   28   29  3_0  3_1    4 \n 196  249  228  106   70   25  113   77   74   55   33   30   27 1129   85 1171 \n   5    6    7    8  9_0  9_1 \n1151  955  934  849  455  303 \n\nIdents(merged.18279.tumor.singlets) &lt;- \"sub.cluster\"\nlevels(merged.18279.tumor.singlets)\n\n [1] \"8\"    \"10\"   \"7\"    \"5\"    \"14\"   \"6\"    \"27\"   \"20\"   \"15\"   \"19\"  \n[11] \"11\"   \"4\"    \"26\"   \"1_1\"  \"3_0\"  \"1_0\"  \"9_0\"  \"2_0\"  \"18_1\" \"16_0\"\n[21] \"22_0\" \"12_0\" \"18_0\" \"12_1\" \"24\"   \"0\"    \"13\"   \"28\"   \"2_1\"  \"3_1\" \n[31] \"9_1\"  \"21\"   \"17\"   \"22_1\" \"29\"   \"22_2\" \"25\"   \"23\"  \n\n\n\n\n6.4.9 Cluster 26\n\nmerged.18279.tumor.singlets &lt;- FindSubCluster(object = merged.18279.tumor.singlets,\n                                                                                cluster = \"26\",\n                                                                                resolution = 0.2,\n                                                                                graph.name = \"RNA_snn\",\n                                                                                algorithm = 2)\n\nModularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck\n\nNumber of nodes: 55\nNumber of edges: 1022\n\nRunning Louvain algorithm with multilevel refinement...\nMaximum modularity in 10 random starts: 0.8000\nNumber of communities: 1\nElapsed time: 0 seconds\n\nDimPlot(merged.18279.tumor.singlets,\n        reduction = \"umap.harmony\",\n        group.by = \"sub.cluster\",\n        label = TRUE)\n\n\n\n\n\n\n\ntable(merged.18279.tumor.singlets$sub.cluster)\n\n\n   0  1_0  1_1   10   11 12_0 12_1   13   14   15 16_0   17 18_0 18_1   19  2_0 \n3244 2596  236  671  645  486  115  469  449  370  364  336  167  106  265 1142 \n 2_1   20   21 22_0 22_1 22_2   23   24   25 26_0   27   28   29  3_0  3_1    4 \n 196  249  228  106   70   25  113   77   74   55   33   30   27 1129   85 1171 \n   5    6    7    8  9_0  9_1 \n1151  955  934  849  455  303 \n\nIdents(merged.18279.tumor.singlets) &lt;- \"sub.cluster\"\nlevels(merged.18279.tumor.singlets)\n\n [1] \"8\"    \"10\"   \"7\"    \"5\"    \"14\"   \"6\"    \"27\"   \"20\"   \"15\"   \"19\"  \n[11] \"11\"   \"4\"    \"26_0\" \"1_1\"  \"3_0\"  \"1_0\"  \"9_0\"  \"2_0\"  \"18_1\" \"16_0\"\n[21] \"22_0\" \"12_0\" \"18_0\" \"12_1\" \"24\"   \"0\"    \"13\"   \"28\"   \"2_1\"  \"3_1\" \n[31] \"9_1\"  \"21\"   \"17\"   \"22_1\" \"29\"   \"22_2\" \"25\"   \"23\"",
    "crumbs": [
      "<span class='chapter-number'>6</span>  <span class='chapter-title'>Tumor: Sub-clustering on T/NK lineage</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part6.html#plot-updated-qc-metrics-per-clustersub-cluster",
    "href": "Tumor_scRNA_Part6.html#plot-updated-qc-metrics-per-clustersub-cluster",
    "title": "6  Tumor: Sub-clustering on T/NK lineage",
    "section": "6.5 Plot updated QC metrics per cluster/sub-cluster",
    "text": "6.5 Plot updated QC metrics per cluster/sub-cluster\n\nVlnPlot(merged.18279.tumor.singlets, features = \"nCount_RNA\", group.by=\"sub.cluster\", pt.size=0) + NoLegend()\n\n\n\n\n\n\n\nVlnPlot(merged.18279.tumor.singlets, features = \"nFeature_RNA\", group.by=\"sub.cluster\", pt.size=0) + NoLegend()\n\n\n\n\n\n\n\nVlnPlot(merged.18279.tumor.singlets, features = \"percent.mt\", group.by=\"sub.cluster\", pt.size=0) + NoLegend()",
    "crumbs": [
      "<span class='chapter-number'>6</span>  <span class='chapter-title'>Tumor: Sub-clustering on T/NK lineage</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part6.html#identify-updated-cursory-marker-genes-per-clustersub-cluster",
    "href": "Tumor_scRNA_Part6.html#identify-updated-cursory-marker-genes-per-clustersub-cluster",
    "title": "6  Tumor: Sub-clustering on T/NK lineage",
    "section": "6.6 Identify updated cursory marker genes per cluster/sub-cluster",
    "text": "6.6 Identify updated cursory marker genes per cluster/sub-cluster\n\nDefaultAssay(merged.18279.tumor.singlets) &lt;- \"RNA\"\n\nvargenes &lt;- presto::wilcoxauc(merged.18279.tumor.singlets, 'sub.cluster', seurat_assay = 'RNA')\ntop_vargenes &lt;- top_markers(vargenes, n = 100, auc_min = 0.5, pct_in_min = 50, pct_out_max = 50)\ntop_vargenes\n\n# A tibble: 100 × 39\n    rank `0`    `1_0` `1_1`   `10`  `11`  `12_0` `12_1` `13`  `14`  `15`  `16_0`\n   &lt;int&gt; &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; \n 1     1 MLANA  CCL5  GZMH    COL1… CRYAB GZMK   ITM2A  MZB1  PTTG1 IFI30 IL32  \n 2     2 EDNRB  NKG7  NKG7    COL3… SERP… CST7   TOX    DERL3 TYMS  TYRO… LTB   \n 3     3 TYR    CST7  GZMA    COL1… BANCR IL32   CXCL13 JCHA… NUCK… LYZ   FOXP3 \n 4     4 CRTAC1 CD8A  CCL5    COL6… IFI27 CD3E   NR3C1  XBP1  CENPF ENSG… SPOCK2\n 5     5 MITF   DUSP2 APOBEC… COL6… ANGP… GZMA   TIGIT  IGHG1 UBE2C CST3  CD3E  \n 6     6 TYRP1  IL32  TGFB1   DCN   F2R   CD3D   LAT    ENSG… CKS1B PLAUR CTLA4 \n 7     7 GPNMB  LAG3  CTSW    COL6… WARS1 RGS1   CD247  CD79A BIRC5 FCER… TIGIT \n 8     8 APOE   CD3E  PTPRC   C1S   ST3G… LAG3   CD2    IGHGP HMGN2 SPI1  CORO1A\n 9     9 GMPR   CD8B  AOAH    C1R   HMCN1 DUSP2  CD3E   IGHG2 H2AZ2 AIF1  PTPRC \n10    10 GPM6B  CD7   TUBA4A  VCAN  RHOB  CD2    NMB    FKBP… MIA   TYMP  CD3D  \n# ℹ 90 more rows\n# ℹ 27 more variables: `17` &lt;chr&gt;, `18_0` &lt;chr&gt;, `18_1` &lt;chr&gt;, `19` &lt;chr&gt;,\n#   `2_0` &lt;chr&gt;, `2_1` &lt;chr&gt;, `20` &lt;chr&gt;, `21` &lt;chr&gt;, `22_0` &lt;chr&gt;,\n#   `22_1` &lt;chr&gt;, `22_2` &lt;chr&gt;, `23` &lt;chr&gt;, `24` &lt;chr&gt;, `25` &lt;chr&gt;,\n#   `26_0` &lt;chr&gt;, `27` &lt;chr&gt;, `28` &lt;chr&gt;, `29` &lt;chr&gt;, `3_0` &lt;chr&gt;, `3_1` &lt;chr&gt;,\n#   `4` &lt;chr&gt;, `5` &lt;chr&gt;, `6` &lt;chr&gt;, `7` &lt;chr&gt;, `8` &lt;chr&gt;, `9_0` &lt;chr&gt;,\n#   `9_1` &lt;chr&gt;\n\nwrite_tsv(top_vargenes,\"Tumor_scRNA_prestoMarkers.tsv\")",
    "crumbs": [
      "<span class='chapter-number'>6</span>  <span class='chapter-title'>Tumor: Sub-clustering on T/NK lineage</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part6.html#plot-top-markers-identified-and-canonical-genes-as-a-dotplot",
    "href": "Tumor_scRNA_Part6.html#plot-top-markers-identified-and-canonical-genes-as-a-dotplot",
    "title": "6  Tumor: Sub-clustering on T/NK lineage",
    "section": "6.7 Plot top markers identified and canonical genes as a dotplot",
    "text": "6.7 Plot top markers identified and canonical genes as a dotplot\n\ntumor &lt;- c(\"DCT\",\"MLANA\",\"MITF\",\"PMEL\",\"S100A1\",\"TYR\",\"APOC1\")\nendothelial &lt;- c(\"PECAM1\",\"VWF\")\nfibroblast &lt;- c(\"COL3A1\",\"COL1A1\",\"COL1A2\",\"LUM\")\ntcell &lt;- c(\"FGFBP2\",\"KLRD1\",\"CD3E\",\"CD3D\",\"GZMB\",\"XCL2\",\"GZMH\",\"CST7\",\"GZMK\",\"GZMA\",\"IFNG\",\"GNLY\",\"CCL4\",\"NKG7\",\"CCL5\",\"CD8A\",\"CD8B\",\"CTLA4\",\"TNFRSF4\",\"BATF\",\"ITM2A\")\nmono &lt;- c(\"LYZ\",\"CD74\",\"CD68\")\nbcell &lt;- c(\"MS4A1\",\"CD79A\")\n\ntop_vargenes &lt;- top_markers(vargenes, n = 5, auc_min = 0.5, pct_in_min = 50, pct_out_max = 50)\ntop_markers &lt;- top_vargenes %&gt;%\n    select(-rank) %&gt;% \n    unclass() %&gt;% \n    stack() %&gt;%\n    pull(values) %&gt;%\n    unique() %&gt;%\n    .[!is.na(.)]\n\ndotplotmarkers &lt;- unique(c(top_markers,tumor,endothelial,fibroblast,tcell,mono,bcell))\n\n# Compute aggregated expression values of these genes and cluster them to order the figure\nrna &lt;- AverageExpression(merged.18279.tumor.singlets,assay=\"RNA\",slot=\"data\")\n\nAs of Seurat v5, we recommend using AggregateExpression to perform pseudo-bulk analysis.\nNames of identity class contain underscores ('_'), replacing with dashes ('-')\nFirst group.by variable `ident` starts with a number, appending `g` to ensure valid variable names\nThis message is displayed once per session.\n\nrna.sub &lt;- rna$RNA[dotplotmarkers,]\ncors.genes &lt;- as.dist(1-cor(as.matrix(t(rna.sub)),method=\"pearson\"))\nhc.genes &lt;- hclust(cors.genes)\ndotplotmarkers.sorted &lt;- rownames(rna.sub)[hc.genes$order]\n\n# Also re-order the sub-clusters\ncors.subs &lt;- as.dist(1-cor(as.matrix(rna.sub),method=\"pearson\"))\nhc.subs &lt;- hclust(cors.subs)\nmerged.18279.tumor.singlets@active.ident &lt;- factor(merged.18279.tumor.singlets@active.ident, \n                            levels=str_replace_all(str_replace_all(colnames(rna.sub)[hc.subs$order],\"g\",\"\"),\"-\",\"_\"))\n\n# Plot\nDotPlot(merged.18279.tumor.singlets,\n    features = dotplotmarkers.sorted,\n    assay = \"RNA\",\n    cols = c(\"blue\",\"red\")\n    ) + \n    RotatedAxis()",
    "crumbs": [
      "<span class='chapter-number'>6</span>  <span class='chapter-title'>Tumor: Sub-clustering on T/NK lineage</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part6.html#plot-updated-tumor-proportions-per-cluster-over-time",
    "href": "Tumor_scRNA_Part6.html#plot-updated-tumor-proportions-per-cluster-over-time",
    "title": "6  Tumor: Sub-clustering on T/NK lineage",
    "section": "6.8 Plot updated tumor proportions per cluster over time",
    "text": "6.8 Plot updated tumor proportions per cluster over time\n\n# Tumor samples, week 0, 12, 20 timepoints\nas.data.frame(table(merged.18279.tumor.singlets$sub.cluster, merged.18279.tumor.singlets$Sample)) %&gt;% \n  as_tibble() %&gt;%\n  dplyr::rename(\"Sample\" = Var2,\"Cluster\" = Var1) %&gt;%\n  separate(Sample, into=c(\"Patient\",\"Site\",\"Timepoint\",\"IpiCohort\",\"Assay\"),sep=\"_\",remove=F) %&gt;%\n  dplyr::filter(Timepoint==\"W00\" | Timepoint==\"W12\" | Timepoint==\"W20\") %&gt;%\n  group_by(Sample) %&gt;%\n  mutate(Proportion = Freq / sum(Freq)) %&gt;%\n  ggplot(aes(fill = Timepoint, x = Timepoint, y=Proportion)) +\n  geom_point(pch = 21, position = position_jitterdodge(jitter.width=0.2)) +\n  facet_wrap(~Cluster,scales=\"free\")",
    "crumbs": [
      "<span class='chapter-number'>6</span>  <span class='chapter-title'>Tumor: Sub-clustering on T/NK lineage</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part6.html#save-updated-object",
    "href": "Tumor_scRNA_Part6.html#save-updated-object",
    "title": "6  Tumor: Sub-clustering on T/NK lineage",
    "section": "6.9 Save updated object",
    "text": "6.9 Save updated object\n\nsaveRDS(merged.18279.tumor.singlets, \"Tumor_scRNA_Part6.rds\")",
    "crumbs": [
      "<span class='chapter-number'>6</span>  <span class='chapter-title'>Tumor: Sub-clustering on T/NK lineage</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part6.html#get-session-info",
    "href": "Tumor_scRNA_Part6.html#get-session-info",
    "title": "6  Tumor: Sub-clustering on T/NK lineage",
    "section": "6.10 Get session info",
    "text": "6.10 Get session info\n\nsessionInfo()\n\nR version 4.3.2 (2023-10-31)\nPlatform: x86_64-pc-linux-gnu (64-bit)\nRunning under: Rocky Linux 8.10 (Green Obsidian)\n\nMatrix products: default\nBLAS/LAPACK: /usr/lib64/libopenblasp-r0.3.15.so;  LAPACK version 3.9.0\n\nlocale:\n [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              \n [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    \n [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   \n [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 \n [9] LC_ADDRESS=C               LC_TELEPHONE=C            \n[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       \n\ntime zone: America/New_York\ntzcode source: system (glibc)\n\nattached base packages:\n[1] stats4    stats     graphics  grDevices utils     datasets  methods  \n[8] base     \n\nother attached packages:\n [1] cellXY_0.99.0               scDblFinder_1.14.0         \n [3] harmony_1.2.0               alevinQC_1.16.1            \n [5] vctrs_0.6.5                 patchwork_1.3.0            \n [7] scater_1.30.1               scuttle_1.12.0             \n [9] speckle_1.0.0               Matrix_1.6-4               \n[11] fishpond_2.6.2              readxl_1.4.3               \n[13] SingleCellExperiment_1.24.0 SummarizedExperiment_1.32.0\n[15] Biobase_2.62.0              GenomicRanges_1.54.1       \n[17] GenomeInfoDb_1.38.8         IRanges_2.36.0             \n[19] S4Vectors_0.40.2            BiocGenerics_0.48.1        \n[21] MatrixGenerics_1.14.0       matrixStats_1.4.1          \n[23] flexmix_2.3-19              lattice_0.22-6             \n[25] SeuratWrappers_0.3.19       miQC_1.8.0                 \n[27] lubridate_1.9.3             forcats_1.0.0              \n[29] stringr_1.5.1               dplyr_1.1.4                \n[31] purrr_1.0.2                 readr_2.1.5                \n[33] tidyr_1.3.1                 tibble_3.2.1               \n[35] ggplot2_3.5.1               tidyverse_2.0.0            \n[37] Seurat_5.1.0                SeuratObject_5.0.2         \n[39] sp_2.1-4                    sctransform_0.4.1          \n[41] glmGamPoi_1.12.2            presto_1.0.0               \n[43] Rcpp_1.0.13-1               devtools_2.4.5             \n[45] usethis_3.0.0               data.table_1.16.2          \n\nloaded via a namespace (and not attached):\n  [1] fs_1.6.5                  spatstat.sparse_3.1-0    \n  [3] bitops_1.0-9              httr_1.4.7               \n  [5] RColorBrewer_1.1-3        profvis_0.4.0            \n  [7] tools_4.3.2               utf8_1.2.4               \n  [9] R6_2.5.1                  DT_0.33                  \n [11] lazyeval_0.2.2            uwot_0.2.2               \n [13] urlchecker_1.0.1          withr_3.0.2              \n [15] GGally_2.2.1              gridExtra_2.3            \n [17] progressr_0.15.1          cli_3.6.3                \n [19] spatstat.explore_3.2-6    fastDummies_1.7.3        \n [21] labeling_0.4.3            spatstat.data_3.1-4      \n [23] ggridges_0.5.6            pbapply_1.7-2            \n [25] Rsamtools_2.18.0          R.utils_2.12.3           \n [27] parallelly_1.39.0         sessioninfo_1.2.2        \n [29] limma_3.58.1              RSQLite_2.3.8            \n [31] BiocIO_1.12.0             generics_0.1.3           \n [33] vroom_1.6.5               gtools_3.9.5             \n [35] ica_1.0-3                 spatstat.random_3.2-2    \n [37] ggbeeswarm_0.7.2          fansi_1.0.6              \n [39] abind_1.4-8               R.methodsS3_1.8.2        \n [41] lifecycle_1.0.4           yaml_2.3.10              \n [43] edgeR_4.0.16              SparseArray_1.2.2        \n [45] Rtsne_0.17                blob_1.2.4               \n [47] grid_4.3.2                dqrng_0.4.1              \n [49] promises_1.3.0            crayon_1.5.3             \n [51] shinydashboard_0.7.2      miniUI_0.1.1.1           \n [53] beachmat_2.18.1           cowplot_1.1.3            \n [55] KEGGREST_1.42.0           metapod_1.10.1           \n [57] pillar_1.9.0              knitr_1.45               \n [59] rjson_0.2.23              xgboost_1.7.8.1          \n [61] future.apply_1.11.3       codetools_0.2-20         \n [63] leiden_0.4.3.1            glue_1.8.0               \n [65] remotes_2.5.0             png_0.1-8                \n [67] spam_2.11-0               org.Mm.eg.db_3.18.0      \n [69] cellranger_1.1.0          gtable_0.3.6             \n [71] cachem_1.1.0              xfun_0.49                \n [73] S4Arrays_1.2.0            mime_0.12                \n [75] survival_3.7-0            bluster_1.12.0           \n [77] statmod_1.5.0             ellipsis_0.3.2           \n [79] fitdistrplus_1.2-1        ROCR_1.0-11              \n [81] nlme_3.1-166              bit64_4.5.2              \n [83] RcppAnnoy_0.0.22          irlba_2.3.5.1            \n [85] vipor_0.4.7               KernSmooth_2.23-24       \n [87] DBI_1.2.3                 colorspace_2.1-1         \n [89] nnet_7.3-19               ggrastr_1.0.2            \n [91] tidyselect_1.2.1          bit_4.5.0                \n [93] compiler_4.3.2            BiocNeighbors_1.20.2     \n [95] DelayedArray_0.28.0       plotly_4.10.4            \n [97] rtracklayer_1.62.0        scales_1.3.0             \n [99] lmtest_0.9-40             digest_0.6.37            \n[101] goftest_1.2-3             spatstat.utils_3.1-1     \n[103] rmarkdown_2.29            XVector_0.42.0           \n[105] htmltools_0.5.8.1         pkgconfig_2.0.3          \n[107] sparseMatrixStats_1.14.0  fastmap_1.2.0            \n[109] rlang_1.1.4               htmlwidgets_1.6.4        \n[111] shiny_1.9.1               DelayedMatrixStats_1.24.0\n[113] farver_2.1.2              zoo_1.8-12               \n[115] jsonlite_1.8.9            BiocParallel_1.36.0      \n[117] R.oo_1.27.0               BiocSingular_1.18.0      \n[119] RCurl_1.98-1.16           magrittr_2.0.3           \n[121] modeltools_0.2-23         GenomeInfoDbData_1.2.11  \n[123] dotCall64_1.2             munsell_0.5.1            \n[125] viridis_0.6.5             reticulate_1.35.0        \n[127] stringi_1.8.4             zlibbioc_1.48.2          \n[129] MASS_7.3-60.0.1           org.Hs.eg.db_3.18.0      \n[131] plyr_1.8.9                pkgbuild_1.4.5           \n[133] ggstats_0.7.0             parallel_4.3.2           \n[135] listenv_0.9.1             ggrepel_0.9.6            \n[137] deldir_2.0-4              Biostrings_2.70.3        \n[139] splines_4.3.2             tensor_1.5               \n[141] hms_1.1.3                 locfit_1.5-9.10          \n[143] igraph_2.1.1              spatstat.geom_3.2-8      \n[145] RcppHNSW_0.6.0            reshape2_1.4.4           \n[147] ScaledMatrix_1.10.0       pkgload_1.4.0            \n[149] XML_3.99-0.17             evaluate_1.0.1           \n[151] scran_1.30.2              BiocManager_1.30.25      \n[153] tzdb_0.4.0                httpuv_1.6.15            \n[155] RANN_2.6.2                polyclip_1.10-7          \n[157] future_1.34.0             scattermore_1.2          \n[159] rsvd_1.0.5                xtable_1.8-4             \n[161] restfulr_0.0.15           svMisc_1.2.3             \n[163] RSpectra_0.16-2           later_1.3.2              \n[165] viridisLite_0.4.2         AnnotationDbi_1.64.1     \n[167] GenomicAlignments_1.38.2  memoise_2.0.1            \n[169] beeswarm_0.4.0            tximport_1.28.0          \n[171] cluster_2.1.6             timechange_0.3.0         \n[173] globals_0.16.3",
    "crumbs": [
      "<span class='chapter-number'>6</span>  <span class='chapter-title'>Tumor: Sub-clustering on T/NK lineage</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part7.html",
    "href": "Tumor_scRNA_Part7.html",
    "title": "7  Tumor: Assisting cell type annotation with enrichR",
    "section": "",
    "text": "7.1 Set up Seurat workspace\n# Load libraries\nlibrary(data.table)\nlibrary(devtools)\nlibrary(presto)\nlibrary(glmGamPoi)\nlibrary(sctransform)\nlibrary(Seurat) \nlibrary(tidyverse)\nlibrary(miQC)\nlibrary(SeuratWrappers)\nlibrary(flexmix)\nlibrary(SingleCellExperiment)\nlibrary(SummarizedExperiment)\nlibrary(readxl)\nlibrary(fishpond)\nlibrary(Matrix)\nlibrary(speckle)\nlibrary(scater)\nlibrary(patchwork)\nlibrary(vctrs)\nlibrary(alevinQC)\nlibrary(harmony)\nlibrary(scDblFinder)\nlibrary(cellXY)\nlibrary(enrichR)\n\n# Set global options for Seurat v5 objects\noptions(Seurat.object.assay.version = 'v5')",
    "crumbs": [
      "<span class='chapter-number'>7</span>  <span class='chapter-title'>Tumor: Assisting cell type annotation with enrichR</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part7.html#load-sub-cluster-specific-marker-gene-table",
    "href": "Tumor_scRNA_Part7.html#load-sub-cluster-specific-marker-gene-table",
    "title": "7  Tumor: Assisting cell type annotation with enrichR",
    "section": "7.2 Load sub-cluster specific marker gene table",
    "text": "7.2 Load sub-cluster specific marker gene table\n\nmarkers &lt;- read_tsv(\"Tumor_scRNA_prestoMarkers.tsv\")\n\nRows: 100 Columns: 39\n── Column specification ────────────────────────────────────────────────────────\nDelimiter: \"\\t\"\nchr (38): 0, 1_0, 1_1, 10, 11, 12_0, 12_1, 13, 14, 15, 16_0, 17, 18_0, 18_1,...\ndbl  (1): rank\n\nℹ Use `spec()` to retrieve the full column specification for this data.\nℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.",
    "crumbs": [
      "<span class='chapter-number'>7</span>  <span class='chapter-title'>Tumor: Assisting cell type annotation with enrichR</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part7.html#run-enrichr-to-estimate-cell-type-annotation",
    "href": "Tumor_scRNA_Part7.html#run-enrichr-to-estimate-cell-type-annotation",
    "title": "7  Tumor: Assisting cell type annotation with enrichR",
    "section": "7.3 Run enrichR to estimate cell type annotation",
    "text": "7.3 Run enrichR to estimate cell type annotation\n\ndbs &lt;- c(\"Tabula_Sapiens\",\"PanglaoDB_Augmented_2021\",\"Azimuth_Cell_Types_2021\",\"HuBMAP_ASCTplusB_augmented_2022\",\"Azimuth_2023\",\"CellMarker_2024\")\n\npredictions &lt;- NULL\n\nfor(i in colnames(markers)[-1]) {\n    m &lt;- pull(markers[,i])\n    res &lt;- enrichr(m, dbs)\n    \n    pred &lt;- res %&gt;% \n        map_dfr(~ .x %&gt;% as_tibble(), .id = \"name\") %&gt;%\n        group_by(name) %&gt;%\n        slice_min(Adjusted.P.value, n=1, with_ties = F) %&gt;%\n        dplyr::select(name,Term,Adjusted.P.value) %&gt;%\n        mutate(Term = str_replace_all(str_replace_all(Term,\"[ -]\",\"_\"),\"_+\",\"_\")) %&gt;%\n        add_column(sub.cluster = i, .before = 1)\n        \n    predictions &lt;- bind_rows(predictions, pred)     \n}\n\nUploading data to Enrichr... Done.\n  Querying Tabula_Sapiens... Done.\n  Querying PanglaoDB_Augmented_2021... Done.\n  Querying Azimuth_Cell_Types_2021... Done.\n  Querying HuBMAP_ASCTplusB_augmented_2022... Done.\n  Querying Azimuth_2023... Done.\n  Querying CellMarker_2024... Done.\nParsing results... Done.\nUploading data to Enrichr... Done.\n  Querying Tabula_Sapiens... Done.\n  Querying PanglaoDB_Augmented_2021... Done.\n  Querying Azimuth_Cell_Types_2021... Done.\n  Querying HuBMAP_ASCTplusB_augmented_2022... Done.\n  Querying Azimuth_2023... Done.\n  Querying CellMarker_2024... Done.\nParsing results... Done.\nUploading data to Enrichr... Done.\n  Querying Tabula_Sapiens... Done.\n  Querying PanglaoDB_Augmented_2021... Done.\n  Querying Azimuth_Cell_Types_2021... Done.\n  Querying HuBMAP_ASCTplusB_augmented_2022... Done.\n  Querying Azimuth_2023... Done.\n  Querying CellMarker_2024... Done.\nParsing results... Done.\nUploading data to Enrichr... Done.\n  Querying Tabula_Sapiens... Done.\n  Querying PanglaoDB_Augmented_2021... Done.\n  Querying Azimuth_Cell_Types_2021... Done.\n  Querying HuBMAP_ASCTplusB_augmented_2022... Done.\n  Querying Azimuth_2023... Done.\n  Querying CellMarker_2024... Done.\nParsing results... Done.\nUploading data to Enrichr... Done.\n  Querying Tabula_Sapiens... Done.\n  Querying PanglaoDB_Augmented_2021... Done.\n  Querying Azimuth_Cell_Types_2021... Done.\n  Querying HuBMAP_ASCTplusB_augmented_2022... Done.\n  Querying Azimuth_2023... Done.\n  Querying CellMarker_2024... Done.\nParsing results... Done.\nUploading data to Enrichr... Done.\n  Querying Tabula_Sapiens... Done.\n  Querying PanglaoDB_Augmented_2021... Done.\n  Querying Azimuth_Cell_Types_2021... Done.\n  Querying HuBMAP_ASCTplusB_augmented_2022... Done.\n  Querying Azimuth_2023... Done.\n  Querying CellMarker_2024... Done.\nParsing results... Done.\nUploading data to Enrichr... Done.\n  Querying Tabula_Sapiens... Done.\n  Querying PanglaoDB_Augmented_2021... Done.\n  Querying Azimuth_Cell_Types_2021... Done.\n  Querying HuBMAP_ASCTplusB_augmented_2022... Done.\n  Querying Azimuth_2023... Done.\n  Querying CellMarker_2024... Done.\nParsing results... Done.\nUploading data to Enrichr... Done.\n  Querying Tabula_Sapiens... Done.\n  Querying PanglaoDB_Augmented_2021... Done.\n  Querying Azimuth_Cell_Types_2021... Done.\n  Querying HuBMAP_ASCTplusB_augmented_2022... Done.\n  Querying Azimuth_2023... Done.\n  Querying CellMarker_2024... Done.\nParsing results... Done.\nUploading data to Enrichr... Done.\n  Querying Tabula_Sapiens... Done.\n  Querying PanglaoDB_Augmented_2021... Done.\n  Querying Azimuth_Cell_Types_2021... Done.\n  Querying HuBMAP_ASCTplusB_augmented_2022... Done.\n  Querying Azimuth_2023... Done.\n  Querying CellMarker_2024... Done.\nParsing results... Done.\nUploading data to Enrichr... Done.\n  Querying Tabula_Sapiens... Done.\n  Querying PanglaoDB_Augmented_2021... Done.\n  Querying Azimuth_Cell_Types_2021... Done.\n  Querying HuBMAP_ASCTplusB_augmented_2022... Done.\n  Querying Azimuth_2023... Done.\n  Querying CellMarker_2024... Done.\nParsing results... Done.\nUploading data to Enrichr... Done.\n  Querying Tabula_Sapiens... Done.\n  Querying PanglaoDB_Augmented_2021... Done.\n  Querying Azimuth_Cell_Types_2021... Done.\n  Querying HuBMAP_ASCTplusB_augmented_2022... Done.\n  Querying Azimuth_2023... Done.\n  Querying CellMarker_2024... Done.\nParsing results... Done.\nUploading data to Enrichr... Done.\n  Querying Tabula_Sapiens... Done.\n  Querying PanglaoDB_Augmented_2021... Done.\n  Querying Azimuth_Cell_Types_2021... Done.\n  Querying HuBMAP_ASCTplusB_augmented_2022... Done.\n  Querying Azimuth_2023... Done.\n  Querying CellMarker_2024... Done.\nParsing results... Done.\nUploading data to Enrichr... Done.\n  Querying Tabula_Sapiens... Done.\n  Querying PanglaoDB_Augmented_2021... Done.\n  Querying Azimuth_Cell_Types_2021... Done.\n  Querying HuBMAP_ASCTplusB_augmented_2022... Done.\n  Querying Azimuth_2023... Done.\n  Querying CellMarker_2024... Done.\nParsing results... Done.\nUploading data to Enrichr... Done.\n  Querying Tabula_Sapiens... Done.\n  Querying PanglaoDB_Augmented_2021... Done.\n  Querying Azimuth_Cell_Types_2021... Done.\n  Querying HuBMAP_ASCTplusB_augmented_2022... Done.\n  Querying Azimuth_2023... Done.\n  Querying CellMarker_2024... Done.\nParsing results... Done.\nUploading data to Enrichr... Done.\n  Querying Tabula_Sapiens... Done.\n  Querying PanglaoDB_Augmented_2021... Done.\n  Querying Azimuth_Cell_Types_2021... Done.\n  Querying HuBMAP_ASCTplusB_augmented_2022... Done.\n  Querying Azimuth_2023... Done.\n  Querying CellMarker_2024... Done.\nParsing results... Done.\nUploading data to Enrichr... Done.\n  Querying Tabula_Sapiens... Done.\n  Querying PanglaoDB_Augmented_2021... Done.\n  Querying Azimuth_Cell_Types_2021... Done.\n  Querying HuBMAP_ASCTplusB_augmented_2022... Done.\n  Querying Azimuth_2023... Done.\n  Querying CellMarker_2024... Done.\nParsing results... Done.\nUploading data to Enrichr... Done.\n  Querying Tabula_Sapiens... Done.\n  Querying PanglaoDB_Augmented_2021... Done.\n  Querying Azimuth_Cell_Types_2021... Done.\n  Querying HuBMAP_ASCTplusB_augmented_2022... Done.\n  Querying Azimuth_2023... Done.\n  Querying CellMarker_2024... Done.\nParsing results... Done.\nUploading data to Enrichr... Done.\n  Querying Tabula_Sapiens... Done.\n  Querying PanglaoDB_Augmented_2021... Done.\n  Querying Azimuth_Cell_Types_2021... Done.\n  Querying HuBMAP_ASCTplusB_augmented_2022... Done.\n  Querying Azimuth_2023... Done.\n  Querying CellMarker_2024... Done.\nParsing results... Done.\nUploading data to Enrichr... Done.\n  Querying Tabula_Sapiens... Done.\n  Querying PanglaoDB_Augmented_2021... Done.\n  Querying Azimuth_Cell_Types_2021... Done.\n  Querying HuBMAP_ASCTplusB_augmented_2022... Done.\n  Querying Azimuth_2023... Done.\n  Querying CellMarker_2024... Done.\nParsing results... Done.\nUploading data to Enrichr... Done.\n  Querying Tabula_Sapiens... Done.\n  Querying PanglaoDB_Augmented_2021... Done.\n  Querying Azimuth_Cell_Types_2021... Done.\n  Querying HuBMAP_ASCTplusB_augmented_2022... Done.\n  Querying Azimuth_2023... Done.\n  Querying CellMarker_2024... Done.\nParsing results... Done.\nUploading data to Enrichr... Done.\n  Querying Tabula_Sapiens... Done.\n  Querying PanglaoDB_Augmented_2021... Done.\n  Querying Azimuth_Cell_Types_2021... Done.\n  Querying HuBMAP_ASCTplusB_augmented_2022... Done.\n  Querying Azimuth_2023... Done.\n  Querying CellMarker_2024... Done.\nParsing results... Done.\nUploading data to Enrichr... Done.\n  Querying Tabula_Sapiens... Done.\n  Querying PanglaoDB_Augmented_2021... Done.\n  Querying Azimuth_Cell_Types_2021... Done.\n  Querying HuBMAP_ASCTplusB_augmented_2022... Done.\n  Querying Azimuth_2023... Done.\n  Querying CellMarker_2024... Done.\nParsing results... Done.\nUploading data to Enrichr... Done.\n  Querying Tabula_Sapiens... Done.\n  Querying PanglaoDB_Augmented_2021... Done.\n  Querying Azimuth_Cell_Types_2021... Done.\n  Querying HuBMAP_ASCTplusB_augmented_2022... Done.\n  Querying Azimuth_2023... Done.\n  Querying CellMarker_2024... Done.\nParsing results... Done.\nUploading data to Enrichr... Done.\n  Querying Tabula_Sapiens... Done.\n  Querying PanglaoDB_Augmented_2021... Done.\n  Querying Azimuth_Cell_Types_2021... Done.\n  Querying HuBMAP_ASCTplusB_augmented_2022... Done.\n  Querying Azimuth_2023... Done.\n  Querying CellMarker_2024... Done.\nParsing results... Done.\nUploading data to Enrichr... Done.\n  Querying Tabula_Sapiens... Done.\n  Querying PanglaoDB_Augmented_2021... Done.\n  Querying Azimuth_Cell_Types_2021... Done.\n  Querying HuBMAP_ASCTplusB_augmented_2022... Done.\n  Querying Azimuth_2023... Done.\n  Querying CellMarker_2024... Done.\nParsing results... Done.\nUploading data to Enrichr... Done.\n  Querying Tabula_Sapiens... Done.\n  Querying PanglaoDB_Augmented_2021... Done.\n  Querying Azimuth_Cell_Types_2021... Done.\n  Querying HuBMAP_ASCTplusB_augmented_2022... Done.\n  Querying Azimuth_2023... Done.\n  Querying CellMarker_2024... Done.\nParsing results... Done.\nUploading data to Enrichr... Done.\n  Querying Tabula_Sapiens... Done.\n  Querying PanglaoDB_Augmented_2021... Done.\n  Querying Azimuth_Cell_Types_2021... Done.\n  Querying HuBMAP_ASCTplusB_augmented_2022... Done.\n  Querying Azimuth_2023... Done.\n  Querying CellMarker_2024... Done.\nParsing results... Done.\nUploading data to Enrichr... Done.\n  Querying Tabula_Sapiens... Done.\n  Querying PanglaoDB_Augmented_2021... Done.\n  Querying Azimuth_Cell_Types_2021... Done.\n  Querying HuBMAP_ASCTplusB_augmented_2022... Done.\n  Querying Azimuth_2023... Done.\n  Querying CellMarker_2024... Done.\nParsing results... Done.\nUploading data to Enrichr... Done.\n  Querying Tabula_Sapiens... Done.\n  Querying PanglaoDB_Augmented_2021... Done.\n  Querying Azimuth_Cell_Types_2021... Done.\n  Querying HuBMAP_ASCTplusB_augmented_2022... Done.\n  Querying Azimuth_2023... Done.\n  Querying CellMarker_2024... Done.\nParsing results... Done.\nUploading data to Enrichr... Done.\n  Querying Tabula_Sapiens... Done.\n  Querying PanglaoDB_Augmented_2021... Done.\n  Querying Azimuth_Cell_Types_2021... Done.\n  Querying HuBMAP_ASCTplusB_augmented_2022... Done.\n  Querying Azimuth_2023... Done.\n  Querying CellMarker_2024... Done.\nParsing results... Done.\nUploading data to Enrichr... Done.\n  Querying Tabula_Sapiens... Done.\n  Querying PanglaoDB_Augmented_2021... Done.\n  Querying Azimuth_Cell_Types_2021... Done.\n  Querying HuBMAP_ASCTplusB_augmented_2022... Done.\n  Querying Azimuth_2023... Done.\n  Querying CellMarker_2024... Done.\nParsing results... Done.\nUploading data to Enrichr... Done.\n  Querying Tabula_Sapiens... Done.\n  Querying PanglaoDB_Augmented_2021... Done.\n  Querying Azimuth_Cell_Types_2021... Done.\n  Querying HuBMAP_ASCTplusB_augmented_2022... Done.\n  Querying Azimuth_2023... Done.\n  Querying CellMarker_2024... Done.\nParsing results... Done.\nUploading data to Enrichr... Done.\n  Querying Tabula_Sapiens... Done.\n  Querying PanglaoDB_Augmented_2021... Done.\n  Querying Azimuth_Cell_Types_2021... Done.\n  Querying HuBMAP_ASCTplusB_augmented_2022... Done.\n  Querying Azimuth_2023... Done.\n  Querying CellMarker_2024... Done.\nParsing results... Done.\nUploading data to Enrichr... Done.\n  Querying Tabula_Sapiens... Done.\n  Querying PanglaoDB_Augmented_2021... Done.\n  Querying Azimuth_Cell_Types_2021... Done.\n  Querying HuBMAP_ASCTplusB_augmented_2022... Done.\n  Querying Azimuth_2023... Done.\n  Querying CellMarker_2024... Done.\nParsing results... Done.\nUploading data to Enrichr... Done.\n  Querying Tabula_Sapiens... Done.\n  Querying PanglaoDB_Augmented_2021... Done.\n  Querying Azimuth_Cell_Types_2021... Done.\n  Querying HuBMAP_ASCTplusB_augmented_2022... Done.\n  Querying Azimuth_2023... Done.\n  Querying CellMarker_2024... Done.\nParsing results... Done.\nUploading data to Enrichr... Done.\n  Querying Tabula_Sapiens... Done.\n  Querying PanglaoDB_Augmented_2021... Done.\n  Querying Azimuth_Cell_Types_2021... Done.\n  Querying HuBMAP_ASCTplusB_augmented_2022... Done.\n  Querying Azimuth_2023... Done.\n  Querying CellMarker_2024... Done.\nParsing results... Done.\nUploading data to Enrichr... Done.\n  Querying Tabula_Sapiens... Done.\n  Querying PanglaoDB_Augmented_2021... Done.\n  Querying Azimuth_Cell_Types_2021... Done.\n  Querying HuBMAP_ASCTplusB_augmented_2022... Done.\n  Querying Azimuth_2023... Done.\n  Querying CellMarker_2024... Done.\nParsing results... Done.\nUploading data to Enrichr... Done.\n  Querying Tabula_Sapiens... Done.\n  Querying PanglaoDB_Augmented_2021... Done.\n  Querying Azimuth_Cell_Types_2021... Done.\n  Querying HuBMAP_ASCTplusB_augmented_2022... Done.\n  Querying Azimuth_2023... Done.\n  Querying CellMarker_2024... Done.\nParsing results... Done.\n\nwrite_tsv(predictions,\"Tumor_scRNA_CellID_enrichR.tsv\")",
    "crumbs": [
      "<span class='chapter-number'>7</span>  <span class='chapter-title'>Tumor: Assisting cell type annotation with enrichR</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part7.html#get-session-info",
    "href": "Tumor_scRNA_Part7.html#get-session-info",
    "title": "7  Tumor: Assisting cell type annotation with enrichR",
    "section": "7.4 Get session info",
    "text": "7.4 Get session info\n\nsessionInfo()\n\nR version 4.3.2 (2023-10-31)\nPlatform: x86_64-pc-linux-gnu (64-bit)\nRunning under: Rocky Linux 8.10 (Green Obsidian)\n\nMatrix products: default\nBLAS/LAPACK: /usr/lib64/libopenblasp-r0.3.15.so;  LAPACK version 3.9.0\n\nlocale:\n [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              \n [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    \n [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   \n [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 \n [9] LC_ADDRESS=C               LC_TELEPHONE=C            \n[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       \n\ntime zone: America/New_York\ntzcode source: system (glibc)\n\nattached base packages:\n[1] stats4    stats     graphics  grDevices utils     datasets  methods  \n[8] base     \n\nother attached packages:\n [1] enrichR_3.2                 cellXY_0.99.0              \n [3] scDblFinder_1.14.0          harmony_1.2.0              \n [5] alevinQC_1.16.1             vctrs_0.6.5                \n [7] patchwork_1.3.0             scater_1.30.1              \n [9] scuttle_1.12.0              speckle_1.0.0              \n[11] Matrix_1.6-4                fishpond_2.6.2             \n[13] readxl_1.4.3                SingleCellExperiment_1.24.0\n[15] SummarizedExperiment_1.32.0 Biobase_2.62.0             \n[17] GenomicRanges_1.54.1        GenomeInfoDb_1.38.8        \n[19] IRanges_2.36.0              S4Vectors_0.40.2           \n[21] BiocGenerics_0.48.1         MatrixGenerics_1.14.0      \n[23] matrixStats_1.4.1           flexmix_2.3-19             \n[25] lattice_0.22-6              SeuratWrappers_0.3.19      \n[27] miQC_1.8.0                  lubridate_1.9.3            \n[29] forcats_1.0.0               stringr_1.5.1              \n[31] dplyr_1.1.4                 purrr_1.0.2                \n[33] readr_2.1.5                 tidyr_1.3.1                \n[35] tibble_3.2.1                ggplot2_3.5.1              \n[37] tidyverse_2.0.0             Seurat_5.1.0               \n[39] SeuratObject_5.0.2          sp_2.1-4                   \n[41] sctransform_0.4.1           glmGamPoi_1.12.2           \n[43] presto_1.0.0                Rcpp_1.0.13-1              \n[45] devtools_2.4.5              usethis_3.0.0              \n[47] data.table_1.16.2          \n\nloaded via a namespace (and not attached):\n  [1] fs_1.6.5                  spatstat.sparse_3.1-0    \n  [3] bitops_1.0-9              httr_1.4.7               \n  [5] RColorBrewer_1.1-3        profvis_0.4.0            \n  [7] tools_4.3.2               utf8_1.2.4               \n  [9] R6_2.5.1                  DT_0.33                  \n [11] lazyeval_0.2.2            uwot_0.2.2               \n [13] urlchecker_1.0.1          withr_3.0.2              \n [15] GGally_2.2.1              gridExtra_2.3            \n [17] progressr_0.15.1          cli_3.6.3                \n [19] spatstat.explore_3.2-6    fastDummies_1.7.3        \n [21] spatstat.data_3.1-4       ggridges_0.5.6           \n [23] pbapply_1.7-2             Rsamtools_2.18.0         \n [25] R.utils_2.12.3            WriteXLS_6.7.0           \n [27] parallelly_1.39.0         sessioninfo_1.2.2        \n [29] limma_3.58.1              RSQLite_2.3.8            \n [31] BiocIO_1.12.0             generics_0.1.3           \n [33] vroom_1.6.5               gtools_3.9.5             \n [35] ica_1.0-3                 spatstat.random_3.2-2    \n [37] ggbeeswarm_0.7.2          fansi_1.0.6              \n [39] abind_1.4-8               R.methodsS3_1.8.2        \n [41] lifecycle_1.0.4           yaml_2.3.10              \n [43] edgeR_4.0.16              SparseArray_1.2.2        \n [45] Rtsne_0.17                blob_1.2.4               \n [47] grid_4.3.2                dqrng_0.4.1              \n [49] promises_1.3.0            crayon_1.5.3             \n [51] shinydashboard_0.7.2      miniUI_0.1.1.1           \n [53] beachmat_2.18.1           cowplot_1.1.3            \n [55] KEGGREST_1.42.0           metapod_1.10.1           \n [57] pillar_1.9.0              knitr_1.45               \n [59] rjson_0.2.23              xgboost_1.7.8.1          \n [61] future.apply_1.11.3       codetools_0.2-20         \n [63] leiden_0.4.3.1            glue_1.8.0               \n [65] remotes_2.5.0             png_0.1-8                \n [67] spam_2.11-0               org.Mm.eg.db_3.18.0      \n [69] cellranger_1.1.0          gtable_0.3.6             \n [71] cachem_1.1.0              xfun_0.49                \n [73] S4Arrays_1.2.0            mime_0.12                \n [75] survival_3.7-0            bluster_1.12.0           \n [77] statmod_1.5.0             ellipsis_0.3.2           \n [79] fitdistrplus_1.2-1        ROCR_1.0-11              \n [81] nlme_3.1-166              bit64_4.5.2              \n [83] RcppAnnoy_0.0.22          irlba_2.3.5.1            \n [85] vipor_0.4.7               KernSmooth_2.23-24       \n [87] DBI_1.2.3                 colorspace_2.1-1         \n [89] nnet_7.3-19               tidyselect_1.2.1         \n [91] curl_6.0.1                bit_4.5.0                \n [93] compiler_4.3.2            BiocNeighbors_1.20.2     \n [95] DelayedArray_0.28.0       plotly_4.10.4            \n [97] rtracklayer_1.62.0        scales_1.3.0             \n [99] lmtest_0.9-40             digest_0.6.37            \n[101] goftest_1.2-3             spatstat.utils_3.1-1     \n[103] rmarkdown_2.29            XVector_0.42.0           \n[105] htmltools_0.5.8.1         pkgconfig_2.0.3          \n[107] sparseMatrixStats_1.14.0  fastmap_1.2.0            \n[109] rlang_1.1.4               htmlwidgets_1.6.4        \n[111] shiny_1.9.1               DelayedMatrixStats_1.24.0\n[113] farver_2.1.2              zoo_1.8-12               \n[115] jsonlite_1.8.9            BiocParallel_1.36.0      \n[117] R.oo_1.27.0               BiocSingular_1.18.0      \n[119] RCurl_1.98-1.16           magrittr_2.0.3           \n[121] modeltools_0.2-23         GenomeInfoDbData_1.2.11  \n[123] dotCall64_1.2             munsell_0.5.1            \n[125] viridis_0.6.5             reticulate_1.35.0        \n[127] stringi_1.8.4             zlibbioc_1.48.2          \n[129] MASS_7.3-60.0.1           org.Hs.eg.db_3.18.0      \n[131] plyr_1.8.9                pkgbuild_1.4.5           \n[133] ggstats_0.7.0             parallel_4.3.2           \n[135] listenv_0.9.1             ggrepel_0.9.6            \n[137] deldir_2.0-4              Biostrings_2.70.3        \n[139] splines_4.3.2             tensor_1.5               \n[141] hms_1.1.3                 locfit_1.5-9.10          \n[143] igraph_2.1.1              spatstat.geom_3.2-8      \n[145] RcppHNSW_0.6.0            reshape2_1.4.4           \n[147] ScaledMatrix_1.10.0       pkgload_1.4.0            \n[149] XML_3.99-0.17             evaluate_1.0.1           \n[151] scran_1.30.2              BiocManager_1.30.25      \n[153] tzdb_0.4.0                httpuv_1.6.15            \n[155] RANN_2.6.2                polyclip_1.10-7          \n[157] future_1.34.0             scattermore_1.2          \n[159] rsvd_1.0.5                xtable_1.8-4             \n[161] restfulr_0.0.15           svMisc_1.2.3             \n[163] RSpectra_0.16-2           later_1.3.2              \n[165] viridisLite_0.4.2         AnnotationDbi_1.64.1     \n[167] GenomicAlignments_1.38.2  memoise_2.0.1            \n[169] beeswarm_0.4.0            tximport_1.28.0          \n[171] cluster_2.1.6             timechange_0.3.0         \n[173] globals_0.16.3",
    "crumbs": [
      "<span class='chapter-number'>7</span>  <span class='chapter-title'>Tumor: Assisting cell type annotation with enrichR</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part8.html",
    "href": "Tumor_scRNA_Part8.html",
    "title": "8  Tumor: Classification of CD4 and CD8 T cell states within T/NK lineage",
    "section": "",
    "text": "8.1 Set up Seurat workspace\n# Load libraries\nlibrary(data.table)\nlibrary(devtools)\nlibrary(presto)\nlibrary(glmGamPoi)\nlibrary(sctransform)\nlibrary(Seurat)\nlibrary(tidyverse)\nlibrary(miQC)\nlibrary(SeuratWrappers)\nlibrary(flexmix)\nlibrary(SingleCellExperiment)\nlibrary(SummarizedExperiment)\nlibrary(readxl)\nlibrary(fishpond)\nlibrary(Matrix)\nlibrary(speckle)\nlibrary(scater)\nlibrary(patchwork)\nlibrary(vctrs)\nlibrary(alevinQC)\nlibrary(harmony)\nlibrary(scDblFinder)\nlibrary(cellXY)\nlibrary(STACAS)\nlibrary(ProjecTILs)\n\n# Set global options for Seurat v5 objects\noptions(Seurat.object.assay.version = 'v5')",
    "crumbs": [
      "<span class='chapter-number'>8</span>  <span class='chapter-title'>Tumor: Classification of CD4 and CD8 T cell states within T/NK lineage</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part8.html#load-previously-saved-sub-clustered-object",
    "href": "Tumor_scRNA_Part8.html#load-previously-saved-sub-clustered-object",
    "title": "8  Tumor: Classification of CD4 and CD8 T cell states within T/NK lineage",
    "section": "8.2 Load previously saved sub-clustered object",
    "text": "8.2 Load previously saved sub-clustered object\n\nmerged.18279.tumor.singlets &lt;- readRDS(\"Tumor_scRNA_Part6.rds\")",
    "crumbs": [
      "<span class='chapter-number'>8</span>  <span class='chapter-title'>Tumor: Classification of CD4 and CD8 T cell states within T/NK lineage</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part8.html#run-cd8-and-cd4-projection-with-projectils-as-in-this-vignette",
    "href": "Tumor_scRNA_Part8.html#run-cd8-and-cd4-projection-with-projectils-as-in-this-vignette",
    "title": "8  Tumor: Classification of CD4 and CD8 T cell states within T/NK lineage",
    "section": "8.3 Run CD8 and CD4 projection with projecTILs as in this vignette",
    "text": "8.3 Run CD8 and CD4 projection with projecTILs as in this vignette\nNote these classifications are limited only to CD4/CD8 and do not include NK cells\n\n8.3.1 Retrieve human CD8 and CD4 reference maps\n\noptions(timeout = max(900, getOption(\"timeout\")))\ndownload.file(\"https://figshare.com/ndownloader/files/41414556\", destfile = \"CD8T_human_ref_v1.rds\")\ndownload.file(\"https://figshare.com/ndownloader/files/43794750\", destfile = \"CD4T_human_ref_v2.rds\")\n\n\n\n8.3.2 Load reference maps\n\nref.cd8 &lt;- load.reference.map(\"CD8T_human_ref_v1.rds\")\n\n[1] \"Loading Custom Reference Atlas...\"\n[1] \"Loaded Custom Reference map Human CD8 TILs\"\n\nref.cd4 &lt;- load.reference.map(\"CD4T_human_ref_v2.rds\")\n\n[1] \"Loading Custom Reference Atlas...\"\n[1] \"Loaded Custom Reference map custom_reference\"\n\n\n\n\n8.3.3 Plot reference atlases\n\na &lt;- DimPlot(ref.cd8, cols = ref.cd8@misc$atlas.palette, label = T) + theme(aspect.ratio = 1) +\n    ggtitle(\"CD8 T reference\") + NoLegend()\n\nb &lt;- DimPlot(ref.cd4, cols = ref.cd4@misc$atlas.palette, label = T) + theme(aspect.ratio = 1) +\n    ggtitle(\"CD4 T reference\") + NoLegend()\n\na | b\n\n\n\n\n\n\n\n\n\n\n8.3.4 Classify CD8 T subtypes\n\nmerged.18279.tumor.singlets &lt;- ProjecTILs.classifier(merged.18279.tumor.singlets, ref.cd8, ncores = 8, split.by = \"Sample\")\n\n\n  |                                                                            \n  |                                                                      |   0%[1] \"Using assay RNA for query\"\n[1] \"2345 out of 2353 ( 100% ) non-pure cells removed. Use filter.cells=FALSE to avoid pre-filtering\"\nPerforming log-normalization\n0%   10   20   30   40   50   60   70   80   90   100%\n[----|----|----|----|----|----|----|----|----|----|\n**************************************************|\n[1] \"Aligning query to reference map for batch-correction...\"\n[1] \"DIRECTLY projecting query onto Reference PCA space\"\n[1] \"DIRECTLY projecting query onto Reference UMAP space\"\n\n  |                                                                            \n  |======================================================================| 100%\n\n\n\n  |                                                                            \n  |                                                                      |   0%[1] \"Using assay RNA for query\"\n[1] \"611 out of 719 ( 85% ) non-pure cells removed. Use filter.cells=FALSE to avoid pre-filtering\"\nPerforming log-normalization\n0%   10   20   30   40   50   60   70   80   90   100%\n[----|----|----|----|----|----|----|----|----|----|\n**************************************************|\n[1] \"Aligning query to reference map for batch-correction...\"\n\nProjecting corrected query onto Reference PCA space\n\nProjecting corrected query onto Reference UMAP space\n\n  |                                                                            \n  |======================================================================| 100%\n\n\n\n  |                                                                            \n  |                                                                      |   0%[1] \"Using assay RNA for query\"\n[1] \"958 out of 1020 ( 94% ) non-pure cells removed. Use filter.cells=FALSE to avoid pre-filtering\"\nPerforming log-normalization\n0%   10   20   30   40   50   60   70   80   90   100%\n[----|----|----|----|----|----|----|----|----|----|\n**************************************************|\n[1] \"Aligning query to reference map for batch-correction...\"\n\nProjecting corrected query onto Reference PCA space\n\nProjecting corrected query onto Reference UMAP space\n\n  |                                                                            \n  |======================================================================| 100%\n\n\n\n  |                                                                            \n  |                                                                      |   0%[1] \"Using assay RNA for query\"\n[1] \"1881 out of 2397 ( 78% ) non-pure cells removed. Use filter.cells=FALSE to avoid pre-filtering\"\nPerforming log-normalization\n0%   10   20   30   40   50   60   70   80   90   100%\n[----|----|----|----|----|----|----|----|----|----|\n**************************************************|\n[1] \"Aligning query to reference map for batch-correction...\"\n\nProjecting corrected query onto Reference PCA space\n\nProjecting corrected query onto Reference UMAP space\n\n  |                                                                            \n  |======================================================================| 100%\n\n\n\n  |                                                                            \n  |                                                                      |   0%[1] \"Using assay RNA for query\"\n[1] \"2670 out of 2838 ( 94% ) non-pure cells removed. Use filter.cells=FALSE to avoid pre-filtering\"\nPerforming log-normalization\n0%   10   20   30   40   50   60   70   80   90   100%\n[----|----|----|----|----|----|----|----|----|----|\n**************************************************|\n[1] \"Aligning query to reference map for batch-correction...\"\n\nProjecting corrected query onto Reference PCA space\n\nProjecting corrected query onto Reference UMAP space\n\n  |                                                                            \n  |======================================================================| 100%\n\n\n\n  |                                                                            \n  |                                                                      |   0%[1] \"Using assay RNA for query\"\n[1] \"1462 out of 3380 ( 43% ) non-pure cells removed. Use filter.cells=FALSE to avoid pre-filtering\"\nPerforming log-normalization\n0%   10   20   30   40   50   60   70   80   90   100%\n[----|----|----|----|----|----|----|----|----|----|\n**************************************************|\n[1] \"Aligning query to reference map for batch-correction...\"\n\nProjecting corrected query onto Reference PCA space\n\nProjecting corrected query onto Reference UMAP space\n\n  |                                                                            \n  |======================================================================| 100%\n\n\n\n  |                                                                            \n  |                                                                      |   0%[1] \"Using assay RNA for query\"\n[1] \"3488 out of 3572 ( 98% ) non-pure cells removed. Use filter.cells=FALSE to avoid pre-filtering\"\nPerforming log-normalization\n0%   10   20   30   40   50   60   70   80   90   100%\n[----|----|----|----|----|----|----|----|----|----|\n**************************************************|\n[1] \"Aligning query to reference map for batch-correction...\"\n\nProjecting corrected query onto Reference PCA space\n\nProjecting corrected query onto Reference UMAP space\n\n  |                                                                            \n  |======================================================================| 100%\n\n\n\n  |                                                                            \n  |                                                                      |   0%[1] \"Using assay RNA for query\"\n[1] \"2148 out of 3697 ( 58% ) non-pure cells removed. Use filter.cells=FALSE to avoid pre-filtering\"\nPerforming log-normalization\n0%   10   20   30   40   50   60   70   80   90   100%\n[----|----|----|----|----|----|----|----|----|----|\n**************************************************|\n[1] \"Aligning query to reference map for batch-correction...\"\n\nProjecting corrected query onto Reference PCA space\n\nProjecting corrected query onto Reference UMAP space\n\n  |                                                                            \n  |======================================================================| 100%\n\n\n\n\n8.3.5 Classify CD4 T subtypes\n\nmerged.18279.tumor.singlets &lt;- ProjecTILs.classifier(merged.18279.tumor.singlets, ref.cd4, ncores = 8, split.by = \"Sample\", overwrite = F)\n\n\n  |                                                                            \n  |                                                                      |   0%[1] \"Using assay RNA for query\"\n[1] \"2335 out of 2353 ( 99% ) non-pure cells removed. Use filter.cells=FALSE to avoid pre-filtering\"\nPerforming log-normalization\n0%   10   20   30   40   50   60   70   80   90   100%\n[----|----|----|----|----|----|----|----|----|----|\n**************************************************|\n[1] \"Aligning query to reference map for batch-correction...\"\n[1] \"DIRECTLY projecting query onto Reference PCA space\"\n[1] \"DIRECTLY projecting query onto Reference UMAP space\"\n\n  |                                                                            \n  |======================================================================| 100%\n\n\n\n  |                                                                            \n  |                                                                      |   0%[1] \"Using assay RNA for query\"\n[1] \"872 out of 1020 ( 85% ) non-pure cells removed. Use filter.cells=FALSE to avoid pre-filtering\"\nPerforming log-normalization\n0%   10   20   30   40   50   60   70   80   90   100%\n[----|----|----|----|----|----|----|----|----|----|\n**************************************************|\n[1] \"Aligning query to reference map for batch-correction...\"\n\nProjecting corrected query onto Reference PCA space\n\nProjecting corrected query onto Reference UMAP space\n\n  |                                                                            \n  |======================================================================| 100%\n\n\n\n  |                                                                            \n  |                                                                      |   0%[1] \"Using assay RNA for query\"\n[1] \"668 out of 719 ( 93% ) non-pure cells removed. Use filter.cells=FALSE to avoid pre-filtering\"\nPerforming log-normalization\n0%   10   20   30   40   50   60   70   80   90   100%\n[----|----|----|----|----|----|----|----|----|----|\n**************************************************|\n[1] \"Aligning query to reference map for batch-correction...\"\n\nProjecting corrected query onto Reference PCA space\n\nProjecting corrected query onto Reference UMAP space\n\n  |                                                                            \n  |======================================================================| 100%\n\n\n\n  |                                                                            \n  |                                                                      |   0%[1] \"Using assay RNA for query\"\n[1] \"1937 out of 2397 ( 81% ) non-pure cells removed. Use filter.cells=FALSE to avoid pre-filtering\"\nPerforming log-normalization\n0%   10   20   30   40   50   60   70   80   90   100%\n[----|----|----|----|----|----|----|----|----|----|\n**************************************************|\n[1] \"Aligning query to reference map for batch-correction...\"\n\nProjecting corrected query onto Reference PCA space\n\nProjecting corrected query onto Reference UMAP space\n\n  |                                                                            \n  |======================================================================| 100%\n\n\n\n  |                                                                            \n  |                                                                      |   0%[1] \"Using assay RNA for query\"\n[1] \"2824 out of 3380 ( 84% ) non-pure cells removed. Use filter.cells=FALSE to avoid pre-filtering\"\nPerforming log-normalization\n0%   10   20   30   40   50   60   70   80   90   100%\n[----|----|----|----|----|----|----|----|----|----|\n**************************************************|\n[1] \"Aligning query to reference map for batch-correction...\"\n\nProjecting corrected query onto Reference PCA space\n\nProjecting corrected query onto Reference UMAP space\n\n  |                                                                            \n  |======================================================================| 100%\n\n\n\n  |                                                                            \n  |                                                                      |   0%[1] \"Using assay RNA for query\"\n[1] \"2600 out of 2838 ( 92% ) non-pure cells removed. Use filter.cells=FALSE to avoid pre-filtering\"\nPerforming log-normalization\n0%   10   20   30   40   50   60   70   80   90   100%\n[----|----|----|----|----|----|----|----|----|----|\n**************************************************|\n[1] \"Aligning query to reference map for batch-correction...\"\n\nProjecting corrected query onto Reference PCA space\n\nProjecting corrected query onto Reference UMAP space\n\n  |                                                                            \n  |======================================================================| 100%\n\n\n\n  |                                                                            \n  |                                                                      |   0%[1] \"Using assay RNA for query\"\n[1] \"3074 out of 3697 ( 83% ) non-pure cells removed. Use filter.cells=FALSE to avoid pre-filtering\"\nPerforming log-normalization\n0%   10   20   30   40   50   60   70   80   90   100%\n[----|----|----|----|----|----|----|----|----|----|\n**************************************************|\n[1] \"Aligning query to reference map for batch-correction...\"\n\nProjecting corrected query onto Reference PCA space\n\nProjecting corrected query onto Reference UMAP space\n\n  |                                                                            \n  |======================================================================| 100%\n\n\n\n  |                                                                            \n  |                                                                      |   0%[1] \"Using assay RNA for query\"\n[1] \"3464 out of 3572 ( 97% ) non-pure cells removed. Use filter.cells=FALSE to avoid pre-filtering\"\nPerforming log-normalization\n0%   10   20   30   40   50   60   70   80   90   100%\n[----|----|----|----|----|----|----|----|----|----|\n**************************************************|\n[1] \"Aligning query to reference map for batch-correction...\"\n\nProjecting corrected query onto Reference PCA space\n\nProjecting corrected query onto Reference UMAP space\n\n  |                                                                            \n  |======================================================================| 100%",
    "crumbs": [
      "<span class='chapter-number'>8</span>  <span class='chapter-title'>Tumor: Classification of CD4 and CD8 T cell states within T/NK lineage</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part8.html#tabulate-and-visualize-projections",
    "href": "Tumor_scRNA_Part8.html#tabulate-and-visualize-projections",
    "title": "8  Tumor: Classification of CD4 and CD8 T cell states within T/NK lineage",
    "section": "8.4 Tabulate and visualize projections",
    "text": "8.4 Tabulate and visualize projections\nIn addition to guiding annotation, these projected cell states can be quantified downstream comparing pre vs post-vaccine, tumor samples over time, or to characterize the phenotypes of T-cells that have expanded with vaccination\n\n8.4.1 Count total cells by T cell state\n\ntable(merged.18279.tumor.singlets$functional.cluster, useNA = \"ifany\")\n\n\nCD4.CTL_EOMES   CD4.CTL_Exh  CD4.CTL_GNLY    CD4.Memory CD4.NaiveLike \n          597           186            47           585           324 \n      CD4.Tfh      CD4.Th17      CD4.Treg        CD8.CM        CD8.EM \n          208             7           230           383          1726 \n     CD8.MAIT CD8.NaiveLike     CD8.TEMRA       CD8.TEX      CD8.TPEX \n           16            79            56          1342           793 \n         &lt;NA&gt; \n        13397 \n\n\n\n\n8.4.2 Tabulate which T cell state was most abundant in each subcluster\n\nas.data.frame(table(merged.18279.tumor.singlets$sub.cluster, merged.18279.tumor.singlets$functional.cluster, useNA = \"ifany\")) %&gt;%\n    as_tibble() %&gt;%\n    dplyr::rename(\"Cluster\" = Var1, \"CellState\" = Var2) %&gt;%\n    group_by(Cluster) %&gt;%\n    slice_max(Freq,n=1) %&gt;%\n    inner_join(enframe(table(merged.18279.tumor.singlets$sub.cluster),name=\"Cluster\",value=\"TotalCount\"),by=\"Cluster\") %&gt;%\n    as.data.frame()\n\n   Cluster     CellState Freq TotalCount\n1        0          &lt;NA&gt; 3244       3244\n2      1_0       CD8.TEX 1159       2596\n3      1_1        CD8.EM  154        236\n4       10          &lt;NA&gt;  671        671\n5       11          &lt;NA&gt;  645        645\n6     12_0 CD4.CTL_EOMES  280        486\n7     12_1       CD4.Tfh   93        115\n8       13          &lt;NA&gt;  469        469\n9       14          &lt;NA&gt;  447        449\n10      15          &lt;NA&gt;  370        370\n11    16_0      CD4.Treg  202        364\n12      17          &lt;NA&gt;  336        336\n13    18_0          &lt;NA&gt;  148        167\n14    18_1          &lt;NA&gt;  104        106\n15      19          &lt;NA&gt;  265        265\n16     2_0        CD8.EM  444       1142\n17     2_1      CD8.TPEX  163        196\n18      20          &lt;NA&gt;  249        249\n19      21          &lt;NA&gt;  228        228\n20    22_0    CD4.Memory   50        106\n21    22_1        CD8.EM   49         70\n22    22_2        CD8.EM   13         25\n23      23          &lt;NA&gt;  113        113\n24      24          &lt;NA&gt;   77         77\n25      25          &lt;NA&gt;   74         74\n26    26_0       CD8.TEX   13         55\n27      27          &lt;NA&gt;   33         33\n28      28          &lt;NA&gt;   30         30\n29      29          &lt;NA&gt;   27         27\n30     3_0    CD4.Memory  463       1129\n31     3_1 CD4.CTL_EOMES   58         85\n32       4          &lt;NA&gt; 1171       1171\n33       5          &lt;NA&gt; 1151       1151\n34       6          &lt;NA&gt;  954        955\n35       7          &lt;NA&gt;  934        934\n36       8          &lt;NA&gt;  849        849\n37     9_0          &lt;NA&gt;  183        455\n38     9_1          &lt;NA&gt;  146        303\n\n\n\n\n8.4.3 Plot UMAP of all cells labeled by projected T cell state\n\nDimPlot(merged.18279.tumor.singlets, group.by = \"functional.cluster\", reduction=\"umap.harmony\")\n\n\n\n\n\n\n\n\n\n\n8.4.4 Plot just T/NK cell lineage\n\ntnk_clusters &lt;- sort(str_subset(unique(merged.18279.tumor.singlets$sub.cluster),\"_\"))\ntnk_clusters\n\n [1] \"1_0\"  \"1_1\"  \"12_0\" \"12_1\" \"16_0\" \"18_0\" \"18_1\" \"2_0\"  \"2_1\"  \"22_0\"\n[11] \"22_1\" \"22_2\" \"26_0\" \"3_0\"  \"3_1\"  \"9_0\"  \"9_1\" \n\ntnk_cells &lt;- WhichCells(merged.18279.tumor.singlets,idents = tnk_clusters)\nDimPlot(merged.18279.tumor.singlets, \n    group.by = \"functional.cluster\", \n    reduction=\"umap.harmony\",\n    cells = tnk_cells)",
    "crumbs": [
      "<span class='chapter-number'>8</span>  <span class='chapter-title'>Tumor: Classification of CD4 and CD8 T cell states within T/NK lineage</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part8.html#save-modified-object",
    "href": "Tumor_scRNA_Part8.html#save-modified-object",
    "title": "8  Tumor: Classification of CD4 and CD8 T cell states within T/NK lineage",
    "section": "8.5 Save modified object",
    "text": "8.5 Save modified object\n\nsaveRDS(merged.18279.tumor.singlets, \"Tumor_scRNA_Part8.rds\")",
    "crumbs": [
      "<span class='chapter-number'>8</span>  <span class='chapter-title'>Tumor: Classification of CD4 and CD8 T cell states within T/NK lineage</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part8.html#get-session-info",
    "href": "Tumor_scRNA_Part8.html#get-session-info",
    "title": "8  Tumor: Classification of CD4 and CD8 T cell states within T/NK lineage",
    "section": "8.6 Get session info",
    "text": "8.6 Get session info\n\nsessionInfo()\n\nR version 4.3.2 (2023-10-31)\nPlatform: x86_64-pc-linux-gnu (64-bit)\nRunning under: Rocky Linux 8.10 (Green Obsidian)\n\nMatrix products: default\nBLAS/LAPACK: /usr/lib64/libopenblasp-r0.3.15.so;  LAPACK version 3.9.0\n\nlocale:\n [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              \n [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    \n [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   \n [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 \n [9] LC_ADDRESS=C               LC_TELEPHONE=C            \n[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       \n\ntime zone: America/New_York\ntzcode source: system (glibc)\n\nattached base packages:\n[1] stats4    stats     graphics  grDevices utils     datasets  methods  \n[8] base     \n\nother attached packages:\n [1] ProjecTILs_3.3.1            STACAS_2.2.2               \n [3] cellXY_0.99.0               scDblFinder_1.14.0         \n [5] harmony_1.2.0               alevinQC_1.16.1            \n [7] vctrs_0.6.5                 patchwork_1.3.0            \n [9] scater_1.30.1               scuttle_1.12.0             \n[11] speckle_1.0.0               Matrix_1.6-4               \n[13] fishpond_2.6.2              readxl_1.4.3               \n[15] SingleCellExperiment_1.24.0 SummarizedExperiment_1.32.0\n[17] Biobase_2.62.0              GenomicRanges_1.54.1       \n[19] GenomeInfoDb_1.38.8         IRanges_2.36.0             \n[21] S4Vectors_0.40.2            BiocGenerics_0.48.1        \n[23] MatrixGenerics_1.14.0       matrixStats_1.4.1          \n[25] flexmix_2.3-19              lattice_0.22-6             \n[27] SeuratWrappers_0.3.19       miQC_1.8.0                 \n[29] lubridate_1.9.3             forcats_1.0.0              \n[31] stringr_1.5.1               dplyr_1.1.4                \n[33] purrr_1.0.2                 readr_2.1.5                \n[35] tidyr_1.3.1                 tibble_3.2.1               \n[37] ggplot2_3.5.1               tidyverse_2.0.0            \n[39] Seurat_5.1.0                SeuratObject_5.0.2         \n[41] sp_2.1-4                    sctransform_0.4.1          \n[43] glmGamPoi_1.12.2            presto_1.0.0               \n[45] Rcpp_1.0.13-1               devtools_2.4.5             \n[47] usethis_3.0.0               data.table_1.16.2          \n\nloaded via a namespace (and not attached):\n  [1] fs_1.6.5                  spatstat.sparse_3.1-0    \n  [3] bitops_1.0-9              httr_1.4.7               \n  [5] RColorBrewer_1.1-3        profvis_0.4.0            \n  [7] tools_4.3.2               utf8_1.2.4               \n  [9] R6_2.5.1                  DT_0.33                  \n [11] lazyeval_0.2.2            uwot_0.2.2               \n [13] urlchecker_1.0.1          withr_3.0.2              \n [15] GGally_2.2.1              gridExtra_2.3            \n [17] progressr_0.15.1          cli_3.6.3                \n [19] spatstat.explore_3.2-6    fastDummies_1.7.3        \n [21] labeling_0.4.3            spatstat.data_3.1-4      \n [23] askpass_1.2.0             ggridges_0.5.6           \n [25] pbapply_1.7-2             Rsamtools_2.18.0         \n [27] R.utils_2.12.3            parallelly_1.39.0        \n [29] sessioninfo_1.2.2         limma_3.58.1             \n [31] RSQLite_2.3.8             BiocIO_1.12.0            \n [33] generics_0.1.3            gtools_3.9.5             \n [35] ica_1.0-3                 spatstat.random_3.2-2    \n [37] ggbeeswarm_0.7.2          fansi_1.0.6              \n [39] abind_1.4-8               R.methodsS3_1.8.2        \n [41] lifecycle_1.0.4           yaml_2.3.10              \n [43] edgeR_4.0.16              SparseArray_1.2.2        \n [45] Rtsne_0.17                blob_1.2.4               \n [47] grid_4.3.2                dqrng_0.4.1              \n [49] promises_1.3.0            crayon_1.5.3             \n [51] shinydashboard_0.7.2      miniUI_0.1.1.1           \n [53] beachmat_2.18.1           cowplot_1.1.3            \n [55] KEGGREST_1.42.0           scGate_1.6.0             \n [57] metapod_1.10.1            pillar_1.9.0             \n [59] knitr_1.45                rjson_0.2.23             \n [61] xgboost_1.7.8.1           future.apply_1.11.3      \n [63] codetools_0.2-20          leiden_0.4.3.1           \n [65] glue_1.8.0                remotes_2.5.0            \n [67] png_0.1-8                 spam_2.11-0              \n [69] org.Mm.eg.db_3.18.0       cellranger_1.1.0         \n [71] gtable_0.3.6              cachem_1.1.0             \n [73] xfun_0.49                 S4Arrays_1.2.0           \n [75] mime_0.12                 pracma_2.4.4             \n [77] survival_3.7-0            pheatmap_1.0.12          \n [79] bluster_1.12.0            statmod_1.5.0            \n [81] ellipsis_0.3.2            fitdistrplus_1.2-1       \n [83] ROCR_1.0-11               nlme_3.1-166             \n [85] bit64_4.5.2               RcppAnnoy_0.0.22         \n [87] irlba_2.3.5.1             vipor_0.4.7              \n [89] KernSmooth_2.23-24        DBI_1.2.3                \n [91] colorspace_2.1-1          nnet_7.3-19              \n [93] UCell_2.6.2               tidyselect_1.2.1         \n [95] bit_4.5.0                 compiler_4.3.2           \n [97] BiocNeighbors_1.20.2      DelayedArray_0.28.0      \n [99] plotly_4.10.4             rtracklayer_1.62.0       \n[101] scales_1.3.0              lmtest_0.9-40            \n[103] digest_0.6.37             goftest_1.2-3            \n[105] spatstat.utils_3.1-1      rmarkdown_2.29           \n[107] XVector_0.42.0            htmltools_0.5.8.1        \n[109] pkgconfig_2.0.3           umap_0.2.10.0            \n[111] sparseMatrixStats_1.14.0  fastmap_1.2.0            \n[113] rlang_1.1.4               htmlwidgets_1.6.4        \n[115] shiny_1.9.1               DelayedMatrixStats_1.24.0\n[117] farver_2.1.2              zoo_1.8-12               \n[119] jsonlite_1.8.9            BiocParallel_1.36.0      \n[121] R.oo_1.27.0               BiocSingular_1.18.0      \n[123] RCurl_1.98-1.16           magrittr_2.0.3           \n[125] modeltools_0.2-23         GenomeInfoDbData_1.2.11  \n[127] dotCall64_1.2             munsell_0.5.1            \n[129] viridis_0.6.5             reticulate_1.35.0        \n[131] stringi_1.8.4             zlibbioc_1.48.2          \n[133] MASS_7.3-60.0.1           org.Hs.eg.db_3.18.0      \n[135] plyr_1.8.9                pkgbuild_1.4.5           \n[137] ggstats_0.7.0             parallel_4.3.2           \n[139] listenv_0.9.1             ggrepel_0.9.6            \n[141] deldir_2.0-4              Biostrings_2.70.3        \n[143] splines_4.3.2             tensor_1.5               \n[145] hms_1.1.3                 locfit_1.5-9.10          \n[147] igraph_2.1.1              spatstat.geom_3.2-8      \n[149] RcppHNSW_0.6.0            reshape2_1.4.4           \n[151] ScaledMatrix_1.10.0       pkgload_1.4.0            \n[153] XML_3.99-0.17             evaluate_1.0.1           \n[155] scran_1.30.2              BiocManager_1.30.25      \n[157] tzdb_0.4.0                httpuv_1.6.15            \n[159] openssl_2.2.2             RANN_2.6.2               \n[161] polyclip_1.10-7           future_1.34.0            \n[163] scattermore_1.2           rsvd_1.0.5               \n[165] xtable_1.8-4              restfulr_0.0.15          \n[167] svMisc_1.2.3              RSpectra_0.16-2          \n[169] later_1.3.2               viridisLite_0.4.2        \n[171] AnnotationDbi_1.64.1      GenomicAlignments_1.38.2 \n[173] memoise_2.0.1             beeswarm_0.4.0           \n[175] tximport_1.28.0           cluster_2.1.6            \n[177] timechange_0.3.0          globals_0.16.3",
    "crumbs": [
      "<span class='chapter-number'>8</span>  <span class='chapter-title'>Tumor: Classification of CD4 and CD8 T cell states within T/NK lineage</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part9.html",
    "href": "Tumor_scRNA_Part9.html",
    "title": "9  Tumor: Deep phenotyping, cluster annotation, and exploration of tumor cells",
    "section": "",
    "text": "9.1 Set up Seurat workspace\n# Load libraries\nlibrary(presto)\nlibrary(Seurat)\nlibrary(tidyverse)\nlibrary(patchwork)\nlibrary(paletteer)\nlibrary(msigdbr)\nlibrary(ComplexHeatmap)\nlibrary(circlize)\nlibrary(lemon)\nlibrary(muscat)\nlibrary(scater)",
    "crumbs": [
      "<span class='chapter-number'>9</span>  <span class='chapter-title'>Tumor: Deep phenotyping, cluster annotation, and exploration of tumor cells</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part9.html#load-scrna-analysis-seurat-object",
    "href": "Tumor_scRNA_Part9.html#load-scrna-analysis-seurat-object",
    "title": "9  Tumor: Deep phenotyping, cluster annotation, and exploration of tumor cells",
    "section": "9.2 Load scRNA analysis seurat object",
    "text": "9.2 Load scRNA analysis seurat object\n\nmerged.18279.tumor.singlets &lt;- readRDS(\"Tumor_scRNA_Part8.rds\")",
    "crumbs": [
      "<span class='chapter-number'>9</span>  <span class='chapter-title'>Tumor: Deep phenotyping, cluster annotation, and exploration of tumor cells</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part9.html#set-up-cluster-groupings-by-cell-class",
    "href": "Tumor_scRNA_Part9.html#set-up-cluster-groupings-by-cell-class",
    "title": "9  Tumor: Deep phenotyping, cluster annotation, and exploration of tumor cells",
    "section": "9.3 Set up cluster groupings by cell class",
    "text": "9.3 Set up cluster groupings by cell class\n\ncluster_annot &lt;- c(\n        \"8\" = \"Macrophage\",\n        \"15\" = \"MonoMac\",\n        \"28\" = \"pDC\",\n        \"17\" = \"B_cells\",\n        \"13\" = \"Plasma_cells\",\n        \"2_1\" = \"CD8_TPEX\",\n        \"1_0\" = \"CD8_TEX\",\n        \"1_1\" = \"CD8_T_EM_1\",\n        \"2_0\" = \"CD8_T_EM_2\",\n        \"22_1\" = \"CD8_T_EM_3\",\n        \"22_2\" = \"CD8_T_EM_4\",\n        \"26_0\" = \"CD8_T_proliferating\",\n        \"3_0\" = \"CD4_T_Memory_1\",\n        \"22_0\" = \"CD4_T_Memory_2\",\n        \"3_1\" = \"CD4_T_CTL_1\",\n        \"12_0\" = \"CD4_T_CTL_2\",\n        \"12_1\" = \"CD4_Tfh\",\n        \"16_0\" = \"Treg\",\n        \"9_0\" = \"T_unknown_1\",\n        \"9_1\" = \"T_unknown_2\",\n        \"18_0\" = \"NK/T_1\",\n        \"18_1\" = \"NK/T_2\",\n        \"29\" = \"Mast\",\n        \"0\" = \"Melanoma_1\",\n        \"4\" = \"Melanoma_2\",\n        \"5\" = \"Melanoma_3\",\n        \"6\" = \"Melanoma_4\",\n        \"11\" = \"Melanoma_5\",\n        \"23\" = \"Melanoma_6\",\n        \"25\" = \"Melanoma_7\",\n        \"14\" = \"Melanoma_proliferating\",\n        \"21\" = \"Melanocytes\",\n        \"7\" = \"Endothelial_1\",\n        \"27\" = \"Endothelial_2\",\n        \"10\" = \"Fibroblasts_1\",\n        \"20\" = \"Fibroblasts_2\",\n        \"19\" = \"Pericytes/SmoothMuscle\",\n        \"24\" = \"Basal\"\n)\nclustLabels &lt;- as.data.frame(cluster_annot)[merged.18279.tumor.singlets$sub.cluster,]\nmerged.18279.tumor.singlets &lt;- AddMetaData(merged.18279.tumor.singlets, list(clustLabels), col.name = \"CellAnnotation\")",
    "crumbs": [
      "<span class='chapter-number'>9</span>  <span class='chapter-title'>Tumor: Deep phenotyping, cluster annotation, and exploration of tumor cells</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part9.html#set-up-broader-cell-classes",
    "href": "Tumor_scRNA_Part9.html#set-up-broader-cell-classes",
    "title": "9  Tumor: Deep phenotyping, cluster annotation, and exploration of tumor cells",
    "section": "9.4 Set up broader cell classes",
    "text": "9.4 Set up broader cell classes\n\ncluster_classes &lt;- enframe(cluster_annot,name = \"sub.cluster\",value = \"CellAnnotation\") %&gt;%\n  as_tibble() %&gt;%\n  mutate(CellClass = case_when(\n    sub.cluster %in% c(\"8\",\"15\") ~ \"Monocyte/\\nMacrophage\",\n    sub.cluster %in% c(\"28\") ~ \"DC\",\n    sub.cluster %in% c(\"17\",\"13\") ~ \"B\",\n    sub.cluster %in% c(\"1_0\",\"1_1\",\"2_0\",\"2_1\",\"22_1\",\"22_2\",\"26_0\",\"3_0\",\"3_1\",\"12_0\",\"12_1\",\"22_0\",\"16_0\",\"9_0\",\"9_1\",\"18_0\",\"18_1\") ~ \"NK/T\",\n    sub.cluster %in% c(\"29\") ~ \"Mast\",\n    sub.cluster %in% c(\"0\",\"4\",\"5\",\"6\",\"11\",\"23\",\"25\",\"14\") ~ \"Melanoma\",\n    sub.cluster %in% c(\"21\",\"7\",\"27\",\"10\",\"20\",\"19\",\"24\") ~ \"Non-immune\"\n    )\n  ) %&gt;%\n  dplyr::select(-CellAnnotation) %&gt;%\n  column_to_rownames(var = \"sub.cluster\") %&gt;%\n  as.data.frame()\n\nclustClasses &lt;- cluster_classes[merged.18279.tumor.singlets$sub.cluster,]\nmerged.18279.tumor.singlets &lt;- AddMetaData(merged.18279.tumor.singlets, list(clustClasses), col.name = \"CellClass\")",
    "crumbs": [
      "<span class='chapter-number'>9</span>  <span class='chapter-title'>Tumor: Deep phenotyping, cluster annotation, and exploration of tumor cells</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part9.html#plot-original-umap-labeled-by-sub-cluster",
    "href": "Tumor_scRNA_Part9.html#plot-original-umap-labeled-by-sub-cluster",
    "title": "9  Tumor: Deep phenotyping, cluster annotation, and exploration of tumor cells",
    "section": "9.5 Plot original UMAP labeled by sub-cluster",
    "text": "9.5 Plot original UMAP labeled by sub-cluster\n\nmerged.18279.tumor.singlets$CellAnnotation &lt;- factor(x = merged.18279.tumor.singlets$CellAnnotation, \n                                                    levels = as.character(cluster_annot))\nDimPlot(merged.18279.tumor.singlets, \n        label = FALSE, \n        reduction = \"umap.harmony\",\n        group.by = \"CellAnnotation\")\n\n\n\n\n\n\n\n\n\n9.5.1 Plot again split by Timepoint\n\nmerged.18279.tumor.singlets$CellAnnotation &lt;- factor(x = merged.18279.tumor.singlets$CellAnnotation, \n                                                    levels = as.character(cluster_annot))\nmerged.18279.tumor.singlets$Timepoint &lt;- factor(x = merged.18279.tumor.singlets$Timepoint, levels = c(\"W00\", \"W12\", \"W20\", \"PD\"))\n\nDimPlot(merged.18279.tumor.singlets, \n        label = FALSE, \n        reduction = \"umap.harmony\",\n        group.by = \"CellAnnotation\",\n        split.by = \"Timepoint\") +\n  theme_classic() +\n  theme(panel.border = element_rect(colour = \"black\",fill = NA)\n        )",
    "crumbs": [
      "<span class='chapter-number'>9</span>  <span class='chapter-title'>Tumor: Deep phenotyping, cluster annotation, and exploration of tumor cells</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part9.html#plot-original-umap-labeled-by-broader-cell-class",
    "href": "Tumor_scRNA_Part9.html#plot-original-umap-labeled-by-broader-cell-class",
    "title": "9  Tumor: Deep phenotyping, cluster annotation, and exploration of tumor cells",
    "section": "9.6 Plot original UMAP labeled by broader cell class",
    "text": "9.6 Plot original UMAP labeled by broader cell class\n\nDimPlot(merged.18279.tumor.singlets, \n        label = FALSE, \n        reduction = \"umap.harmony\",\n        group.by = \"CellClass\") +\n  scale_color_manual(values = c(\"#5AAE61\", \n                                 \"#D9F0D3\", \n                                 \"#E08214\", \n                                 \"#762A83\", \n                                 \"gray50\", \n                                 paletteer_d(\"ggsci::brown_material\")[3], \n                                 \"gray90\"),\n                      limits=unique(cluster_classes$CellClass)\n        )\n\n\n\n\n\n\n\n\n\n9.6.1 Plot again except split by Timepoint\n\nDimPlot(merged.18279.tumor.singlets, \n        label = FALSE, \n        reduction = \"umap.harmony\",\n        split.by = \"Timepoint\",\n        group.by = \"CellClass\") +\n  theme_classic() +\n  theme(panel.border = element_rect(colour = \"black\",fill = NA)\n        ) +\n  scale_color_manual(values = c(\"#5AAE61\", \n                                 \"#D9F0D3\", \n                                 \"#E08214\", \n                                 \"#762A83\", \n                                 \"gray50\", \n                                 paletteer_d(\"ggsci::brown_material\")[3], \n                                 \"gray90\"),\n                      limits=unique(cluster_classes$CellClass)\n        )",
    "crumbs": [
      "<span class='chapter-number'>9</span>  <span class='chapter-title'>Tumor: Deep phenotyping, cluster annotation, and exploration of tumor cells</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part9.html#plot-large-heatmap-demonstrating-marker-gene-selectivity-and-cluster-identity",
    "href": "Tumor_scRNA_Part9.html#plot-large-heatmap-demonstrating-marker-gene-selectivity-and-cluster-identity",
    "title": "9  Tumor: Deep phenotyping, cluster annotation, and exploration of tumor cells",
    "section": "9.7 Plot large heatmap demonstrating marker gene selectivity and cluster identity",
    "text": "9.7 Plot large heatmap demonstrating marker gene selectivity and cluster identity\n\nmerged.18279.tumor.singlets[['RNA']] &lt;- JoinLayers(merged.18279.tumor.singlets[['RNA']])\nmerged.sce &lt;- as.SingleCellExperiment(merged.18279.tumor.singlets, assay=\"RNA\")\n\n(mergedCondition.sce &lt;- prepSCE(merged.sce,\n        kid = \"sub.cluster\",\n        gid = \"Timepoint\",\n        sid = \"Sample\",\n        drop = TRUE))\n\nclass: SingleCellExperiment \ndim: 61217 19976 \nmetadata(1): experiment_info\nassays(2): counts logcounts\nrownames(61217): 5-8S-rRNA 5S-rRNA ... ZZEF1 ZZZ3\nrowData names(0):\ncolnames(19976): P101_Tumor_W00_2.5mgIpi_RNA_AGGTCCGGTGACAAAT\n  P101_Tumor_W00_2.5mgIpi_RNA_TCACGAAAGAGCCCAA ...\n  P108_Tumor_PD_5mgIpi_RNA_TTAGGCAGTATGAAAC\n  P108_Tumor_PD_5mgIpi_RNA_TATCTCACACCGAAAG\ncolData names(3): cluster_id sample_id group_id\nreducedDimNames(4): PCA UMAP.UNINTEGRATED INTEGRATED.HARMONY\n  UMAP.HARMONY\nmainExpName: RNA\naltExpNames(0):\n\nall_genes_to_plot &lt;- c(\"PTPRC\",\"CD14\",\"APOE\",\"ICAM1\",\"RNASE1\",\"S100A8\",\"S100A9\",\"C1QA\",\"C1QB\",\"C1QC\",\"ITGAX\",\"CD1C\",\"FCER1A\",\"CSF1R\",\"CD68\",\"CD163\",\"FASLG\",\"FOLR2\",\"MS4A4A\",\"SELENOP\",\"MSR1\",\"FCGR3A\",\"IL3RA\",\"IRF4\",\"IRF8\",\"CLEC4C\",\"CD40\",\"CD80\",\"CD86\",\"HLA-DRA\",\"HLA-DRB1\",\"HLA-DQA1\",\"HLA-DQA2\",\"HLA-DQB1\",\"HLA-DQB2\",\"CD79A\",\"BANK1\",\"MS4A1\",\"CD19\",\"MZB1\",\"IGHG1\",\"XBP1\",\"NCR1\",\"NCAM1\",\"CD3E\",\"CD3G\",\"CD4\",\"CD8A\",\"TRAC\",\"TRBC1\",\"TRBC2\",\"TRDC\",\"IL7R\",\"CCR7\",\"SELL\",\"CD27\",\"TCF7\",\"CXCR6\",\"FOXP3\",\"IL2RA\",\"TNFRSF18\",\"TNFRSF4\",\"BATF\",\"CTLA4\",\"PDCD1\",\"LAG3\",\"TIGIT\",\"TOX\",\"GNLY\",\"PRF1\",\"GZMA\",\"GZMB\",\"NKG7\",\"ICOS\",\"MKI67\",\"TOP2A\",\"PMEL\",\"MLANA\",\"TYR\",\"S100B\",\"MITF\",\"NLGN1\",\"HMCN1\",\"PDE10A\",\"PECAM1\",\"VWF\",\"EGFL7\",\"LUM\",\"DCN\",\"DST\",\"LAMC1\",\"WWTR1\",\"CALD1\",\"TAGLN\",\"KRT8\",\"CLDN4\")\n\ncluster_order &lt;- c(\"8\",\"15\",\"28\",\"17\",\"13\",\"2_1\",\"1_0\",\"1_1\",\"2_0\",\"22_1\",\"22_2\",\"26_0\",\"3_0\",\"22_0\",\"3_1\",\"12_0\",\"12_1\",\"16_0\",\"9_0\",\"9_1\",\"18_0\",\"18_1\",\"29\",\"0\",\"4\",\"5\",\"6\",\"11\",\"23\",\"25\",\"14\",\"21\",\"7\",\"27\",\"10\",\"20\",\"19\",\"24\")\n\nslice_order &lt;- factor(cluster_classes[cluster_order,], levels = unique(cluster_classes[cluster_order,]))\n\ngene_categories &lt;- enframe(all_genes_to_plot,name=NULL,value=\"Gene\") %&gt;%\n  as_tibble() %&gt;%\n  mutate(GeneClass = case_when(\n    Gene %in% c(\"PTPRC\") ~ \"Immune\",\n    Gene %in% c(\"CD14\",\"APOE\",\"ICAM1\",\"RNASE1\",\"S100A8\",\"S100A9\",\"C1QA\",\"C1QB\",\"C1QC\",\"ITGAX\",\"CD1C\",\"FCER1A\",\"CSF1R\",\"CD68\",\"CD163\",\"FASLG\",\"FOLR2\",\"MS4A4A\",\"SELENOP\",\"MSR1\",\"FCGR3A\",\"IL3RA\",\"IRF4\",\"IRF8\",\"CLEC4C\",\"CD40\",\"CD80\",\"CD86\",\"HLA-DRA\",\"HLA-DRB1\",\"HLA-DQA1\",\"HLA-DQA2\",\"HLA-DQB1\",\"HLA-DQB2\") ~ \"Monocyte/\\nMacrophage/\\nDC\",\n    Gene %in% c(\"CD79A\",\"BANK1\",\"MS4A1\",\"CD19\") ~ \"B cell\",\n    Gene %in% c(\"MZB1\",\"IGHG1\",\"XBP1\") ~ \"Plasma\",\n    Gene %in% c(\"NCR1\",\"NCAM1\") ~ \"NK cell\",\n    Gene %in% c(\"CD3E\",\"CD3G\",\"CD4\",\"CD8A\",\"TRAC\",\"TRBC1\",\"TRBC2\",\"TRDC\",\"IL7R\",\"CCR7\",\"SELL\",\"CD27\",\"TCF7\") ~ \"T cell\",\n    Gene %in% c(\"CXCR6\",\"FOXP3\",\"IL2RA\",\"TNFRSF18\",\"TNFRSF4\",\"BATF\",\"CTLA4\",\"PDCD1\",\"LAG3\",\"TIGIT\",\"TOX\",\"NKG7\",\"GNLY\",\"PRF1\",\"GZMA\",\"GZMB\",\"ICOS\") ~ \"T cell\\nsubsets/\\nNK cells\",\n    Gene %in% c(\"MKI67\",\"TOP2A\") ~ \"Proliferation\",\n    Gene %in% c(\"PMEL\",\"MLANA\",\"TYR\",\"S100B\",\"MITF\") ~ \"Melanoma\",\n    Gene %in% c(\"NLGN1\",\"HMCN1\",\"PDE10A\") ~ \"Melanocyte\",\n    Gene %in% c(\"PECAM1\",\"VWF\",\"EGFL7\") ~ \"Endothelial\",\n    Gene %in% c(\"DCN\",\"LUM\",\"DST\",\"LAMC1\",\"WWTR1\") ~ \"Fibroblast\",\n    Gene %in% c(\"TAGLN\",\"CALD1\") ~ \"Pericyte/\\nsmooth muscle\",\n    Gene %in% c(\"KRT8\",\"CLDN4\") ~ \"Basal\"\n    )\n  )\n  \ngene_slice_order &lt;- factor(gene_categories$GeneClass, levels = unique(gene_categories$GeneClass))\n  \npb_all &lt;- aggregateData(mergedCondition.sce,\n    assay = \"counts\",\n    fun = \"mean\",\n    by = \"cluster_id\")\n\nall_genes_to_plot &lt;- all_genes_to_plot[all_genes_to_plot %in% rownames(assay(pb_all))]\nmat &lt;- assay(pb_all)[all_genes_to_plot,cluster_order]\ncolnames(mat) &lt;- cluster_annot[cluster_order]\nComplexHeatmap::Heatmap(mat,\n                        col = circlize::colorRamp2(c(0,3),hcl_palette = \"viridis\"),\n                        cluster_rows = FALSE,\n                        cluster_columns = FALSE,\n                        column_split = slice_order,\n                        row_split = gene_slice_order,\n                        row_title_rot = 0,\n                        cluster_column_slices = FALSE,\n                        border = TRUE,\n                        row_names_gp = gpar(fontsize=6,fontface=\"italic\"),\n                        column_names_gp = gpar(fontsize=8),\n                        column_title_gp = gpar(fontsize=8,fontface=\"bold\"),\n                        row_title_gp = gpar(fontsize=8,fontface=\"bold\"),\n                        name = \"Mean expression\",\n                        heatmap_legend_param = list(title_position = \"leftcenter-rot\",border = TRUE)\n                  )",
    "crumbs": [
      "<span class='chapter-number'>9</span>  <span class='chapter-title'>Tumor: Deep phenotyping, cluster annotation, and exploration of tumor cells</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part9.html#plot-heatmap-of-functional-genes",
    "href": "Tumor_scRNA_Part9.html#plot-heatmap-of-functional-genes",
    "title": "9  Tumor: Deep phenotyping, cluster annotation, and exploration of tumor cells",
    "section": "9.8 Plot heatmap of functional genes",
    "text": "9.8 Plot heatmap of functional genes\n\nfunctional_genes_to_plot &lt;- c(\"IL1A\",\"IL1B\",\"LYZ\",\"IDO1\",\"IL6\",\"IL8\",\"IFNG\",\"TNF\",\"CXCL2\",\"CXCL3\",\"CXCL5\",\"CXCL8\",\"CXCL9\",\"CXCL12\",\"CCL2\",\"CCL3\",\"CCL4\",\"CCL5\",\"XCL1\",\"XCL2\")\n\nfunctional_genes_to_plot &lt;- functional_genes_to_plot[functional_genes_to_plot %in% rownames(assay(pb_all))]\nfx_mat &lt;- assay(pb_all)[functional_genes_to_plot,cluster_order]\ncolnames(fx_mat) &lt;- cluster_annot[cluster_order]\nComplexHeatmap::Heatmap(fx_mat,\n                        col = circlize::colorRamp2(c(0,3),hcl_palette = \"viridis\"),\n                        cluster_rows = FALSE,\n                        cluster_columns = FALSE,\n                        column_split = slice_order,\n                        cluster_column_slices = FALSE,\n                        border = TRUE,\n                        row_names_gp = gpar(fontsize=6,fontface=\"italic\"),\n                        column_names_gp = gpar(fontsize=8),\n                        column_title_gp = gpar(fontsize=8,fontface=\"bold\"),\n                        name = \"Mean expression\",\n                        heatmap_legend_param = list(title_position = \"leftcenter-rot\",border = TRUE)\n                  )",
    "crumbs": [
      "<span class='chapter-number'>9</span>  <span class='chapter-title'>Tumor: Deep phenotyping, cluster annotation, and exploration of tumor cells</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part9.html#plot-composition-of-tumor---all-cells---as-a-stacked-barplot-grouped-by-cell-class",
    "href": "Tumor_scRNA_Part9.html#plot-composition-of-tumor---all-cells---as-a-stacked-barplot-grouped-by-cell-class",
    "title": "9  Tumor: Deep phenotyping, cluster annotation, and exploration of tumor cells",
    "section": "9.9 Plot composition of tumor - all cells - as a stacked barplot grouped by cell class",
    "text": "9.9 Plot composition of tumor - all cells - as a stacked barplot grouped by cell class\n\ncomps &lt;- rownames_to_column(as.data.frame(merged.18279.tumor.singlets@meta.data),var=\"Barcode\") %&gt;%\n    as_tibble() %&gt;%\n    dplyr::select(Barcode,sub.cluster,Sample,CellClass) %&gt;%\n    mutate(Sample = str_replace_all(Sample,\"_.{1,3}mgIpi_RNA\",\"\")) %&gt;%\n    group_by(CellClass,Sample) %&gt;%\n    summarize(n = n()) %&gt;%\n    mutate(Patient = str_split_i(Sample,pattern = \"_\",i = 1)) %&gt;%\n    mutate(Site = str_split_i(Sample,pattern = \"_\",i = 2)) %&gt;%\n    mutate(Timepoint = str_split_i(Sample,pattern = \"_\",i = 3))\n\n`summarise()` has grouped output by 'CellClass'. You can override using the\n`.groups` argument.\n\ncomps_1 &lt;- comps %&gt;%\n    dplyr::filter(Patient %in% c(\"P101\",\"P104\",\"P108\")) %&gt;%\n    ggplot(aes(x=Timepoint,y=n,fill=fct_relevel(CellClass,c(\"Melanoma\",\"Non-immune\",\"Mast\",\"DC\",\"Monocyte/\\nMacrophage\",\"B\",\"NK/T\")))) +\n    geom_col(position=\"fill\",color=\"black\",linewidth=0.1) +\n    theme_bw() +\n    theme(#axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=10),\n        axis.text.y = element_text(size=10),\n        strip.text = element_text(size=10,face=\"bold\"),\n        axis.title = element_text(size=10,face=\"bold\"),\n        legend.text = element_text(size=10),\n        legend.title = element_text(size=10,face=\"bold\"),\n        legend.key.size = unit(2,\"line\"),\n        panel.grid = element_blank(), \n      panel.grid.minor = element_blank(),\n      panel.border = element_rect(fill = NA, color = \"black\")\n        ) +\n    ylab(\"Cell fraction in tumor biopsy\") +\n    facet_grid(~fct_relevel(Patient,c(\"P101\",\"P104\",\"P108\")),scales=\"free_x\",space=\"free_x\") +\n    labs(fill=\"Cell class\") +\n    scale_fill_manual(values = c(\"#5AAE61\", \n                                 \"#D9F0D3\", \n                                 \"#E08214\", \n                                 \"#762A83\", \n                                 \"gray50\", \n                                 paletteer_d(\"ggsci::brown_material\")[3], \n                                 \"gray90\")[c(6,7,5,2,1,3,4)],\n                      limits=unique(cluster_classes$CellClass)[c(6,7,5,2,1,3,4)]\n        )\n\ncomps_2 &lt;- comps %&gt;%\n    dplyr::filter(Patient %in% c(\"P103\")) %&gt;%\n    ggplot(aes(x=Timepoint,y=n,fill=fct_relevel(CellClass,c(\"Melanoma\",\"Non-immune\",\"Mast\",\"DC\",\"Monocyte/\\nMacrophage\",\"B\",\"NK/T\")))) +\n    geom_col(position=\"fill\",color=\"black\",linewidth=0.1) +\n    theme_bw() +\n    theme(#axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=10),\n        axis.text.y = element_blank(),\n        axis.ticks.length.y = unit(0, \"line\"),\n        strip.text = element_text(size=10,face=\"bold\"),\n        axis.title = element_text(size=10,face=\"bold\"),\n        legend.text = element_text(size=10),\n        legend.title = element_text(size=10,face=\"bold\"),\n        legend.key.size = unit(2,\"line\"),\n        panel.grid = element_blank(), \n      panel.grid.minor = element_blank(),\n      panel.border = element_rect(fill = NA, color = \"black\")\n        ) +\n    ylab(\"\") +\n    facet_grid(~fct_relevel(Patient,c(\"P103\")),scales=\"free_x\",space=\"free_x\") +\n    labs(fill=\"Cell class\") +\n    scale_fill_manual(values = c(\"#5AAE61\", \n                                 \"#D9F0D3\", \n                                 \"#E08214\", \n                                 \"#762A83\", \n                                 \"gray50\", \n                                 paletteer_d(\"ggsci::brown_material\")[3], \n                                 \"gray90\")[c(6,7,5,2,1,3,4)],\n                      limits=unique(cluster_classes$CellClass)[c(6,7,5,2,1,3,4)]\n        )\n\nwrap_plots(comps_1, comps_2, ncol = 2, guides = \"collect\", widths = c(1,0.55))",
    "crumbs": [
      "<span class='chapter-number'>9</span>  <span class='chapter-title'>Tumor: Deep phenotyping, cluster annotation, and exploration of tumor cells</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part9.html#plot-projectils-annotations-in-umap-space",
    "href": "Tumor_scRNA_Part9.html#plot-projectils-annotations-in-umap-space",
    "title": "9  Tumor: Deep phenotyping, cluster annotation, and exploration of tumor cells",
    "section": "9.10 Plot ProjecTILs annotations in UMAP space",
    "text": "9.10 Plot ProjecTILs annotations in UMAP space\n\nDimPlot(merged.18279.tumor.singlets, \n        reduction = \"umap.harmony\",\n        group.by = \"functional.cluster\",\n        label = FALSE\n        ) +\n    scale_color_manual(breaks = levels(addNA(factor(merged.18279.tumor.singlets$functional.cluster))),\n        labels = c(levels(factor(merged.18279.tumor.singlets$functional.cluster)),\"Unknown/Other\"),\n        values = c(paletteer::paletteer_d(\"RColorBrewer::Blues\")[-c(1:2)], \"#232061FF\", paletteer::paletteer_d(\"RColorBrewer::Reds\")[-c(1:2)],\"#CECECEFF\"),\n        na.value = \"#CECECEFF\",\n        drop = FALSE\n        )",
    "crumbs": [
      "<span class='chapter-number'>9</span>  <span class='chapter-title'>Tumor: Deep phenotyping, cluster annotation, and exploration of tumor cells</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part9.html#stacked-barplot-of-projectils-annotations-of-til-compartment",
    "href": "Tumor_scRNA_Part9.html#stacked-barplot-of-projectils-annotations-of-til-compartment",
    "title": "9  Tumor: Deep phenotyping, cluster annotation, and exploration of tumor cells",
    "section": "9.11 Stacked barplot of ProjecTILs annotations of TIL compartment",
    "text": "9.11 Stacked barplot of ProjecTILs annotations of TIL compartment\n\nmeta.df &lt;- merged.18279.tumor.singlets@meta.data[,c(\"Patient\",\"Timepoint\",\"sub.cluster\",\"functional.cluster\", \"CellClass\")]\n\na &lt;- rownames_to_column(meta.df,var=\"Cell\") %&gt;%\n    as_tibble() %&gt;%\n\n    # Restrict to T cells\n    dplyr::filter(CellClass == \"NK/T\") %&gt;%\n    group_by(Patient,Timepoint) %&gt;%\n    summarize(n = n()) %&gt;%\n    dplyr::filter(Patient %in% c(\"P101\",\"P104\",\"P108\")) %&gt;%\n    ggplot(aes(x=Timepoint,y=n,group=Patient,fill=Patient)) +\n    geom_col(color=\"black\",linewidth=0.1) +\n    geom_point(size=0.5) +\n    facet_grid(~Patient,scales = \"free_x\",space=\"free\") +\n    ylab(\"Num. TILs\") +\n    theme_bw() +\n    theme(axis.text.x = element_blank(),\n        axis.ticks.x = element_blank(),\n        axis.text.y = element_text(size=10),\n        strip.text = element_text(size=10,face=\"bold\"),\n        axis.title.x = element_blank(),\n        axis.title.y = element_text(size=10,face=\"bold\"),\n        legend.position = \"none\",\n        panel.grid = element_blank(), \n        panel.grid.minor = element_blank(),\n        panel.border = element_rect(fill = NA, color = \"black\")\n        ) +\n        scale_fill_manual(values = rep(\"gray50\",4))\n\n`summarise()` has grouped output by 'Patient'. You can override using the\n`.groups` argument.\n\nb &lt;- rownames_to_column(meta.df,var=\"Cell\") %&gt;%\n    as_tibble() %&gt;%\n\n    # Restrict to T cells\n    dplyr::filter(CellClass == \"NK/T\") %&gt;%\n    group_by(Patient,Timepoint,functional.cluster) %&gt;%\n    summarize(n = n()) %&gt;%\n    dplyr::filter(Patient %in% c(\"P101\",\"P104\",\"P108\")) %&gt;%\n    ggplot(aes(x=Timepoint,y=n,fill=functional.cluster)) +\n    geom_col(position=\"fill\",color=\"black\",linewidth=0.1) +\n    facet_grid(~Patient,scales = \"free_x\",space=\"free\") +\n    theme_bw() +\n    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=10),\n        axis.text.y = element_text(size=10),\n        strip.text = element_blank(),\n        axis.title = element_text(size=10,face=\"bold\"),\n        legend.text = element_text(size=10),\n        legend.title = element_text(size=10,face=\"bold\"),\n        legend.key.size = unit(1.5,\"line\"),\n        panel.grid = element_blank(), \n        panel.grid.minor = element_blank(),\n        panel.border = element_rect(fill = NA, color = \"black\")\n        ) +\n    ylab(\"Proportion of TILs\") +\n    labs(fill = \"Cell state\") +\n    scale_fill_manual(breaks = levels(addNA(factor(meta.df$functional.cluster))),\n        labels = c(levels(factor(meta.df$functional.cluster)),\"Unknown/Other\"),\n        values = c(paletteer::paletteer_d(\"RColorBrewer::Blues\")[-c(1:2)], \"#232061FF\", paletteer::paletteer_d(\"RColorBrewer::Reds\")[-c(1:2)],\"#CECECEFF\"),\n        na.value = \"#CECECEFF\"\n        )\n\n`summarise()` has grouped output by 'Patient', 'Timepoint'. You can override\nusing the `.groups` argument.\n\nc &lt;- rownames_to_column(meta.df,var=\"Cell\") %&gt;%\n    as_tibble() %&gt;%\n\n    # Restrict to T cells\n    dplyr::filter(CellClass == \"NK/T\") %&gt;%\n    group_by(Patient,Timepoint) %&gt;%\n    summarize(n = n()) %&gt;%\n    dplyr::filter(Patient %in% c(\"P103\")) %&gt;%\n    ggplot(aes(x=Timepoint,y=n,group=Patient,fill=Patient)) +\n    geom_col(color=\"black\",linewidth=0.1) +\n    geom_point(size=0.5) +\n    facet_grid(~Patient,scales = \"free_x\",space=\"free\") +\n    ylab(\"\") +\n    theme_bw() +\n    theme(axis.text.x = element_blank(),\n        axis.ticks.x = element_blank(),\n        axis.ticks.length.y = unit(0, \"line\"),\n        axis.text.y = element_blank(),\n        strip.text = element_text(size=10,face=\"bold\"),\n        axis.title.x = element_blank(),\n        axis.title.y = element_text(size=10,face=\"bold\"),\n        legend.position = \"none\",\n        panel.grid = element_blank(), \n        panel.grid.minor = element_blank(),\n        panel.border = element_rect(fill = NA, color = \"black\")\n        ) +\n        scale_fill_manual(values = rep(\"gray50\",4))\n\n`summarise()` has grouped output by 'Patient'. You can override using the\n`.groups` argument.\n\nd &lt;- rownames_to_column(meta.df,var=\"Cell\") %&gt;%\n    as_tibble() %&gt;%\n\n    # Restrict to T cells\n    dplyr::filter(CellClass == \"NK/T\") %&gt;%\n    group_by(Patient,Timepoint,functional.cluster) %&gt;%\n    summarize(n = n()) %&gt;%\n    dplyr::filter(Patient %in% c(\"P103\")) %&gt;%\n    ggplot(aes(x=Timepoint,y=n,fill=functional.cluster)) +\n    geom_col(position=\"fill\",show.legend = TRUE,color=\"black\",linewidth=0.1) +\n    facet_grid(~Patient,scales = \"free_x\",space=\"free\") +\n    theme_bw() +\n    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=10),\n        axis.text.y = element_blank(),\n        axis.ticks.length.y = unit(0, \"line\"),\n        strip.text = element_blank(),\n        axis.title = element_text(size=10,face=\"bold\"),\n        legend.text = element_text(size=10),\n        legend.title = element_text(size=10,face=\"bold\"),\n        legend.key.size = unit(1.5,\"line\"),\n        panel.grid = element_blank(), \n        panel.grid.minor = element_blank(),\n        panel.border = element_rect(fill = NA, color = \"black\")\n        ) +\n    ylab(\"\") +\n#   labs(fill = \"Cell state\") +\n    guides(fill = \"none\") +\n    scale_fill_manual(breaks = levels(addNA(factor(meta.df$functional.cluster))),\n        labels = c(levels(factor(meta.df$functional.cluster)),\"Unknown/Other\"),\n        values = c(paletteer::paletteer_d(\"RColorBrewer::Blues\")[-c(1:2)], \"#232061FF\", paletteer::paletteer_d(\"RColorBrewer::Reds\")[-c(1:2)],\"#CECECEFF\"),\n        na.value = \"#CECECEFF\",\n        drop = FALSE\n        )\n\n`summarise()` has grouped output by 'Patient', 'Timepoint'. You can override\nusing the `.groups` argument.\n\nwrap_plots(a, c, b, d) + plot_layout(heights=c(0.1, 0.9), widths = c(1, 0.5), guides = \"collect\")",
    "crumbs": [
      "<span class='chapter-number'>9</span>  <span class='chapter-title'>Tumor: Deep phenotyping, cluster annotation, and exploration of tumor cells</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part9.html#plot-cell-proportions-of-all-clusters",
    "href": "Tumor_scRNA_Part9.html#plot-cell-proportions-of-all-clusters",
    "title": "9  Tumor: Deep phenotyping, cluster annotation, and exploration of tumor cells",
    "section": "9.12 Plot cell proportions of all clusters",
    "text": "9.12 Plot cell proportions of all clusters\n\ntotalsPerSample &lt;- enframe(table(merged.18279.tumor.singlets$Sample),name=\"Sample\",value=\"TotalCells\") %&gt;%\n    as_tibble() %&gt;%\n    mutate(TotalCells = as.numeric(TotalCells)) %&gt;%\n    mutate(Sample = str_replace_all(Sample,\"_.{1,3}mgIpi_RNA\",\"\"))\n\nrownames_to_column(as.data.frame(merged.18279.tumor.singlets@meta.data),var=\"Barcode\") %&gt;%\n    as_tibble() %&gt;%\n    dplyr::select(Barcode,sub.cluster,Sample,CellAnnotation) %&gt;%\n    mutate(Sample = str_replace_all(Sample,\"_.{1,3}mgIpi_RNA\",\"\")) %&gt;%\n    group_by(CellAnnotation,Sample) %&gt;%\n    summarize(n = dplyr::n()) %&gt;%\n    ungroup() %&gt;%\n    complete(Sample,CellAnnotation) %&gt;%             # Makes sure 0s get represented rather than omitted\n    mutate(n = replace_na(n,0)) %&gt;%\n    mutate(Patient = str_split_i(Sample,pattern = \"_\",i = 1)) %&gt;%\n    mutate(Site = str_split_i(Sample,pattern = \"_\",i = 2)) %&gt;%\n    mutate(Timepoint = str_split_i(Sample,pattern = \"_\",i = 3)) %&gt;%\n    right_join(totalsPerSample,.,by=\"Sample\") %&gt;%\n      group_by(Sample) %&gt;%\n      mutate(Proportion = n / TotalCells) %&gt;%\n    mutate(CellAnnotation = factor(CellAnnotation, levels = cluster_annot[cluster_order])) %&gt;%\n    ggplot(aes(x = fct_relevel(Timepoint,c(\"W00\",\"W12\",\"W20\",\"PD\")),\n               y = Proportion,\n               color = Patient\n               )\n           ) +\n      #geom_boxplot(outlier.shape=NA, width = 0.5) +\n      lemon::geom_pointpath(aes(group=Patient), \n                            position = position_jitterdodge(jitter.width = 0.1,\n                                                            dodge.width = 0.4,\n                                                            seed=123)\n                            ) +\n      facet_wrap(~CellAnnotation,scales=\"free_y\",ncol=6) +\n    theme_bw() +\n    theme(axis.text.y = element_text(size=10),\n        strip.text = element_text(size=8,face=\"bold\"),\n        axis.title = element_text(size=10,face=\"bold\"),\n        legend.text = element_text(size=10),\n        legend.title = element_text(size=10,face=\"bold\"),\n        legend.key.size = unit(2,\"line\"),\n        panel.grid = element_blank(), \n        panel.grid.minor = element_blank(),\n        panel.border = element_rect(fill = NA, color = \"black\")\n        ) +\n      xlab(\"Timepoint\") +\n      ylab(\"Tumor composition fraction\") +\n    labs(fill = \"Timepoint\") +\n  scale_color_manual(values = c(\"#59A14FFF\",\"#B07AA1FF\",\"#76B7B2FF\", \"#F6AAC9FF\"))\n\n`summarise()` has grouped output by 'CellAnnotation'. You can override using\nthe `.groups` argument.",
    "crumbs": [
      "<span class='chapter-number'>9</span>  <span class='chapter-title'>Tumor: Deep phenotyping, cluster annotation, and exploration of tumor cells</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part9.html#plot-mhc-class-i-and-ii-as-well-as-antigen-processing-pathway-expression-among-melanoma-cells",
    "href": "Tumor_scRNA_Part9.html#plot-mhc-class-i-and-ii-as-well-as-antigen-processing-pathway-expression-among-melanoma-cells",
    "title": "9  Tumor: Deep phenotyping, cluster annotation, and exploration of tumor cells",
    "section": "9.13 Plot MHC class I and II as well as antigen processing pathway expression among melanoma cells",
    "text": "9.13 Plot MHC class I and II as well as antigen processing pathway expression among melanoma cells\n\nmerged.18279.tumor.singlets.mel &lt;- subset(merged.18279.tumor.singlets,subset = CellClass == \"Melanoma\")\n\nclass2 &lt;- rownames(merged.18279.tumor.singlets)[str_detect(rownames(merged.18279.tumor.singlets),\"HLA-D\")]\nclass1 &lt;- rownames(merged.18279.tumor.singlets)[str_detect(rownames(merged.18279.tumor.singlets),\"HLA-[ABC]\")]\n\n## Retrieve MSigDB C2 from MSigDB and filter for KEGG antigen processing/presentation genes\nc2 &lt;- msigdbr::msigdbr(species=\"Homo sapiens\",category = \"C2\")\n\nantigenProc &lt;- c2 %&gt;% \n    dplyr::filter(gs_name == \"KEGG_ANTIGEN_PROCESSING_AND_PRESENTATION\") %&gt;%\n  dplyr::filter(!str_detect(human_gene_symbol,\"^HLA-[ABCD]\")) %&gt;%\n    pull(human_gene_symbol) %&gt;% \n    unique()\n\n## Compute module scores for these gene sets\nmerged.18279.tumor.singlets.mel &lt;- AddModuleScore(merged.18279.tumor.singlets.mel, features = list(class1), name = \"MHCclassI\")\nmerged.18279.tumor.singlets.mel &lt;- AddModuleScore(merged.18279.tumor.singlets.mel, features = list(class2), name = \"MHCclassII\")\nmerged.18279.tumor.singlets.mel &lt;- AddModuleScore(merged.18279.tumor.singlets.mel, features = list(antigenProc), name = \"AntigenProcessing\")\n\nWarning: The following features are not present in the object: KIR2DL2,\nKIR2DL5A, KIR2DS1, KIR2DS3, KIR2DS5, not searching for symbol synonyms\n\nrownames_to_column(merged.18279.tumor.singlets.mel@meta.data,var=\"Barcode\") %&gt;%\n    as_tibble() %&gt;%\n    dplyr::select(Barcode,Patient,Site,Timepoint,MHCclassI1,MHCclassII1,AntigenProcessing1) %&gt;%\n    pivot_longer(cols = c(\"MHCclassI1\",\"MHCclassII1\",\"AntigenProcessing1\"), names_to = \"Signature\", values_to=\"Expression\") %&gt;%\n    mutate(Signature = str_replace_all(Signature,\"1$\",\"\")) %&gt;%\n    ggplot(aes(x = fct_relevel(Timepoint,c(\"W00\",\"W12\",\"W20\",\"PD\")), y = Expression, fill = Patient)) +\n    geom_violin() +\n    #geom_point(position = position_jitter(width = 0.1),size=0.2,alpha=0.25) +\n    facet_grid(Signature~Patient,scales=\"free_x\",space=\"free_x\") +\n    xlab(\"Timepoint\") +\n    ylab(\"Expression in individual melanoma cells\") +\n  theme_bw() +\n  scale_fill_manual(values=c(\"#59A14FFF\",\"#B07AA1FF\",\"#76B7B2FF\", \"#F6AAC9FF\"))",
    "crumbs": [
      "<span class='chapter-number'>9</span>  <span class='chapter-title'>Tumor: Deep phenotyping, cluster annotation, and exploration of tumor cells</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part9.html#compute-cd8-cd4treg-ratio-over-time-using-projectils-annotations-of-cd4treg-and-cd8",
    "href": "Tumor_scRNA_Part9.html#compute-cd8-cd4treg-ratio-over-time-using-projectils-annotations-of-cd4treg-and-cd8",
    "title": "9  Tumor: Deep phenotyping, cluster annotation, and exploration of tumor cells",
    "section": "9.14 Compute CD8 / CD4Treg ratio over time, using ProjecTILs annotations of CD4Treg and CD8",
    "text": "9.14 Compute CD8 / CD4Treg ratio over time, using ProjecTILs annotations of CD4Treg and CD8\n\nratio1 &lt;- as.data.frame(table(merged.18279.tumor.singlets$functional.cluster, merged.18279.tumor.singlets$Sample)) %&gt;% \n  as_tibble() %&gt;%\n  dplyr::rename(\"Sample\" = Var2,\"Cluster\" = Var1) %&gt;%\n  separate(Sample, into=c(\"Patient\",\"Site\",\"Timepoint\",\"IpiCohort\",\"Assay\"),sep=\"_\",remove=F) %&gt;%\n  dplyr::filter(Timepoint==\"W00\" | Timepoint==\"W12\" | Timepoint==\"W20\") %&gt;%\n  group_by(Sample) %&gt;%\n  mutate(Proportion = Freq / sum(Freq)) %&gt;%\n  mutate(Ttype = case_when(\n    str_detect(Cluster,\"CD8\") ~ \"CD8\",\n    str_detect(Cluster,\"Treg\") ~ \"Treg\",\n    T ~ \"else\"      \n    )\n  ) %&gt;%\n  dplyr::filter(Ttype != \"else\") %&gt;%\n  group_by(Sample, Ttype) %&gt;%\n  summarize(SumProp = sum(Proportion)) %&gt;%\n  separate(Sample, into=c(\"Patient\",\"Site\",\"Timepoint\",\"IpiCohort\",\"Assay\"),sep=\"_\",remove=F) %&gt;%\n  pivot_wider(names_from=Ttype, values_from=SumProp) %&gt;%\n  rowwise() %&gt;%\n  mutate(CD8treg_ratio = log2(CD8/Treg)) %&gt;%\n  ggplot(aes(x = Timepoint, y=CD8treg_ratio)) +\n  geom_hline(yintercept=0,linetype=3,color=\"gray50\",alpha=0.5) +\n  lemon::geom_pointpath(aes(group=Patient,color=Patient)) +\n  ylab(\"log2 CD8/CD4Treg proportion ratio\") +\n  theme_classic() +\n  theme(plot.margin = margin(0, 0, 0, 0, \"pt\")) +\n  ylim(0,6) +\n  scale_color_manual(values = c(\"#59A14FFF\",\"#B07AA1FF\"))\n\n`summarise()` has grouped output by 'Sample'. You can override using the\n`.groups` argument.\n\nratio2 &lt;- as.data.frame(table(merged.18279.tumor.singlets$functional.cluster, merged.18279.tumor.singlets$Sample)) %&gt;% \n  as_tibble() %&gt;%\n  dplyr::rename(\"Sample\" = Var2,\"Cluster\" = Var1) %&gt;%\n  separate(Sample, into=c(\"Patient\",\"Site\",\"Timepoint\",\"IpiCohort\",\"Assay\"),sep=\"_\",remove=F) %&gt;%\n  dplyr::filter(Timepoint==\"PD\") %&gt;%\n  group_by(Sample) %&gt;%\n  mutate(Proportion = Freq / sum(Freq)) %&gt;%\n  mutate(Ttype = case_when(\n    str_detect(Cluster,\"CD8\") ~ \"CD8\",\n    str_detect(Cluster,\"Treg\") ~ \"Treg\",\n    T ~ \"else\"      \n    )\n  ) %&gt;%\n  dplyr::filter(Ttype != \"else\") %&gt;%\n  group_by(Sample, Ttype) %&gt;%\n  summarize(SumProp = sum(Proportion)) %&gt;%\n  separate(Sample, into=c(\"Patient\",\"Site\",\"Timepoint\",\"IpiCohort\",\"Assay\"),sep=\"_\",remove=F) %&gt;%\n  pivot_wider(names_from=Ttype, values_from=SumProp) %&gt;%\n  rowwise() %&gt;%\n  mutate(CD8treg_ratio = log2(CD8/Treg)) %&gt;%\n  ggplot(aes(x = Timepoint, y=CD8treg_ratio,color=Patient)) +\n  geom_hline(yintercept=0,linetype=3,color=\"gray50\",alpha=0.5) +\n  geom_point() +\n  xlab(\"\") +\n  ylab(\"\") +\n  theme_classic() +\n  theme(plot.margin = margin(0, 0, 0, 0, \"pt\"),\n        legend.title=element_blank(),\n        axis.text.y = element_blank(),\n        axis.ticks.y = element_blank(),\n        axis.line.y = element_blank()) +\n  ylim(0,6) +\n  scale_color_manual(values = c(\"#76B7B2FF\", \"#F6AAC9FF\"))\n\n`summarise()` has grouped output by 'Sample'. You can override using the\n`.groups` argument.\n\nratio1 + ratio2 + plot_layout(widths = c(2, 1), guides = \"collect\") & \n  theme(legend.position = \"bottom\")",
    "crumbs": [
      "<span class='chapter-number'>9</span>  <span class='chapter-title'>Tumor: Deep phenotyping, cluster annotation, and exploration of tumor cells</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part9.html#plot-tls-signatures-among-plasmabcell-clusters",
    "href": "Tumor_scRNA_Part9.html#plot-tls-signatures-among-plasmabcell-clusters",
    "title": "9  Tumor: Deep phenotyping, cluster annotation, and exploration of tumor cells",
    "section": "9.15 Plot TLS signatures among Plasma/Bcell clusters",
    "text": "9.15 Plot TLS signatures among Plasma/Bcell clusters\nDrop P104 because there are no Plasma/B cells observed\n\nprops &lt;- rownames_to_column(as.data.frame(merged.18279.tumor.singlets@meta.data),var=\"Barcode\") %&gt;%\n    as_tibble() %&gt;%\n    dplyr::select(Barcode,sub.cluster,Sample,CellClass) %&gt;%\n    mutate(Sample = str_replace_all(Sample,\"_.{1,3}mgIpi_RNA\",\"\")) %&gt;%\n    group_by(sub.cluster,Sample) %&gt;%\n    summarize(n = dplyr::n()) %&gt;%\n    ungroup() %&gt;%\n    complete(Sample,sub.cluster) %&gt;%            # Makes sure 0s get represented rather than omitted\n    mutate(n = replace_na(n,0)) %&gt;%\n    mutate(Patient = str_split_i(Sample,pattern = \"_\",i = 1)) %&gt;%\n    mutate(Site = str_split_i(Sample,pattern = \"_\",i = 2)) %&gt;%\n    mutate(Timepoint = str_split_i(Sample,pattern = \"_\",i = 3)) %&gt;%\n    right_join(totalsPerSample,.,by=\"Sample\") %&gt;%\n    mutate(Sample = str_replace_all(Sample,\"_Tumor\",\"\")) %&gt;%\n    group_by(Sample) %&gt;%\n    mutate(Proportion = n / TotalCells)\n\n`summarise()` has grouped output by 'sub.cluster'. You can override using the\n`.groups` argument.\n\nprops %&gt;%\n    dplyr::filter(sub.cluster %in% rownames(cluster_classes)[which(cluster_classes$CellClass==\"B\")]) %&gt;%\n    dplyr::select(Sample, Proportion, sub.cluster) %&gt;%\n    pivot_wider(names_from=sub.cluster,values_from=Proportion)\n\n# A tibble: 8 × 3\n# Groups:   Sample [8]\n  Sample       `13`    `17`\n  &lt;chr&gt;       &lt;dbl&gt;   &lt;dbl&gt;\n1 P101_W00 0.00139  0      \n2 P101_W12 0.000417 0.00501\n3 P101_W20 0        0      \n4 P103_W00 0.112    0.00420\n5 P103_W12 0.0157   0.0479 \n6 P103_W20 0.00296  0.0355 \n7 P104_PD  0        0      \n8 P108_PD  0        0.00423\n\n# Pseudobulk by cluster and sample\npb &lt;- aggregateData(mergedCondition.sce,\n    assay = \"counts\",\n    fun = \"mean\",\n    by = c(\"cluster_id\", \"sample_id\"))\n\n\n# Subset to genes and clusters of interest and reorder columns\ncluster &lt;- \"13\"\n\n# Genes defined by four TLS signatures, Cabrita_TLS, Cabrita_Hallmark_TLS, Meylan_TLS, Xu_TLS\ngoi &lt;- unique(c(\"CD79B\",\"CCL19\",\"IGHA1\",\"CCL2\",\"CD1D\",\"CCL21\",\"IGHG1\",\"CCL3\",\"CCR6\",\"CXCL13\",\"IGHG2\",\"CCL4\",\"LAT\",\"CCR7\",\"IGHG3\",\"CCL5\",\"SKAP1\",\"CXCR5\",\"IGHG4\",\"CCL8\",\"CETP\",\"SELL\",\"IGHGP\",\"CCL18\",\"EIF1AY\",\"LAMP3\",\"IGHM\",\"CCL19\",\"RBP5\",\"IGKC\",\"CCL21\",\"PTGDS\",\"IGLC1\",\"CXCL9\",\"IGLC2\",\"CXCL10\",\"IGLC3\",\"CXCL11\",\"JCHAIN\",\"CXCL13\",\"CD79A\",\"FCRL5\",\"MZB1\",\"SSR4\",\"XBP1\",\"TRBC2\",\"IL7R\",\"CXCL12\",\"LUM\",\"C1QA\",\"C7\",\"CD52\",\"APOE\",\"PTLP\",\"PTGDS\",\"PIM2\",\"DERL3\"))\n\ngoi_filt &lt;- goi[goi %in% rownames(assays(pb)[[cluster]])]\npb_cluster &lt;- assays(pb)[[cluster]][goi_filt,]\npb_cluster_cnames &lt;- str_replace_all(str_replace_all(colnames(pb_cluster),\"_.{1,3}mgIpi_RNA\",\"\"),\"_Tumor\",\"\")\ncolnames(pb_cluster) &lt;- pb_cluster_cnames\npb_cluster_cnames_sorted &lt;- pb_cluster_cnames[c(which(grepl(\"P101\",pb_cluster_cnames)),which(grepl(\"P104\",pb_cluster_cnames)),which(grepl(\"P108\",pb_cluster_cnames)),which(grepl(\"P103\",pb_cluster_cnames)))]\n\n# Subset proportions table\ncluster_props &lt;- props %&gt;%\n  dplyr::filter(sub.cluster == cluster) %&gt;%\n  dplyr::select(Sample,Proportion) %&gt;%\n  ungroup() %&gt;%\n  mutate(Sample = fct_relevel(as.factor(Sample),pb_cluster_cnames_sorted)) %&gt;%\n  dplyr::arrange(Sample) %&gt;%\n  as.data.frame()\n\n# Plot heatmap\npatients &lt;- factor(str_split_i(pb_cluster_cnames_sorted,\"_\",1),levels=c(\"P101\",\"P104\",\"P108\",\"P103\"))\npatients &lt;- droplevels(patients[patients!=\"P104\"])\ncluster_props &lt;- cluster_props[!str_detect(cluster_props$Sample,\"P104\"),]\npb_cluster_cnames_sorted &lt;- pb_cluster_cnames_sorted[!str_detect(pb_cluster_cnames_sorted,\"P104\")]\n\nha1 &lt;- HeatmapAnnotation(Patient = patients,\n                         show_legend = FALSE,\n                         col = list(Patient = setNames(c(\"#59A14FFF\",\"#F6AAC9FF\",\"#B07AA1FF\"), c(\"P101\", \"P108\", \"P103\"))), \n                         border = TRUE)\nha2 &lt;- HeatmapAnnotation(Proportion = anno_barplot(cluster_props$Proportion, \n                                                   gp = gpar(fill = c(\n                                                      rep(\"#59A14FFF\",length(which(str_detect(cluster_props$Sample,\"P101\")))),\n                                                       rep(\"#F6AAC9FF\",length(which(str_detect(cluster_props$Sample,\"P108\")))),\n                                                      rep(\"#B07AA1FF\",length(which(str_detect(cluster_props$Sample,\"P103\"))))\n                                                      )\n                                                     )\n                                                   )\n                         )\n\np13 &lt;- ComplexHeatmap::Heatmap(pb_cluster[,pb_cluster_cnames_sorted],\n                        cluster_rows = TRUE,\n                        cluster_columns = FALSE,\n                        column_split = factor(patients,levels = c(\"P101\",\"P108\",\"P103\")),\n                        column_labels = str_replace_all(pb_cluster_cnames_sorted,\"P.+_\",\"\"),\n                        row_names_gp = gpar(fontface = \"italic\",fontsize = 8),\n                        column_names_gp = gpar(fontsize = 8),\n                        col = colorRamp2(c(0,5),hcl_palette = \"viridis\"),\n                        border = TRUE,\n                        column_title = cluster_annot[cluster],\n                        column_title_gp = gpar(fontface = \"bold\"),\n                        name = \"Expression\",\n                        top_annotation = c(ha1,ha2),\n                        show_heatmap_legend = FALSE\n) %&gt;% \n  draw() %&gt;% \n  grid.grabExpr()\n  \n  \n\n\n# Repeat for cluster 17\ncluster &lt;- \"17\"\n\n# Genes defined by four TLS signatures, Cabrita_TLS, Cabrita_Hallmark_TLS, Meylan_TLS, Xu_TLS\ngoi_filt &lt;- goi[goi %in% rownames(assays(pb)[[cluster]])]\npb_cluster &lt;- assays(pb)[[cluster]][goi_filt,]\npb_cluster_cnames &lt;- str_replace_all(str_replace_all(colnames(pb_cluster),\"_.{1,3}mgIpi_RNA\",\"\"),\"_Tumor\",\"\")\ncolnames(pb_cluster) &lt;- pb_cluster_cnames\npb_cluster_cnames_sorted &lt;- pb_cluster_cnames[c(which(grepl(\"P101\",pb_cluster_cnames)),which(grepl(\"P104\",pb_cluster_cnames)),which(grepl(\"P108\",pb_cluster_cnames)),which(grepl(\"P103\",pb_cluster_cnames)))]\n\n# Subset proportions table\ncluster_props &lt;- props %&gt;%\n  dplyr::filter(sub.cluster == cluster) %&gt;%\n  dplyr::select(Sample,Proportion) %&gt;%\n  ungroup() %&gt;%\n  mutate(Sample = fct_relevel(as.factor(Sample),pb_cluster_cnames_sorted)) %&gt;%\n  dplyr::arrange(Sample) %&gt;%\n  as.data.frame()\n\n# Plot heatmap\npatients &lt;- factor(str_split_i(pb_cluster_cnames_sorted,\"_\",1),levels=c(\"P101\",\"P104\",\"P108\",\"P103\"))\npatients &lt;- droplevels(patients[patients!=\"P104\"])\ncluster_props &lt;- cluster_props[!str_detect(cluster_props$Sample,\"P104\"),]\npb_cluster_cnames_sorted &lt;- pb_cluster_cnames_sorted[!str_detect(pb_cluster_cnames_sorted,\"P104\")]\n\nha1 &lt;- HeatmapAnnotation(Patient = patients,\n                         show_legend = FALSE,\n                         col = list(Patient = setNames(c(\"#59A14FFF\",\"#F6AAC9FF\",\"#B07AA1FF\"), c(\"P101\", \"P108\", \"P103\"))), \n                         border = TRUE)\nha2 &lt;- HeatmapAnnotation(Proportion = anno_barplot(cluster_props$Proportion, \n                                                   gp = gpar(fill = c(\n                                                      rep(\"#59A14FFF\",length(which(str_detect(cluster_props$Sample,\"P101\")))),\n                                                      rep(\"#F6AAC9FF\",length(which(str_detect(cluster_props$Sample,\"P108\")))),\n                                                      rep(\"#B07AA1FF\",length(which(str_detect(cluster_props$Sample,\"P103\"))))\n                                                      )\n                                                     )\n                                                   )\n                         )\n\np17 &lt;- ComplexHeatmap::Heatmap(pb_cluster[,pb_cluster_cnames_sorted],\n                        cluster_rows = TRUE,\n                        cluster_columns = FALSE,\n                        column_split = factor(patients,levels = c(\"P101\",\"P108\",\"P103\")),\n                        column_labels = str_replace_all(pb_cluster_cnames_sorted,\"P.+_\",\"\"),\n                        row_names_gp = gpar(fontface = \"italic\",fontsize = 8),\n                        column_names_gp = gpar(fontsize = 8),\n                        col = colorRamp2(c(0,5),hcl_palette = \"viridis\"),\n                        border = TRUE,\n                        column_title = cluster_annot[cluster],\n                        column_title_gp = gpar(fontface = \"bold\"),\n                        name = \"Expression\",\n                        top_annotation = c(ha1,ha2),\n                        show_heatmap_legend = FALSE\n) %&gt;% \n  draw() %&gt;% \n  grid.grabExpr()\n  \n\nwrap_plots(p13, p17)",
    "crumbs": [
      "<span class='chapter-number'>9</span>  <span class='chapter-title'>Tumor: Deep phenotyping, cluster annotation, and exploration of tumor cells</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part9.html#plot-tls-module-scores-as-violin",
    "href": "Tumor_scRNA_Part9.html#plot-tls-module-scores-as-violin",
    "title": "9  Tumor: Deep phenotyping, cluster annotation, and exploration of tumor cells",
    "section": "9.16 Plot TLS module scores as violin",
    "text": "9.16 Plot TLS module scores as violin\n\nmerged.18279.tumor.singlets &lt;- AddModuleScore(merged.18279.tumor.singlets, features = list(goi), name = \"TLS_combined\")\n\nWarning: The following features are not present in the object: PTLP, not\nsearching for symbol synonyms\n\nrownames_to_column(as.data.frame(merged.18279.tumor.singlets@meta.data),var=\"Barcode\") %&gt;%\n    as_tibble() %&gt;%\n    dplyr::select(Barcode,sub.cluster,Sample,CellClass,contains(\"TLS_\")) %&gt;%\n    pivot_longer(cols = contains(\"TLS_\"), names_to=\"TLS_signature\", values_to=\"ModuleScore\") %&gt;%\n    mutate(Sample = str_replace_all(Sample,\"_.{1,3}mgIpi_RNA\",\"\")) %&gt;%\n    dplyr::filter(CellClass == \"B\") %&gt;%\n    mutate(Patient = str_split_i(Sample,pattern = \"_\",i = 1)) %&gt;%\n    mutate(Site = str_split_i(Sample,pattern = \"_\",i = 2)) %&gt;%\n    mutate(Timepoint = str_split_i(Sample,pattern = \"_\",i = 3)) %&gt;%\n    ggplot(aes(x = Timepoint, y = ModuleScore, fill = Patient)) +\n    geom_violin() +\n    facet_grid(TLS_signature ~ fct_relevel(Patient,c(\"P101\",\"P108\",\"P103\")),scales=\"free_x\",space=\"free\") +\n  theme_bw() +\n  ylab(\"TLS score in individual B/Plasma cells\") +\n  scale_fill_manual(values = c(\"#59A14FFF\",\"#F6AAC9FF\",\"#B07AA1FF\"))\n\nWarning: Groups with fewer than two datapoints have been dropped.\nℹ Set `drop = FALSE` to consider such groups for position adjustment purposes.",
    "crumbs": [
      "<span class='chapter-number'>9</span>  <span class='chapter-title'>Tumor: Deep phenotyping, cluster annotation, and exploration of tumor cells</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part9.html#get-session-info",
    "href": "Tumor_scRNA_Part9.html#get-session-info",
    "title": "9  Tumor: Deep phenotyping, cluster annotation, and exploration of tumor cells",
    "section": "9.17 Get session info",
    "text": "9.17 Get session info\n\nsessionInfo()\n\nR version 4.3.2 (2023-10-31)\nPlatform: x86_64-pc-linux-gnu (64-bit)\nRunning under: Rocky Linux 8.10 (Green Obsidian)\n\nMatrix products: default\nBLAS/LAPACK: /usr/lib64/libopenblasp-r0.3.15.so;  LAPACK version 3.9.0\n\nlocale:\n [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              \n [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    \n [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   \n [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 \n [9] LC_ADDRESS=C               LC_TELEPHONE=C            \n[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       \n\ntime zone: America/New_York\ntzcode source: system (glibc)\n\nattached base packages:\n[1] stats4    grid      stats     graphics  grDevices utils     datasets \n[8] methods   base     \n\nother attached packages:\n [1] scater_1.30.1               scuttle_1.12.0             \n [3] SingleCellExperiment_1.24.0 SummarizedExperiment_1.32.0\n [5] Biobase_2.62.0              GenomicRanges_1.54.1       \n [7] GenomeInfoDb_1.38.8         IRanges_2.36.0             \n [9] S4Vectors_0.40.2            BiocGenerics_0.48.1        \n[11] MatrixGenerics_1.14.0       matrixStats_1.4.1          \n[13] muscat_1.14.0               lemon_0.4.9                \n[15] circlize_0.4.16             ComplexHeatmap_2.18.0      \n[17] msigdbr_7.5.1               paletteer_1.6.0            \n[19] patchwork_1.3.0             lubridate_1.9.3            \n[21] forcats_1.0.0               stringr_1.5.1              \n[23] dplyr_1.1.4                 purrr_1.0.2                \n[25] readr_2.1.5                 tidyr_1.3.1                \n[27] tibble_3.2.1                ggplot2_3.5.1              \n[29] tidyverse_2.0.0             Seurat_5.1.0               \n[31] SeuratObject_5.0.2          sp_2.1-4                   \n[33] presto_1.0.0                data.table_1.16.2          \n[35] Rcpp_1.0.13-1              \n\nloaded via a namespace (and not attached):\n  [1] spatstat.sparse_3.1-0     bitops_1.0-9             \n  [3] httr_1.4.7                RColorBrewer_1.1-3       \n  [5] doParallel_1.0.17         numDeriv_2016.8-1.1      \n  [7] backports_1.5.0           tools_4.3.2              \n  [9] sctransform_0.4.1         utf8_1.2.4               \n [11] R6_2.5.1                  lazyeval_0.2.2           \n [13] uwot_0.2.2                mgcv_1.9-1               \n [15] GetoptLong_1.0.5          withr_3.0.2              \n [17] prettyunits_1.2.0         gridExtra_2.3            \n [19] SeuratWrappers_0.3.19     progressr_0.15.1         \n [21] cli_3.6.3                 Cairo_1.6-2              \n [23] spatstat.explore_3.2-6    fastDummies_1.7.3        \n [25] sandwich_3.1-1            prismatic_1.1.2          \n [27] labeling_0.4.3            mvtnorm_1.3-2            \n [29] spatstat.data_3.1-4       blme_1.0-5               \n [31] ggridges_0.5.6            pbapply_1.7-2            \n [33] R.utils_2.12.3            parallelly_1.39.0        \n [35] limma_3.58.1              generics_0.1.3           \n [37] shape_1.4.6.1             gtools_3.9.5             \n [39] ica_1.0-3                 spatstat.random_3.2-2    \n [41] Matrix_1.6-4              ggbeeswarm_0.7.2         \n [43] fansi_1.0.6               abind_1.4-8              \n [45] R.methodsS3_1.8.2         lifecycle_1.0.4          \n [47] multcomp_1.4-26           yaml_2.3.10              \n [49] edgeR_4.0.16              gplots_3.2.0             \n [51] SparseArray_1.2.2         Rtsne_0.17               \n [53] promises_1.3.0            crayon_1.5.3             \n [55] miniUI_0.1.1.1            lattice_0.22-6           \n [57] beachmat_2.18.1           cowplot_1.1.3            \n [59] magick_2.8.5              pillar_1.9.0             \n [61] knitr_1.45                rjson_0.2.23             \n [63] boot_1.3-31               estimability_1.5.1       \n [65] future.apply_1.11.3       codetools_0.2-20         \n [67] leiden_0.4.3.1            glue_1.8.0               \n [69] remotes_2.5.0             vctrs_0.6.5              \n [71] png_0.1-8                 spam_2.11-0              \n [73] Rdpack_2.6.2              gtable_0.3.6             \n [75] rematch2_2.1.2            xfun_0.49                \n [77] rbibutils_2.3             S4Arrays_1.2.0           \n [79] mime_0.12                 coda_0.19-4.1            \n [81] reformulas_0.4.0          survival_3.7-0           \n [83] iterators_1.0.14          statmod_1.5.0            \n [85] fitdistrplus_1.2-1        TH.data_1.1-2            \n [87] ROCR_1.0-11               nlme_3.1-166             \n [89] pbkrtest_0.5.3            EnvStats_2.8.1           \n [91] progress_1.2.3            RcppAnnoy_0.0.22         \n [93] TMB_1.9.15                irlba_2.3.5.1            \n [95] vipor_0.4.7               KernSmooth_2.23-24       \n [97] colorspace_2.1-1          nnet_7.3-19              \n [99] DESeq2_1.42.1             tidyselect_1.2.1         \n[101] emmeans_1.10.5            compiler_4.3.2           \n[103] BiocNeighbors_1.20.2      DelayedArray_0.28.0      \n[105] plotly_4.10.4             caTools_1.18.3           \n[107] scales_1.3.0              remaCor_0.0.18           \n[109] lmtest_0.9-40             digest_0.6.37            \n[111] goftest_1.2-3             spatstat.utils_3.1-1     \n[113] minqa_1.2.8               variancePartition_1.30.2 \n[115] rmarkdown_2.29            aod_1.3.3                \n[117] RhpcBLASctl_0.23-42       XVector_0.42.0           \n[119] htmltools_0.5.8.1         pkgconfig_2.0.3          \n[121] lme4_1.1-35.5             sparseMatrixStats_1.14.0 \n[123] fastmap_1.2.0             rlang_1.1.4              \n[125] GlobalOptions_0.1.2       htmlwidgets_1.6.4        \n[127] shiny_1.9.1               DelayedMatrixStats_1.24.0\n[129] farver_2.1.2              zoo_1.8-12               \n[131] jsonlite_1.8.9            BiocParallel_1.36.0      \n[133] R.oo_1.27.0               BiocSingular_1.18.0      \n[135] RCurl_1.98-1.16           magrittr_2.0.3           \n[137] modeltools_0.2-23         GenomeInfoDbData_1.2.11  \n[139] dotCall64_1.2             munsell_0.5.1            \n[141] viridis_0.6.5             babelgene_22.9           \n[143] reticulate_1.35.0         stringi_1.8.4            \n[145] zlibbioc_1.48.2           MASS_7.3-60.0.1          \n[147] flexmix_2.3-19            plyr_1.8.9               \n[149] parallel_4.3.2            listenv_0.9.1            \n[151] ggrepel_0.9.6             deldir_2.0-4             \n[153] splines_4.3.2             tensor_1.5               \n[155] hms_1.1.3                 locfit_1.5-9.10          \n[157] igraph_2.1.1              spatstat.geom_3.2-8      \n[159] RcppHNSW_0.6.0            ScaledMatrix_1.10.0      \n[161] reshape2_1.4.4            evaluate_1.0.1           \n[163] BiocManager_1.30.25       nloptr_2.0.3             \n[165] tzdb_0.4.0                foreach_1.5.2            \n[167] httpuv_1.6.15             RANN_2.6.2               \n[169] polyclip_1.10-7           future_1.34.0            \n[171] clue_0.3-66               scattermore_1.2          \n[173] rsvd_1.0.5                broom_1.0.7              \n[175] xtable_1.8-4              RSpectra_0.16-2          \n[177] later_1.3.2               viridisLite_0.4.2        \n[179] lmerTest_3.1-3            glmmTMB_1.1.10           \n[181] beeswarm_0.4.0            cluster_2.1.6            \n[183] timechange_0.3.0          globals_0.16.3",
    "crumbs": [
      "<span class='chapter-number'>9</span>  <span class='chapter-title'>Tumor: Deep phenotyping, cluster annotation, and exploration of tumor cells</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part10.html",
    "href": "Tumor_scRNA_Part10.html",
    "title": "10  Tumor: Plot TCR reconstruction data and T cell expression characteristics of vaccine-reactive TILs",
    "section": "",
    "text": "10.1 Set up Seurat workspace\n# Load libraries\nlibrary(Seurat)\nlibrary(tidyverse)\nlibrary(circlize)\nlibrary(ComplexHeatmap)\nlibrary(paletteer)\nlibrary(viridis)\nlibrary(readxl)\nlibrary(patchwork)\nlibrary(muscat)\nlibrary(scater)",
    "crumbs": [
      "<span class='chapter-number'>10</span>  <span class='chapter-title'>Tumor: Plot TCR reconstruction data and T cell expression characteristics of vaccine-reactive TILs</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part10.html#read-in-clustered-seurat-object",
    "href": "Tumor_scRNA_Part10.html#read-in-clustered-seurat-object",
    "title": "10  Tumor: Plot TCR reconstruction data and T cell expression characteristics of vaccine-reactive TILs",
    "section": "10.2 Read in clustered Seurat object",
    "text": "10.2 Read in clustered Seurat object\n\nmerged.18279.tumor.singlets &lt;- readRDS(\"Tumor_scRNA_Part8.rds\")",
    "crumbs": [
      "<span class='chapter-number'>10</span>  <span class='chapter-title'>Tumor: Plot TCR reconstruction data and T cell expression characteristics of vaccine-reactive TILs</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part10.html#import-and-re-format-t-cell-reactivity-groupings",
    "href": "Tumor_scRNA_Part10.html#import-and-re-format-t-cell-reactivity-groupings",
    "title": "10  Tumor: Plot TCR reconstruction data and T cell expression characteristics of vaccine-reactive TILs",
    "section": "10.3 Import and re-format T cell reactivity groupings",
    "text": "10.3 Import and re-format T cell reactivity groupings\n\n10.3.1 Open the scTCR barcodes in each category: Existing, Post-Nivo, Post-Vax, Reactive\n\np101_tils &lt;- read.csv(\"sctcr_scRep_vjaa_p101_til_freq_barcodes_category_reactivity.csv\")\np103_tils &lt;- read.csv(\"sctcr_scRep_vjaa_p103_til_freq_barcodes_category_reactivity.csv\")\np104_tils &lt;- read.csv(\"sctcr_scRep_vjaa_p104_til_freq_barcodes_category_reactivity.csv\")\np108_tils &lt;- read.csv(\"sctcr_scRep_vjaa_p108_til_freq_barcodes_category_reactivity.csv\")\n\n\n\n10.3.2 Reformat dataframes so that each scTCR barcode has its own row and filter for Post-Nivo and Post-Vax TCRs\n\np101_pnpv &lt;- as_tibble(p101_tils) %&gt;% \n    dplyr::filter(sctcr_category %in% c(\"Post-Nivolumab\",\"Post-Vaccine\")) %&gt;%\n    mutate(Barcode = strsplit(as.character(barcodes), \",\")) %&gt;%\n    unnest(Barcode) %&gt;%\n    dplyr::select(-barcodes) %&gt;%\n    mutate(Barcode = str_replace(Barcode, \"-1\", \"\"))\np103_pnpv &lt;- as_tibble(p103_tils) %&gt;% \n    dplyr::filter(sctcr_category %in% c(\"Post-Nivolumab\",\"Post-Vaccine\")) %&gt;%\n    mutate(Barcode = strsplit(as.character(barcodes), \",\")) %&gt;%\n    unnest(Barcode) %&gt;%\n    dplyr::select(-barcodes) %&gt;%\n    mutate(Barcode = str_replace(Barcode, \"-1\", \"\"))\n\n\n\n10.3.3 Merge into one dataframe\n\ncombined_pnpv &lt;- bind_rows(p101_pnpv,p103_pnpv) %&gt;%\n    dplyr::select(vjaa,Barcode,sctcr_category) %&gt;%\n  dplyr::filter(Barcode %in% str_replace_all(colnames(merged.18279.tumor.singlets), \"_.{1,3}mgIpi_RNA\",\"\"))\n\ncombined_pnpv\n\n# A tibble: 4,495 × 3\n   vjaa                                    Barcode                sctcr_category\n   &lt;chr&gt;                                   &lt;chr&gt;                  &lt;chr&gt;         \n 1 TRAV1-2.TRAJ12;CALHMDSSYKLIF_NA;NA      P101_Tumor_W12_TTGGAA… Post-Nivolumab\n 2 TRAV13-1.TRAJ10;CAFLPGGGNKLTF_NA;NA     P101_Tumor_W12_ATCACG… Post-Nivolumab\n 3 TRAV13-1.TRAJ49;CAASNWNTGNQFYF_NA;NA    P101_Tumor_W12_CGGAGT… Post-Nivolumab\n 4 TRAV13-1.TRAJ6;CAAKGAGGSYIPTF_NA;NA     P101_Tumor_W12_CTGAAA… Post-Nivolumab\n 5 TRAV13-2.TRAJ39;CAENPFIAGNMLTF_NA;NA    P101_Tumor_W12_CGAGCC… Post-Nivolumab\n 6 TRAV17.TRAJ11;CATDAAGYSTLTF_NA;NA       P101_Tumor_W12_TACTTA… Post-Nivolumab\n 7 TRAV19.TRAJ26;CALSEERDNYGQNFVF_NA;NA    P101_Tumor_W12_CTCGTA… Post-Nivolumab\n 8 TRAV23DV6.TRAJ10;CAASILLTGGGNKLTF_NA;NA P101_Tumor_W12_AATCCA… Post-Nivolumab\n 9 TRAV26-1.TRAJ17;CIVKAAGNKLTF_NA;NA      P101_Tumor_W12_TATCTC… Post-Nivolumab\n10 TRAV29DV5.TRAJ33;CAASSDSNYQLIW_NA;NA    P101_Tumor_W12_AACGTT… Post-Nivolumab\n# ℹ 4,485 more rows\n\n\n\n\n10.3.4 Create pseudobulks by Patient and Timepoint, plot heatmap comparing Post-Nivo and Post-Vax clonotypes\n\ncells.pnpv &lt;- colnames(merged.18279.tumor.singlets)[str_replace_all(colnames(merged.18279.tumor.singlets), \"_.{1,3}mgIpi_RNA\",\"\") %in% combined_pnpv$Barcode]\nmerged.18279.tumor.singlets.pnpv &lt;- subset(merged.18279.tumor.singlets, \n                                           cells = cells.pnpv)\ntcr_cats_pnpv &lt;- combined_pnpv %&gt;% \n  dplyr::select(-vjaa) %&gt;% \n  deframe()\n\ntcr_cats_pnpv_ordered &lt;- tcr_cats_pnpv[str_replace_all(cells.pnpv, \"_.{1,3}mgIpi_RNA\",\"\")]\n\nmerged.18279.tumor.singlets.pnpv &lt;- AddMetaData(merged.18279.tumor.singlets.pnpv, as.character(tcr_cats_pnpv_ordered), col.name = \"TCRgroup\")\n\nmerged.18279.tumor.singlets.pnpv[['RNA']] &lt;- JoinLayers(merged.18279.tumor.singlets.pnpv[['RNA']])\nmerged.pnpv.sce &lt;- as.SingleCellExperiment(merged.18279.tumor.singlets.pnpv, assay=\"RNA\")\n\n(mergedCondition.pnpv.sce &lt;- prepSCE(merged.pnpv.sce,\n        kid = \"sub.cluster\",\n        gid = \"TCRgroup\",\n        sid = \"Patient\",\n        drop = TRUE))\n\nclass: SingleCellExperiment \ndim: 61217 4495 \nmetadata(1): experiment_info\nassays(2): counts logcounts\nrownames(61217): 5-8S-rRNA 5S-rRNA ... ZZEF1 ZZZ3\nrowData names(0):\ncolnames(4495): P101_Tumor_W12_2.5mgIpi_RNA_TCCACACCAACACCTA\n  P101_Tumor_W12_2.5mgIpi_RNA_AGCTCTCTCAGCCTAA ...\n  P103_Tumor_W20_2.5mgIpi_RNA_AGCGTCGGTCATATGC\n  P103_Tumor_W20_2.5mgIpi_RNA_AAGGCAGTCTAGAGTC\ncolData names(3): cluster_id sample_id group_id\nreducedDimNames(4): PCA UMAP.UNINTEGRATED INTEGRATED.HARMONY\n  UMAP.HARMONY\nmainExpName: RNA\naltExpNames(0):\n\npb &lt;- aggregateData(mergedCondition.pnpv.sce,\n    assay = \"counts\",\n    fun = \"mean\",\n    by = c(\"group_id\", \"sample_id\"))\n\n# Set up gene groupings for heatmap\nc1 &lt;- c(\"CD3E\",\"CD4\",\"CD8A\",\"CD8B\")\nc2 &lt;- c(\"CCR7\",\"TCF7\",\"SELL\",\"CD28\",\"CD27\",\"IL7R\",\"FAS\",\"LEF1\")\nc3 &lt;- c(\"NKG7\",\"CST7\",\"FASLG\",\"PRF1\",\"GZMA\",\"GZMB\",\"GZMH\",\"GZMK\",\"GZMM\",\"GNLY\",\"IL21\",\"IL2\",\"TNF\",\"IFNG\",\"CCL4\",\"CCL5\")\nc4 &lt;- c(\"CD38\",\"ENTPD1\",\"ITGAE\",\"CD69\",\"KLRG1\",\"CD40LG\",\"TNFRSF4\",\"TNFRSF9\",\"ICOS\",\"ITGAL\",\"ITGA1\",\"ITGB1\",\"CX3CR1\",\"CXCR6\",\"IL2RA\")\nc5 &lt;- c(\"PDCD1\",\"CTLA4\",\"TIGIT\",\"LAG3\",\"HAVCR2\",\"CD244\",\"CD160\",\"BTLA\",\"VTCN1\",\"TOX\")\nc6 &lt;- c(\"MKI67\",\"TBX1\",\"EOMES\",\"ZNF683\",\"ID2\",\"ID3\",\"PRDM1\",\"GATA3\",\"FOXP3\")\n\nheat.goi &lt;- list(\"T cell\" = c1, \n        \"Memory/Naive\" = c2,\n        \"Effector function\" = c3,\n        \"Phenotype\" = c4,\n        \"Inhibitory and exhaustion\" = c5,\n        \"Transcription factors\" = c6\n        ) %&gt;%\n        stack() %&gt;%\n        dplyr::rename(\"Gene\" = values,\"Category\" = ind) %&gt;%\n        as_tibble()\nheat.goi\n\n# A tibble: 62 × 2\n   Gene  Category    \n   &lt;chr&gt; &lt;fct&gt;       \n 1 CD3E  T cell      \n 2 CD4   T cell      \n 3 CD8A  T cell      \n 4 CD8B  T cell      \n 5 CCR7  Memory/Naive\n 6 TCF7  Memory/Naive\n 7 SELL  Memory/Naive\n 8 CD28  Memory/Naive\n 9 CD27  Memory/Naive\n10 IL7R  Memory/Naive\n# ℹ 52 more rows\n\npn.mat &lt;- assays(pb)[['Post-Nivolumab']][heat.goi$Gene,]\ncolnames(pn.mat) &lt;- paste0(colnames(pn.mat),\"_PostNivo\")\n\npv.mat &lt;- assays(pb)[['Post-Vaccine']][heat.goi$Gene,]\ncolnames(pv.mat) &lt;- paste0(colnames(pv.mat),\"_PostVax\")\n\nComplexHeatmap::Heatmap(cbind(pn.mat,pv.mat),\n              cluster_rows = F,\n              cluster_columns = F,\n              cluster_row_slices = F,\n              column_split = factor(c(\"P101\",\"P103\",\"P101\",\"P103\")),\n              column_order = c(\"P101_PostNivo\",\"P101_PostVax\",\"P103_PostNivo\",\"P103_PostVax\"),\n              row_split = factor(heat.goi$Category),\n              border = TRUE,\n              row_title_rot = 0,\n              row_title_side = \"left\",\n              row_names_side = \"right\",\n              col = circlize::colorRamp2(c(0,3),hcl_palette = \"viridis\"),\n              name = \"Expression\",\n              row_names_gp = gpar(fontsize=6,fontface=\"italic\"),\n              row_title_gp = gpar(fontsize=8,fontface=\"bold\")\n)\n\n\n\n\n\n\n\n\n\n\n10.3.5 Reformat dataframes so that each scTCR barcode has its own row and filter for reactive TCRs\n\np101_reactive &lt;- as_tibble(p101_tils) %&gt;% \n    dplyr::filter(reactive==TRUE) %&gt;%\n    mutate(Barcode = strsplit(as.character(barcodes), \",\")) %&gt;%\n    unnest(Barcode) %&gt;%\n    dplyr::select(-barcodes) %&gt;%\n    mutate(Barcode = str_replace(Barcode, \"-1\", \"\"))\np103_reactive &lt;- as_tibble(p103_tils) %&gt;% \n    dplyr::filter(reactive==TRUE) %&gt;%\n    mutate(Barcode = strsplit(as.character(barcodes), \",\")) %&gt;%\n    unnest(Barcode) %&gt;%\n    dplyr::select(-barcodes) %&gt;%\n    mutate(Barcode = str_replace(Barcode, \"-1\", \"\"))\np104_reactive &lt;- as_tibble(p104_tils) %&gt;% \n    dplyr::filter(reactive==TRUE) %&gt;%\n    mutate(Barcode = strsplit(as.character(barcodes), \",\")) %&gt;%\n    unnest(Barcode) %&gt;%\n    dplyr::select(-barcodes) %&gt;%\n    mutate(Barcode = str_replace(Barcode, \"-1\", \"\"))\np108_reactive &lt;- as_tibble(p108_tils) %&gt;% \n    dplyr::filter(reactive==TRUE) %&gt;%\n    mutate(Barcode = strsplit(as.character(barcodes), \",\")) %&gt;%\n    unnest(Barcode) %&gt;%\n    dplyr::select(-barcodes) %&gt;%\n    mutate(Barcode = str_replace(Barcode, \"-1\", \"\"))\n\n\n\n10.3.6 Merge into one dataframe\n\ncombined_reactive &lt;- bind_rows(p101_reactive,p103_reactive,p104_reactive,p108_reactive) %&gt;%\n    dplyr::select(vjaa,Barcode) %&gt;%\n  dplyr::filter(Barcode %in% str_replace_all(colnames(merged.18279.tumor.singlets), \"_.{1,3}mgIpi_RNA\",\"\"))\n\ncombined_reactive\n\n# A tibble: 15 × 2\n   vjaa                                                             Barcode     \n   &lt;chr&gt;                                                            &lt;chr&gt;       \n 1 TRAV21.TRAJ36;CAVRKQTGANNLFF_TRBV27.TRBJ2-1;CASSPTWGGSMVF        P101_Tumor_…\n 2 TRAV16.TRAJ28;CALGSYQLTF_TRBV5-1.TRBJ2-7;CASSLGQGSIFSSYEQYF      P101_Tumor_…\n 3 TRAV10.TRAJ27;CVVNTNAGKSTF_TRBV7-2.TRBJ2-1;CASSLGSGVAYNEQFF      P101_Tumor_…\n 4 TRAV27.TRAJ22;CAVDSGSARQLTF_TRBV20-1.TRBJ2-7;CSASEGAHEQYF        P103_Tumor_…\n 5 TRAV27.TRAJ22;CAVDSGSARQLTF_TRBV20-1.TRBJ2-7;CSASEGAHEQYF        P103_Tumor_…\n 6 TRAV27.TRAJ22;CAVDSGSARQLTF_TRBV20-1.TRBJ2-7;CSASEGAHEQYF        P103_Tumor_…\n 7 TRAV27.TRAJ22;CAVDSGSARQLTF_TRBV20-1.TRBJ2-7;CSASEGAHEQYF        P103_Tumor_…\n 8 TRAV27.TRAJ22;CAVDSGSARQLTF_TRBV20-1.TRBJ2-7;CSASEGAHEQYF        P103_Tumor_…\n 9 TRAV41.TRAJ22;CAVLLISSGSARQLTF_TRBV10-3.TRBJ2-2;CAIGPRKGGNTGELFF P104_Tumor_…\n10 TRAV26-1.TRAJ23;CIGVLYNQGGKLIF_TRBV5-1.TRBJ1-2;CASSLESGQEDYGYTF  P104_Tumor_…\n11 TRAV9-2.TRAJ58;CALIEETSGSRLTF_TRBV5-5.TRBJ1-2;CASSTWTDYGYTF      P104_Tumor_…\n12 TRAV8-6.TRAJ43;CAVRDNNNDMRF_TRBV6-1.TRBJ2-1;CASRVAGGPYEQFF       P104_Tumor_…\n13 TRAV1-1.TRAJ3;CAVPGGGSASKIIF_TRBV19.TRBJ2-5;CASSMGPGGAETQYF      P108_Tumor_…\n14 TRAV38-1.TRAJ31;CAFMKQRNNARLMF_TRBV6-6.TRBJ1-2;CASSYSTRDTNYGYTF  P108_Tumor_…\n15 TRAV12-2.TRAJ22;CAVVRSGSARQLTF_TRBV7-6.TRBJ2-1;CASSQGLRNEQFF     P108_Tumor_…",
    "crumbs": [
      "<span class='chapter-number'>10</span>  <span class='chapter-title'>Tumor: Plot TCR reconstruction data and T cell expression characteristics of vaccine-reactive TILs</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part10.html#import-data-with-numbered-tcrs",
    "href": "Tumor_scRNA_Part10.html#import-data-with-numbered-tcrs",
    "title": "10  Tumor: Plot TCR reconstruction data and T cell expression characteristics of vaccine-reactive TILs",
    "section": "10.4 Import data with numbered TCRs",
    "text": "10.4 Import data with numbered TCRs\n\nnumbered_tcrs_reformatted &lt;- read.csv(\"reformatted_reconstructed_TCR.csv\")\nnumbered_tcrs_original &lt;- read_xlsx(\"reconstructed_TCR.xlsx\")\n\n\n10.4.1 Check the order of the rows is the same then merge\n\ntable(numbered_tcrs_reformatted[,\"CDR3A_1\"] == numbered_tcrs_original[,\"CDR3A_1\"])\n\n\nTRUE \n  96 \n\n# Merge dataframes so we have the TCR# and the scTCR_TRBV1 column in the same file\nnumbered_tcrs &lt;- numbered_tcrs_original %&gt;%\n  cbind(scTCR_TRBV_1 = numbered_tcrs_reformatted$scTCR_TRBV_1)\n\n# Add vjaa column\nnumbered_tcrs &lt;- numbered_tcrs %&gt;%\n  mutate(vjaa = paste0(TRAV_1, \".\", TRAJ_1, \";\", CDR3A_1, \"_\", scTCR_TRBV_1, \".\", TRBJ_1, \";\", CDR3B_1)) %&gt;%\n  select(`TCR#`, vjaa)\n\n\ncombined_reactive_numbered &lt;- left_join(combined_reactive,numbered_tcrs,by=\"vjaa\") %&gt;%\n  mutate(TCRnum = paste0(\"TCR\",`TCR#`)) %&gt;%\n  dplyr::select(-`TCR#`)\n\ncombined_reactive_numbered\n\n# A tibble: 15 × 3\n   vjaa                                                           Barcode TCRnum\n   &lt;chr&gt;                                                          &lt;chr&gt;   &lt;chr&gt; \n 1 TRAV21.TRAJ36;CAVRKQTGANNLFF_TRBV27.TRBJ2-1;CASSPTWGGSMVF      P101_T… TCR17 \n 2 TRAV16.TRAJ28;CALGSYQLTF_TRBV5-1.TRBJ2-7;CASSLGQGSIFSSYEQYF    P101_T… TCR7  \n 3 TRAV10.TRAJ27;CVVNTNAGKSTF_TRBV7-2.TRBJ2-1;CASSLGSGVAYNEQFF    P101_T… TCR19 \n 4 TRAV27.TRAJ22;CAVDSGSARQLTF_TRBV20-1.TRBJ2-7;CSASEGAHEQYF      P103_T… TCR27 \n 5 TRAV27.TRAJ22;CAVDSGSARQLTF_TRBV20-1.TRBJ2-7;CSASEGAHEQYF      P103_T… TCR27 \n 6 TRAV27.TRAJ22;CAVDSGSARQLTF_TRBV20-1.TRBJ2-7;CSASEGAHEQYF      P103_T… TCR27 \n 7 TRAV27.TRAJ22;CAVDSGSARQLTF_TRBV20-1.TRBJ2-7;CSASEGAHEQYF      P103_T… TCR27 \n 8 TRAV27.TRAJ22;CAVDSGSARQLTF_TRBV20-1.TRBJ2-7;CSASEGAHEQYF      P103_T… TCR27 \n 9 TRAV41.TRAJ22;CAVLLISSGSARQLTF_TRBV10-3.TRBJ2-2;CAIGPRKGGNTGE… P104_T… TCR53 \n10 TRAV26-1.TRAJ23;CIGVLYNQGGKLIF_TRBV5-1.TRBJ1-2;CASSLESGQEDYGY… P104_T… TCR40 \n11 TRAV9-2.TRAJ58;CALIEETSGSRLTF_TRBV5-5.TRBJ1-2;CASSTWTDYGYTF    P104_T… TCR58 \n12 TRAV8-6.TRAJ43;CAVRDNNNDMRF_TRBV6-1.TRBJ2-1;CASRVAGGPYEQFF     P104_T… TCR43 \n13 TRAV1-1.TRAJ3;CAVPGGGSASKIIF_TRBV19.TRBJ2-5;CASSMGPGGAETQYF    P108_T… TCR88 \n14 TRAV38-1.TRAJ31;CAFMKQRNNARLMF_TRBV6-6.TRBJ1-2;CASSYSTRDTNYGY… P108_T… TCR87 \n15 TRAV12-2.TRAJ22;CAVVRSGSARQLTF_TRBV7-6.TRBJ2-1;CASSQGLRNEQFF   P108_T… TCR94",
    "crumbs": [
      "<span class='chapter-number'>10</span>  <span class='chapter-title'>Tumor: Plot TCR reconstruction data and T cell expression characteristics of vaccine-reactive TILs</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part10.html#plot-tcrs-ranked-by-post-vaccine-frequencies",
    "href": "Tumor_scRNA_Part10.html#plot-tcrs-ranked-by-post-vaccine-frequencies",
    "title": "10  Tumor: Plot TCR reconstruction data and T cell expression characteristics of vaccine-reactive TILs",
    "section": "10.5 Plot TCRs ranked by post-vaccine frequencies",
    "text": "10.5 Plot TCRs ranked by post-vaccine frequencies\nLabel with whether it was selected for reconstruction, and which of those were vaccine-reactive\n\n10.5.1 Import scTCR object\n\ncombined_TCR &lt;- readRDS(\"Skin_Tumor_scTCR.rds\")\n\n\n\n10.5.2 Rank TCRs by post-vaccine frequency\n\nreconstructed_tcr &lt;- numbered_tcrs_reformatted %&gt;%\n    mutate(TRAJ_1 = str_replace_all(TRAJ_1,\";\",\"\")) %&gt;%\n    mutate(vjaa = paste0(TRAV_1, \".\", TRAJ_1, \";\", CDR3A_1, \"_\", scTCR_TRBV_1, \".\", TRBJ_1, \";\", CDR3B_1)) %&gt;%\n    mutate(Patient = paste0(\"P\",Patient)) %&gt;%\n    dplyr::select(Patient,vjaa,Reactive) %&gt;% \n    distinct()\n    \npostvax_clonefreq_ranked &lt;- bind_rows(combined_TCR) %&gt;% \n    as_tibble() %&gt;%\n    dplyr::filter(Site == \"Tumor\") %&gt;%\n    dplyr::filter(Timepoint %in% c(\"W20\", \"PD\")) %&gt;%\n    mutate(Timepoint = str_replace_all(Timepoint, \"W20|PD\", \"Post-vaccine\")) %&gt;%\n    group_by(Patient,Timepoint,vjaa) %&gt;%\n    mutate(nDistinctClonesPerTimepoint = n()) %&gt;%\n    ungroup() %&gt;%\n    left_join(reconstructed_tcr, by=c(\"vjaa\",\"Patient\")) %&gt;%\n    dplyr::select(Patient,Timepoint,CTaa,vjaa,nDistinctClonesPerTimepoint,Reactive) %&gt;% \n    distinct() %&gt;% \n    mutate(Reconstructed = case_when(\n        is.na(Reactive) ~ \"No\",\n        !is.na(Reactive) ~ \"Yes\"\n        )\n    ) %&gt;%\n    mutate(ReactivityCategory = case_when(\n        Reactive == \"Yes\" ~ \"Reactive\",\n        Reactive == \"No\" ~ \"Not reactive\",\n        Reconstructed == \"No\" ~ \"Not tested\"\n        )\n    ) %&gt;%\n    group_by(Patient) %&gt;%\n    dplyr::arrange(Patient, -nDistinctClonesPerTimepoint) %&gt;%\n    mutate(Rank = row_number())\n\npostvax_clonefreq_ranked_list &lt;- postvax_clonefreq_ranked %&gt;%\n    group_by(Patient) %&gt;%\n    group_split()\n\nclone_lengths &lt;- unlist(lapply(postvax_clonefreq_ranked_list,nrow))\nclone_rel_lengths &lt;- clone_lengths/min(clone_lengths)\n\n\n\n10.5.3 Plot and assemble heatmap with annotations\n\np101 &lt;- ComplexHeatmap::Heatmap(as.factor(postvax_clonefreq_ranked_list[[1]]$Reconstructed),\n    cluster_rows = FALSE,\n    cluster_columns = FALSE,\n    border = TRUE,\n    name = \"Reconstructed\",\n    column_label = \"P101\\n\",\n    column_names_side = \"top\",\n    column_names_rot = 0,\n    column_names_centered = TRUE,\n    column_names_gp = gpar(fontface = \"bold\"),\n    row_title = \"Clones ranked by post-vaccine frequency\",\n    row_title_gp = gpar(fontsize = 9),\n    col = c(\"gray80\",\"blue\"),\n    left_annotation = rowAnnotation(NumClones = anno_barplot(postvax_clonefreq_ranked_list[[1]]$nDistinctClonesPerTimepoint, axis_param = list(direction = \"reverse\")),width = unit(2, \"cm\"), show_legend = FALSE),\n    right_annotation = rowAnnotation(Reactive = as.factor(postvax_clonefreq_ranked_list[[1]]$Reactive), \n            col = list(Reactive = c(\"No\" = \"white\", \"Yes\" = \"red\")),\n            na_col = \"white\",\n            border = TRUE, \n            show_legend = FALSE,\n            annotation_name_rot = 0\n        ),\n    width = unit(2, \"cm\"),\n    show_heatmap_legend = FALSE\n) %&gt;% \n  draw() %&gt;% \n  grid.grabExpr()\n\np103 &lt;- ComplexHeatmap::Heatmap(as.factor(postvax_clonefreq_ranked_list[[2]]$Reconstructed),\n    cluster_rows = FALSE,\n    cluster_columns = FALSE,\n    border = TRUE,\n    name = \"Reconstructed\",\n    column_label = \"P103\\n\",\n    column_names_side = \"top\",\n    column_names_rot = 0,\n    column_names_centered = TRUE,\n    column_names_gp = gpar(fontface = \"bold\"),\n    col = c(\"gray80\",\"blue\"),\n    left_annotation = rowAnnotation(NumClones = anno_barplot(postvax_clonefreq_ranked_list[[2]]$nDistinctClonesPerTimepoint, axis_param = list(direction = \"reverse\")),width = unit(2, \"cm\"), show_legend = FALSE),\n    right_annotation = rowAnnotation(Reactive = as.factor(postvax_clonefreq_ranked_list[[2]]$Reactive), \n            col = list(Reactive = c(\"No\" = \"white\", \"Yes\" = \"red\")),\n            na_col = \"white\",\n            border = TRUE, \n            show_legend = FALSE,\n            annotation_name_rot = 0\n        ),\n    width = unit(2, \"cm\"),\n    show_heatmap_legend = FALSE\n) %&gt;% \n  draw() %&gt;% \n  grid.grabExpr()\n\np104 &lt;- ComplexHeatmap::Heatmap(as.factor(postvax_clonefreq_ranked_list[[3]]$Reconstructed),\n    cluster_rows = FALSE,\n    cluster_columns = FALSE,\n    border = TRUE,\n    name = \"Reconstructed\",\n    column_label = \"P104\\n\",\n    column_names_side = \"top\",\n    column_names_rot = 0,\n    column_names_centered = TRUE,\n    column_names_gp = gpar(fontface = \"bold\"),\n    col = c(\"gray80\",\"blue\"),\n    left_annotation = rowAnnotation(NumClones = anno_barplot(postvax_clonefreq_ranked_list[[3]]$nDistinctClonesPerTimepoint, axis_param = list(direction = \"reverse\")),width = unit(2, \"cm\"), show_legend = FALSE),\n    right_annotation = rowAnnotation(Reactive = as.factor(postvax_clonefreq_ranked_list[[3]]$Reactive), \n            col = list(Reactive = c(\"No\" = \"white\", \"Yes\" = \"red\")),\n            na_col = \"white\",\n            border = TRUE, \n            show_legend = FALSE,\n            annotation_name_rot = 0\n        ),\n    width = unit(2, \"cm\"),\n    show_heatmap_legend = FALSE\n) %&gt;% \n  draw() %&gt;% \n  grid.grabExpr()\n\np108 &lt;- ComplexHeatmap::Heatmap(as.factor(postvax_clonefreq_ranked_list[[4]]$Reconstructed),\n    cluster_rows = FALSE,\n    cluster_columns = FALSE,\n    border = TRUE,\n    name = \"Reconstructed\",\n    column_label = \"P108\\n\",\n    column_names_side = \"top\",\n    column_names_rot = 0,\n    column_names_centered = TRUE,\n    column_names_gp = gpar(fontface = \"bold\"),\n    col = c(\"gray80\",\"blue\"),\n    left_annotation = rowAnnotation(NumClones = anno_barplot(postvax_clonefreq_ranked_list[[4]]$nDistinctClonesPerTimepoint, axis_param = list(direction = \"reverse\")),width = unit(2, \"cm\")),\n    right_annotation = rowAnnotation(Reactive = as.factor(postvax_clonefreq_ranked_list[[4]]$Reactive), \n            col = list(Reactive = c(\"No\" = \"white\", \"Yes\" = \"red\")),\n            na_col = \"white\",\n            border = TRUE,\n            annotation_name_rot = 0\n        ),\n    width = unit(2, \"cm\")\n) %&gt;% \n  draw() %&gt;% \n  grid.grabExpr()\n\nwrap_plots(p101, p103, p104, p108, ncol = 4)",
    "crumbs": [
      "<span class='chapter-number'>10</span>  <span class='chapter-title'>Tumor: Plot TCR reconstruction data and T cell expression characteristics of vaccine-reactive TILs</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part10.html#plot-tils-with-reactive-tcrs-as-heatmap",
    "href": "Tumor_scRNA_Part10.html#plot-tils-with-reactive-tcrs-as-heatmap",
    "title": "10  Tumor: Plot TCR reconstruction data and T cell expression characteristics of vaccine-reactive TILs",
    "section": "10.6 Plot TILs with reactive TCRs as heatmap",
    "text": "10.6 Plot TILs with reactive TCRs as heatmap\n\n10.6.1 Set up gene groupings for TIL heatmap\n\nc1 &lt;- c(\"CD3E\",\"CD4\",\"CD8A\",\"CD8B\")\nc2 &lt;- c(\"CCR7\",\"TCF7\",\"SELL\",\"CD28\",\"CD27\",\"IL7R\",\"FAS\",\"LEF1\")\nc3 &lt;- c(\"NKG7\",\"CST7\",\"FASLG\",\"PRF1\",\"GZMA\",\"GZMB\",\"GZMH\",\"GZMK\",\"GZMM\",\"GNLY\",\"IL21\",\"IL2\",\"TNF\",\"IFNG\",\"CCL4\",\"CCL5\")\nc4 &lt;- c(\"CD38\",\"ENTPD1\",\"ITGAE\",\"CD69\",\"KLRG1\",\"CD40LG\",\"TNFRSF4\",\"TNFRSF9\",\"ICOS\",\"ITGAL\",\"ITGA1\",\"ITGB1\",\"CX3CR1\",\"CXCR6\",\"IL2RA\")\nc5 &lt;- c(\"PDCD1\",\"CTLA4\",\"TIGIT\",\"LAG3\",\"HAVCR2\",\"CD244\",\"CD160\",\"BTLA\",\"VTCN1\",\"TOX\")\nc6 &lt;- c(\"MKI67\",\"TBX1\",\"EOMES\",\"ZNF683\",\"ID2\",\"ID3\",\"PRDM1\",\"GATA3\",\"FOXP3\")\n\nheat.goi &lt;- list(\"T cell\" = c1, \n        \"Memory/Naive\" = c2,\n        \"Effector function\" = c3,\n        \"Phenotype\" = c4,\n        \"Inhibitory and exhaustion\" = c5,\n        \"Transcription factors\" = c6\n        ) %&gt;%\n        stack() %&gt;%\n        dplyr::rename(\"Gene\" = values,\"Category\" = ind) %&gt;%\n        as_tibble()\nheat.goi\n\n# A tibble: 62 × 2\n   Gene  Category    \n   &lt;chr&gt; &lt;fct&gt;       \n 1 CD3E  T cell      \n 2 CD4   T cell      \n 3 CD8A  T cell      \n 4 CD8B  T cell      \n 5 CCR7  Memory/Naive\n 6 TCF7  Memory/Naive\n 7 SELL  Memory/Naive\n 8 CD28  Memory/Naive\n 9 CD27  Memory/Naive\n10 IL7R  Memory/Naive\n# ℹ 52 more rows\n\n\n\n\n10.6.2 Add reactive TCR data as metadata label to Seurat object\n\nreac.meta &lt;- ifelse(str_replace_all(colnames(merged.18279.tumor.singlets), \"_.{1,3}mgIpi_RNA\",\"\") %in% combined_reactive_numbered$Barcode,\"Reactive\",\"Other\")\nmerged.18279.tumor.singlets &lt;- AddMetaData(merged.18279.tumor.singlets, reac.meta, col.name=\"ReactiveTCR\")\n\n\n\n10.6.3 Add subcluster annotations as metadata label to Seurat object\n\ncluster_annot &lt;- c(\n        \"8\" = \"Macrophage\",\n        \"15\" = \"MonoMac\",\n        \"28\" = \"pDC\",\n        \"17\" = \"B_cells\",\n        \"13\" = \"Plasma_cells\",\n        \"2_1\" = \"CD8_TPEX\",\n        \"1_0\" = \"CD8_TEX\",\n        \"1_1\" = \"CD8_T_EM_1\",\n        \"2_0\" = \"CD8_T_EM_2\",\n        \"22_1\" = \"CD8_T_EM_3\",\n        \"22_2\" = \"CD8_T_EM_4\",\n        \"26_0\" = \"CD8_T_proliferating\",\n        \"3_0\" = \"CD4_T_Memory_1\",\n        \"22_0\" = \"CD4_T_Memory_2\",\n        \"3_1\" = \"CD4_T_CTL_1\",\n        \"12_0\" = \"CD4_T_CTL_2\",\n        \"12_1\" = \"CD4_Tfh\",\n        \"16_0\" = \"Treg\",\n        \"9_0\" = \"T_unknown_1\",\n        \"9_1\" = \"T_unknown_2\",\n        \"18_0\" = \"NK/T_1\",\n        \"18_1\" = \"NK/T_2\",\n        \"29\" = \"Mast\",\n        \"0\" = \"Melanoma_1\",\n        \"4\" = \"Melanoma_2\",\n        \"5\" = \"Melanoma_3\",\n        \"6\" = \"Melanoma_4\",\n        \"11\" = \"Melanoma_5\",\n        \"23\" = \"Melanoma_6\",\n        \"25\" = \"Melanoma_7\",\n        \"14\" = \"Melanoma_proliferating\",\n        \"21\" = \"Melanocytes\",\n        \"7\" = \"Endothelial_1\",\n        \"27\" = \"Endothelial_2\",\n        \"10\" = \"Fibroblasts_1\",\n        \"20\" = \"Fibroblasts_2\",\n        \"19\" = \"Pericytes/SmoothMuscle\",\n        \"24\" = \"Basal\"\n)\nclustLabels &lt;- as.data.frame(cluster_annot)[merged.18279.tumor.singlets$sub.cluster,]\nmerged.18279.tumor.singlets &lt;- AddMetaData(merged.18279.tumor.singlets, list(clustLabels), col.name = \"CellAnnotation\")\n\nmerged.18279.tumor.singlets$CellAnnotation &lt;- factor(x = merged.18279.tumor.singlets$CellAnnotation, \n                                                    levels = as.character(cluster_annot))\n\n\n# Set up broader cell classes\ncluster_classes &lt;- enframe(cluster_annot,name = \"sub.cluster\",value = \"CellAnnotation\") %&gt;%\n  as_tibble() %&gt;%\n  mutate(CellClass = case_when(\n    sub.cluster %in% c(\"8\",\"15\") ~ \"Monocyte/\\nMacrophage\",\n    sub.cluster %in% c(\"28\") ~ \"DC\",\n    sub.cluster %in% c(\"17\",\"13\") ~ \"B\",\n    sub.cluster %in% c(\"1_0\",\"1_1\",\"2_0\",\"2_1\",\"22_1\",\"22_2\",\"26_0\",\"3_0\",\"3_1\",\"12_0\",\"12_1\",\"22_0\",\"16_0\",\"9_0\",\"9_1\",\"18_0\",\"18_1\") ~ \"NK/T\",\n    sub.cluster %in% c(\"29\") ~ \"Mast\",\n    sub.cluster %in% c(\"0\",\"4\",\"5\",\"6\",\"11\",\"23\",\"25\",\"14\") ~ \"Melanoma\",\n    sub.cluster %in% c(\"21\",\"7\",\"27\",\"10\",\"20\",\"19\",\"24\") ~ \"Non-immune\"\n    )\n  ) %&gt;%\n  dplyr::select(-CellAnnotation) %&gt;%\n  column_to_rownames(var = \"sub.cluster\") %&gt;%\n  as.data.frame()\n\nclustClasses &lt;- cluster_classes[merged.18279.tumor.singlets$sub.cluster,]\nmerged.18279.tumor.singlets &lt;- AddMetaData(merged.18279.tumor.singlets, list(clustClasses), col.name = \"CellClass\")\n\n\n\n10.6.4 Subset Seurat object to NK/T clusters\n\nmerged.18279.tumor.singlets.t &lt;- subset(merged.18279.tumor.singlets, subset = CellClass == \"NK/T\")\n\n\n\n10.6.5 Make metadata table of reactive TILs for heatmap annotations\n\nmeta.df &lt;- merged.18279.tumor.singlets.t@meta.data[,c(\"Patient\",\"Timepoint\",\"sub.cluster\",\"CellAnnotation\",\"CellClass\",\"functional.cluster\",\"ReactiveTCR\")]\n\nmeta.reac.df &lt;- meta.df[meta.df$ReactiveTCR==\"Reactive\",]\n\nmeta.reac &lt;- full_join(\n  rownames_to_column(meta.reac.df,var=\"Barcode\") %&gt;% \n    mutate(Barcode2 = str_replace_all(Barcode, \"_.{1,3}mgIpi_RNA\",\"\")), \n  combined_reactive_numbered, \n  by=c(\"Barcode2\" = \"Barcode\")\n  ) %&gt;%\n  dplyr::select(-Barcode2) %&gt;%\n  column_to_rownames(var=\"Barcode\") %&gt;%\n  as.data.frame()\n\nrownames_to_column(meta.reac,var=\"Barcode\")\n\n                                        Barcode Patient Timepoint sub.cluster\n1  P101_Tumor_W20_2.5mgIpi_RNA_GCGACCACAGACAGGT    P101       W20        12_1\n2  P101_Tumor_W20_2.5mgIpi_RNA_AAACCTGCACCGAAAG    P101       W20         3_0\n3  P101_Tumor_W20_2.5mgIpi_RNA_TGGCGCAAGTGTGGCA    P101       W20        22_0\n4  P103_Tumor_W20_2.5mgIpi_RNA_CTAGTGAAGACGACGT    P103       W20         2_1\n5  P103_Tumor_W20_2.5mgIpi_RNA_TTATGCTCATCATCCC    P103       W20         2_0\n6  P103_Tumor_W20_2.5mgIpi_RNA_ATTGGACGTGTGTGCC    P103       W20         2_0\n7  P103_Tumor_W20_2.5mgIpi_RNA_CATCGGGCAGCATACT    P103       W20         2_0\n8  P103_Tumor_W20_2.5mgIpi_RNA_CTGCGGAAGTAGCGGT    P103       W20         1_0\n9   P104_Tumor_PD_2.5mgIpi_RNA_TCGCGAGCAATGTAAG    P104        PD         3_0\n10  P104_Tumor_PD_2.5mgIpi_RNA_CATATTCGTCCTCCAT    P104        PD        12_1\n11  P104_Tumor_PD_2.5mgIpi_RNA_GATCGTAAGCGACGTA    P104        PD        12_1\n12  P104_Tumor_PD_2.5mgIpi_RNA_ACACCGGAGCCGCCTA    P104        PD         3_0\n13    P108_Tumor_PD_5mgIpi_RNA_ACGGGTCCATAGAAAC    P108        PD         3_0\n14    P108_Tumor_PD_5mgIpi_RNA_TTTGCGCAGCTAGCCC    P108        PD         1_0\n15    P108_Tumor_PD_5mgIpi_RNA_ACTTGTTCAGTCAGAG    P108        PD         3_0\n   CellAnnotation CellClass functional.cluster ReactiveTCR\n1         CD4_Tfh      NK/T            CD4.Tfh    Reactive\n2  CD4_T_Memory_1      NK/T      CD4.CTL_EOMES    Reactive\n3  CD4_T_Memory_2      NK/T         CD4.Memory    Reactive\n4        CD8_TPEX      NK/T           CD8.TPEX    Reactive\n5      CD8_T_EM_2      NK/T           CD8.TPEX    Reactive\n6      CD8_T_EM_2      NK/T           CD8.TPEX    Reactive\n7      CD8_T_EM_2      NK/T           CD8.TPEX    Reactive\n8         CD8_TEX      NK/T            CD8.TEX    Reactive\n9  CD4_T_Memory_1      NK/T            CD4.Tfh    Reactive\n10        CD4_Tfh      NK/T            CD4.Tfh    Reactive\n11        CD4_Tfh      NK/T            CD4.Tfh    Reactive\n12 CD4_T_Memory_1      NK/T            CD4.Tfh    Reactive\n13 CD4_T_Memory_1      NK/T         CD4.Memory    Reactive\n14        CD8_TEX      NK/T      CD4.CTL_EOMES    Reactive\n15 CD4_T_Memory_1      NK/T         CD4.Memory    Reactive\n                                                               vjaa TCRnum\n1       TRAV16.TRAJ28;CALGSYQLTF_TRBV5-1.TRBJ2-7;CASSLGQGSIFSSYEQYF   TCR7\n2         TRAV21.TRAJ36;CAVRKQTGANNLFF_TRBV27.TRBJ2-1;CASSPTWGGSMVF  TCR17\n3       TRAV10.TRAJ27;CVVNTNAGKSTF_TRBV7-2.TRBJ2-1;CASSLGSGVAYNEQFF  TCR19\n4         TRAV27.TRAJ22;CAVDSGSARQLTF_TRBV20-1.TRBJ2-7;CSASEGAHEQYF  TCR27\n5         TRAV27.TRAJ22;CAVDSGSARQLTF_TRBV20-1.TRBJ2-7;CSASEGAHEQYF  TCR27\n6         TRAV27.TRAJ22;CAVDSGSARQLTF_TRBV20-1.TRBJ2-7;CSASEGAHEQYF  TCR27\n7         TRAV27.TRAJ22;CAVDSGSARQLTF_TRBV20-1.TRBJ2-7;CSASEGAHEQYF  TCR27\n8         TRAV27.TRAJ22;CAVDSGSARQLTF_TRBV20-1.TRBJ2-7;CSASEGAHEQYF  TCR27\n9   TRAV26-1.TRAJ23;CIGVLYNQGGKLIF_TRBV5-1.TRBJ1-2;CASSLESGQEDYGYTF  TCR40\n10       TRAV8-6.TRAJ43;CAVRDNNNDMRF_TRBV6-1.TRBJ2-1;CASRVAGGPYEQFF  TCR43\n11 TRAV41.TRAJ22;CAVLLISSGSARQLTF_TRBV10-3.TRBJ2-2;CAIGPRKGGNTGELFF  TCR53\n12      TRAV9-2.TRAJ58;CALIEETSGSRLTF_TRBV5-5.TRBJ1-2;CASSTWTDYGYTF  TCR58\n13     TRAV12-2.TRAJ22;CAVVRSGSARQLTF_TRBV7-6.TRBJ2-1;CASSQGLRNEQFF  TCR94\n14  TRAV38-1.TRAJ31;CAFMKQRNNARLMF_TRBV6-6.TRBJ1-2;CASSYSTRDTNYGYTF  TCR87\n15      TRAV1-1.TRAJ3;CAVPGGGSASKIIF_TRBV19.TRBJ2-5;CASSMGPGGAETQYF  TCR88\n\n\n\n\n10.6.6 Set up color coding vectors for heatmap annotations\n\npatient_cols &lt;- c(\"P101\" = \"#59A14FFF\",\n                  \"P103\" = \"#B07AA1FF\",\n                  \"P104\" = \"#76B7B2FF\", \n                  \"P108\" = \"#F6AAC9FF\")\n\nprojectils_cols &lt;- data.frame(cbind(\n  c(levels(factor(merged.18279.tumor.singlets$functional.cluster)),\"Unknown/Other\"), \n  c(paletteer::paletteer_d(\"RColorBrewer::Blues\")[-c(1:2)], \n    \"#232061FF\", \n    paletteer::paletteer_d(\"RColorBrewer::Reds\")[-c(1:2)],\n    \"#CECECEFF\")\n  )\n  ) %&gt;% \n  deframe()\n\n\n\n10.6.7 Subset data matrices to just the genes for plotting, and only reactive TILs\n\nrna.reactive &lt;- as.matrix(merged.18279.tumor.singlets.t@assays$RNA$data[heat.goi$Gene,rownames(meta.reac)])\n\n\n\n10.6.8 Set column ordering\n\nreactive.order &lt;- rownames_to_column(meta.reac,var=\"Cell\") %&gt;% \n    as_tibble() %&gt;% \n  mutate(Patient = factor(Patient, c(\"P101\",\"P104\",\"P108\",\"P103\"))) %&gt;%\n  dplyr::arrange(Patient) %&gt;%\n    pull(Cell)\n\n\n\n10.6.9 Set up heatmap annotations\n\nha1 &lt;- HeatmapAnnotation(Patient = as.factor(meta.reac$Patient),\n                         col = list(Patient = patient_cols[as.factor(meta.reac$Patient)]), border = T)\n\nha2 &lt;- HeatmapAnnotation(CellState = as.factor(meta.reac$functional.cluster),\n                         col = list(CellState = projectils_cols[meta.reac$functional.cluster]), border = T)\n\nha3 &lt;- HeatmapAnnotation(TCR = anno_text(meta.reac$TCRnum,\n                                         gp = gpar(fontsize=6),\n                                         just = \"left\",\n                                         location = 0))\n\n\n\n10.6.10 Capture heatmap in plotted order and print TCR info\n\nh0 &lt;- ComplexHeatmap::Heatmap(rna.reactive,\n    cluster_rows = F,\n    cluster_columns = F,\n    cluster_row_slices = F,\n    row_split = factor(heat.goi$Category),\n    column_split = factor(meta.reac$functional.cluster),\n    column_order = reactive.order,\n    top_annotation = c(ha3,ha1,ha2),\n    border = TRUE,\n  row_names_gp = gpar(fontsize=6,fontface=\"italic\"),\n  row_title_gp = gpar(fontsize=8,fontface=\"bold\"),\n  column_title_gp = gpar(fontsize=8,fontface=\"bold\"),\n    show_column_names = F,\n    row_title_rot = 0,\n    row_title_side = \"left\",\n    row_names_side = \"right\",\n    col = circlize::colorRamp2(c(0,2), c(\"gray90\", \"red\")),\n    name = \"Expression\",\n    column_title = \"Individual TILs with Reactive TCR\",\n    use_raster = F,\n    width = unit(6, \"cm\")\n    )\nht &lt;- draw(h0)\n\n\n\n\n\n\n\ncol_order &lt;- column_order(ht)\nheatmap_barcodes_ordered &lt;- colnames(rna.reactive)[as.numeric(unlist(col_order))]\n\n\n\npng \n  2",
    "crumbs": [
      "<span class='chapter-number'>10</span>  <span class='chapter-title'>Tumor: Plot TCR reconstruction data and T cell expression characteristics of vaccine-reactive TILs</span>"
    ]
  },
  {
    "objectID": "Tumor_scRNA_Part10.html#get-session-info",
    "href": "Tumor_scRNA_Part10.html#get-session-info",
    "title": "10  Tumor: Plot TCR reconstruction data and T cell expression characteristics of vaccine-reactive TILs",
    "section": "10.7 Get session info",
    "text": "10.7 Get session info\n\nsessionInfo()\n\nR version 4.3.2 (2023-10-31)\nPlatform: x86_64-pc-linux-gnu (64-bit)\nRunning under: Rocky Linux 8.10 (Green Obsidian)\n\nMatrix products: default\nBLAS/LAPACK: /usr/lib64/libopenblasp-r0.3.15.so;  LAPACK version 3.9.0\n\nlocale:\n [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              \n [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    \n [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   \n [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 \n [9] LC_ADDRESS=C               LC_TELEPHONE=C            \n[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       \n\ntime zone: America/New_York\ntzcode source: system (glibc)\n\nattached base packages:\n[1] stats4    grid      stats     graphics  grDevices utils     datasets \n[8] methods   base     \n\nother attached packages:\n [1] scater_1.34.0               scuttle_1.12.0             \n [3] SingleCellExperiment_1.24.0 SummarizedExperiment_1.32.0\n [5] Biobase_2.62.0              GenomicRanges_1.54.1       \n [7] GenomeInfoDb_1.38.8         IRanges_2.36.0             \n [9] S4Vectors_0.40.2            BiocGenerics_0.48.1        \n[11] MatrixGenerics_1.14.0       matrixStats_1.5.0          \n[13] muscat_1.14.0               patchwork_1.3.0            \n[15] readxl_1.4.5                viridis_0.6.5              \n[17] viridisLite_0.4.2           paletteer_1.6.0            \n[19] ComplexHeatmap_2.18.0       circlize_0.4.16            \n[21] lubridate_1.9.4             forcats_1.0.0              \n[23] stringr_1.5.1               dplyr_1.1.4                \n[25] purrr_1.0.4                 readr_2.1.5                \n[27] tidyr_1.3.1                 tibble_3.2.1               \n[29] ggplot2_3.5.1               tidyverse_2.0.0            \n[31] Seurat_5.1.0                SeuratObject_5.0.2         \n[33] sp_2.2-0                   \n\nloaded via a namespace (and not attached):\n  [1] spatstat.sparse_3.1-0     bitops_1.0-9             \n  [3] httr_1.4.7                RColorBrewer_1.1-3       \n  [5] doParallel_1.0.17         numDeriv_2016.8-1.1      \n  [7] backports_1.5.0           tools_4.3.2              \n  [9] sctransform_0.4.1         utf8_1.2.4               \n [11] R6_2.6.1                  lazyeval_0.2.2           \n [13] uwot_0.2.3                mgcv_1.9-3               \n [15] GetoptLong_1.0.5          withr_3.0.2              \n [17] prettyunits_1.2.0         gridExtra_2.3            \n [19] SeuratWrappers_0.3.19     progressr_0.15.1         \n [21] cli_3.6.4                 Cairo_1.6-2              \n [23] spatstat.explore_3.2-6    fastDummies_1.7.3        \n [25] sandwich_3.1-1            prismatic_1.1.2          \n [27] mvtnorm_1.3-3             spatstat.data_3.1-6      \n [29] blme_1.0-5                ggridges_0.5.6           \n [31] pbapply_1.7-2             R.utils_2.13.0           \n [33] parallelly_1.43.0         limma_3.58.1             \n [35] generics_0.1.3            shape_1.4.6.1            \n [37] gtools_3.9.5              ica_1.0-3                \n [39] spatstat.random_3.2-2     Matrix_1.6-4             \n [41] ggbeeswarm_0.7.2          abind_1.4-8              \n [43] R.methodsS3_1.8.2         lifecycle_1.0.4          \n [45] multcomp_1.4-28           yaml_2.3.10              \n [47] edgeR_4.0.16              gplots_3.2.0             \n [49] SparseArray_1.2.2         Rtsne_0.17               \n [51] promises_1.3.2            crayon_1.5.3             \n [53] miniUI_0.1.1.1            lattice_0.22-7           \n [55] beachmat_2.18.1           cowplot_1.1.3            \n [57] magick_2.8.6              pillar_1.10.1            \n [59] knitr_1.45                rjson_0.2.23             \n [61] boot_1.3-31               estimability_1.5.1       \n [63] future.apply_1.11.3       codetools_0.2-20         \n [65] leiden_0.4.3.1            glue_1.8.0               \n [67] remotes_2.5.0             data.table_1.17.0        \n [69] vctrs_0.6.5               png_0.1-8                \n [71] spam_2.11-1               Rdpack_2.6.3             \n [73] cellranger_1.1.0          gtable_0.3.6             \n [75] rematch2_2.1.2            xfun_0.52                \n [77] rbibutils_2.3             S4Arrays_1.2.0           \n [79] mime_0.13                 coda_0.19-4.1            \n [81] reformulas_0.4.0          survival_3.8-3           \n [83] iterators_1.0.14          statmod_1.5.0            \n [85] fitdistrplus_1.2-2        TH.data_1.1-3            \n [87] ROCR_1.0-11               nlme_3.1-168             \n [89] pbkrtest_0.5.3            EnvStats_2.8.1           \n [91] progress_1.2.3            RcppAnnoy_0.0.22         \n [93] TMB_1.9.17                irlba_2.3.5.1            \n [95] vipor_0.4.7               KernSmooth_2.23-26       \n [97] colorspace_2.1-1          nnet_7.3-20              \n [99] DESeq2_1.42.1             tidyselect_1.2.1         \n[101] emmeans_1.11.0            compiler_4.3.2           \n[103] BiocNeighbors_1.20.2      DelayedArray_0.28.0      \n[105] plotly_4.10.4             caTools_1.18.3           \n[107] scales_1.3.0              remaCor_0.0.18           \n[109] lmtest_0.9-40             digest_0.6.37            \n[111] goftest_1.2-3             spatstat.utils_3.1-3     \n[113] minqa_1.2.8               variancePartition_1.30.2 \n[115] rmarkdown_2.29            aod_1.3.3                \n[117] RhpcBLASctl_0.23-42       XVector_0.42.0           \n[119] htmltools_0.5.8.1         pkgconfig_2.0.3          \n[121] lme4_1.1-37               sparseMatrixStats_1.14.0 \n[123] fastmap_1.2.0             rlang_1.1.5              \n[125] GlobalOptions_0.1.2       htmlwidgets_1.6.4        \n[127] shiny_1.10.0              DelayedMatrixStats_1.24.0\n[129] farver_2.1.2              zoo_1.8-13               \n[131] jsonlite_2.0.0            BiocParallel_1.36.0      \n[133] R.oo_1.27.0               BiocSingular_1.18.0      \n[135] RCurl_1.98-1.17           magrittr_2.0.3           \n[137] modeltools_0.2-23         GenomeInfoDbData_1.2.11  \n[139] dotCall64_1.2             munsell_0.5.1            \n[141] Rcpp_1.0.14               reticulate_1.35.0        \n[143] stringi_1.8.7             zlibbioc_1.48.2          \n[145] MASS_7.3-60.0.1           flexmix_2.3-20           \n[147] plyr_1.8.9                parallel_4.3.2           \n[149] listenv_0.9.1             ggrepel_0.9.6            \n[151] deldir_2.0-4              splines_4.3.2            \n[153] tensor_1.5                hms_1.1.3                \n[155] locfit_1.5-9.12           igraph_2.1.4             \n[157] spatstat.geom_3.2-8       RcppHNSW_0.6.0           \n[159] reshape2_1.4.4            ScaledMatrix_1.10.0      \n[161] evaluate_1.0.3            BiocManager_1.30.25      \n[163] nloptr_2.0.3              tzdb_0.5.0               \n[165] foreach_1.5.2             httpuv_1.6.15            \n[167] RANN_2.6.2                polyclip_1.10-7          \n[169] future_1.34.0             clue_0.3-66              \n[171] scattermore_1.2           rsvd_1.0.5               \n[173] broom_1.0.8               xtable_1.8-4             \n[175] RSpectra_0.16-2           later_1.4.1              \n[177] lmerTest_3.1-3            glmmTMB_1.1.10           \n[179] beeswarm_0.4.0            cluster_2.1.8.1          \n[181] timechange_0.3.0          globals_0.16.3",
    "crumbs": [
      "<span class='chapter-number'>10</span>  <span class='chapter-title'>Tumor: Plot TCR reconstruction data and T cell expression characteristics of vaccine-reactive TILs</span>"
    ]
  }
]